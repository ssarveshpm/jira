<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRV JIRA Board</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%231c65e3' d='M64 64c0-17.7-14.3-32-32-32S0 46.3 0 64L0 400c0 44.2 35.8 80 80 80l400 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 416c-8.8 0-16-7.2-16-16L64 64zm406.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L320 210.7 262.6 153.4c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l73.4-73.4 57.4 57.4c12.5 12.5 32.8 12.5 45.3 0l128-128z'/%3E%3C/svg%3E">
    <script>
        // JIRA Apps Script URL - Update this when you deploy a new version
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiJK4zZmzp7qGE1OzwF7cBeZrebPPwIZqKwJFWOLHAB2P6QwYk3upUHXZdiJmaXwZDGg/exec';
        const JIRA_BASE_URL = 'https://cardyai-hawaii.atlassian.net/browse/';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Atlassian Sans", ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }


        .container {
            width: 100%;
            margin: 0;
            background: white;
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }

        .container.login-mode {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            position: relative;
        }

        .login-svg-section {
            position: absolute;
            left: 0;
            top: 0;
            width: 60%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }

        .container:not(.login-mode) .login-svg-section {
            display: none;
        }

        .login-svg-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .login-svg-content svg {
            max-width: 100%;
            max-height: 100%;
            opacity: 0.8;
        }

        .header {
            background: white;
            color: #333;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls-wrapper {
            width: 100%;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .container.login-mode .controls-wrapper {
            width: 40%;
            min-width: 400px;
            background: white;
            margin-right: 0;
            margin-left: auto;
            position: relative;
            z-index: 10;
            border-bottom: none;
        }

        .controls {
            padding: 20px 30px;
            background: white;
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 15px;
            align-items: end;
            max-width: 35%;
            transition: all 0.3s ease;
        }

        .container.login-mode .controls {
            grid-template-columns: 1fr;
            max-width: 100%;
            gap: 20px;
            padding: 40px;
        }

        /* Hide email and password inputs after data is loaded */
        .input-group.email-group,
        .input-group.password-group {
            display: none;
        }

        .container.login-mode .input-group.email-group,
        .container.login-mode .input-group.password-group {
            display: flex;
        }

        /* Adjust controls layout when email/password are hidden */
        .container:not(.login-mode) .controls {
            grid-template-columns: 1fr auto;
        }

        .container.login-mode .fetch-time-container {
            display: none;
        }

        .container.login-mode .tickets-container {
            display: none;
        }

        .container.login-mode .error {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 500px;
            width: calc(100% - 40px);
            z-index: 1000;
        }

        .container.login-mode .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .fetch-time-container {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 11px;
            color: #888;
            font-style: italic;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }

        .text-input {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .text-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .select-input {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .select-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .action-btn {
            background: #1868DB;
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            white-space: nowrap;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 104, 219, 0.4);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            color: #666;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1868DB;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            display: none;
            background: #fee;
            color: #c33;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            border-left: 4px solid #c33;
        }

        .error.active {
            display: block;
        }

        .tickets-container {
            padding: 30px;
            overflow-x: auto;
        }

        .ticket-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ticket-key {
            font-size: 1.2em;
            font-weight: 600;
            color: #1868DB;
        }

        .ticket-status {
            font-weight: 600;
            color: #444;
        }

        .ticket-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .ticket-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #666;
        }

        .ticket-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: #666;
        }



        .tickets-table {
            width: 100%;
            min-width: 1100px;
            border-collapse: collapse;
        }

        .tickets-table th,
        .tickets-table td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
            font-size: 14px;
        }

        .tickets-table th {
            background: rgba(24, 104, 219, 0.12);
            font-weight: 700;
            color: #444;
            white-space: nowrap;
        }

        .tickets-table tbody tr:hover {
            background: rgba(24, 104, 219, 0.06);
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sorted {
            background: rgba(24, 104, 219, 0.12);
            color: #1868DB;
        }

        .sort-indicator {
            margin-left: 6px;
            font-size: 11px;
            color: #888;
        }

        .filter-actions {
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
        }

        .clear-btn {
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }

        .clear-btn:hover {
            background: rgba(24, 104, 219, 0.08);
            border-color: #1868DB;
            color: #444;
        }

        .clear-btn.active {
            background: #1868DB;
            color: white;
            border-color: #1868DB;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .dash-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dash-grid {
                grid-template-columns: 1fr;
            }
        }

        .dash-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .dash-card.wide {
            grid-column: span 2;
        }

        .dash-card h3 {
            margin-bottom: 4px;
            color: #444;
        }

        .widget-subtitle {
            font-size: 11px;
            color: #888;
            margin-bottom: 12px;
            font-weight: normal;
            display: block;
        }

        .dash-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .dash-list li {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .dash-list li.clickable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .dash-list li.clickable:hover {
            background: rgba(24, 104, 219, 0.06);
            padding-left: 4px;
            padding-right: 4px;
            margin-left: -4px;
            margin-right: -4px;
        }

        .dash-list li span:last-child {
            text-align: right;
        }

        .dash-list li:last-child {
            border-bottom: none;
        }

        .dash-section {
            margin-bottom: 20px;
        }

        .dash-section:last-child {
            margin-bottom: 0;
        }

        .date-picker-container {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-picker-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .date-picker-input {
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .date-picker-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .time-tracking-widget {
            grid-column: 1 / -1;
        }

        .worklog-detail-widget {
            grid-column: 1 / -1;
        }

        .worklog-input-container {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .worklog-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
        }

        .worklog-select {
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fff;
        }

        .worklog-select:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .worklog-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .worklog-detail-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .worklog-detail-item:last-child {
            border-bottom: none;
        }

        .worklog-detail-time {
            font-weight: 600;
            color: #1868DB;
            white-space: nowrap;
            min-width: 80px;
        }

        /* Collapsible AC Status Widget & Sub-task Status Widget */
        #acStatusWidget.collapsed .dash-list,
        #subTaskStatusWidget.collapsed .dash-list {
            display: none;
        }

        .toggle-icon {
            cursor: pointer;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        /* Sub task report specific */
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table td {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .report-table tr:last-child td {
            border-bottom: none;
        }

        .report-assignee {
            width: 120px;
            font-size: 13px;
            color: #444;
            padding-right: 12px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .report-bar-cell {
            padding-right: 10px !important;
        }

        .stacked-bar {
            display: flex;
            height: 18px;
            border-radius: 4px;
            overflow: hidden;
            background: #f0f0f0;
            width: 100%;
        }

        .bar-segment {
            height: 100%;
            transition: opacity 0.2s;
        }

        .bar-segment:hover {
            opacity: 0.8;
        }

        .seg-todo {
            background-color: #9e9e9e;
        }

        .seg-inprogress {
            background-color: #ff9800;
        }

        .seg-blocked {
            background-color: #f44336;
        }

        .seg-review {
            background-color: #ffeb3b;
        }

        .seg-closed {
            background-color: #388e3c;
        }

        /* AC Progress segment colors */
        .seg-dev {
            background-color: #ff9800;
        }

        .seg-qa {
            background-color: #ffeb3b;
        }

        .seg-ba {
            background-color: #9c27b0;
        }

        .seg-done {
            background-color: #388e3c;
        }

        .seg-other {
            background-color: #9e9e9e;
        }

        .report-total {
            width: 100px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .toggle-btn {
            background: #1868DB !important;
            border-radius: 50% !important;
            width: 24px !important;
            height: 24px !important;
            padding: 0 !important;
        }

        .toggle-btn svg {
            fill: #ffffff !important;
            width: 20px !important;
            height: 20px !important;
        }

        .toggle-btn:hover {
            background: #1557b5 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .worklog-detail-key {
            font-weight: 600;
            color: #1868DB;
            white-space: nowrap;
            min-width: 100px;
            margin-right: 15px;
        }

        .worklog-detail-key a {
            color: #1868DB;
            text-decoration: none;
            cursor: pointer;
            transition: text-decoration 0.2s;
        }

        .worklog-detail-key a:hover {
            text-decoration: underline;
        }

        .worklog-detail-date {
            color: #666;
            white-space: nowrap;
            min-width: 100px;
            margin-right: 15px;
            font-size: 14px;
        }

        .worklog-detail-description {
            flex: 1;
            color: #444;
            word-wrap: break-word;
        }

        .time-low-hours {
            color: #d32f2f;
            font-weight: 600;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #1868DB;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-switch input:focus+.toggle-slider {
            box-shadow: 0 0 1px #1868DB;
        }

        .dash-section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 15px;
            color: #444;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
        }

        .dash-section-title .section-count {
            text-align: right;
            font-weight: 700;
        }

        .multi-dd {
            position: relative;
            min-width: 180px;
        }

        .multi-dd-btn {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            background: #fff;
            color: #444;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
        }

        .multi-dd-btn:focus {
            outline: none;
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .multi-dd .caret {
            float: right;
            color: #888;
        }

        .multi-dd-options {
            position: absolute;
            z-index: 10;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            max-height: 220px;
            overflow: auto;
            padding: 8px 10px;
            display: none;
            pointer-events: auto;
        }

        .multi-dd-options.open {
            display: block;
        }

        .multi-dd-options label {
            display: block;
            font-size: 13px;
            color: #444;
            margin: 4px 0;
            cursor: pointer;
        }

        .multi-dd-options .dd-clear {
            margin-top: 8px;
            width: 100%;
            padding: 6px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .qa-col {
            min-width: 90px;
            white-space: nowrap;
        }

        .serial-col {
            width: 60px;
            text-align: center;
            white-space: nowrap;
        }

        .time-diff-positive {
            color: #d32f2f;
            font-weight: 600;
        }

        .time-diff-negative {
            color: #2e7d32;
            font-weight: 600;
        }

        .due-date-overdue {
            color: #d32f2f;
            font-weight: 600;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .widget-header h3 {
            margin-bottom: 0;
        }

        .snapshot-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .snapshot-icon svg {
            width: 18px;
            height: 18px;
            fill: #666;
            transition: fill 0.2s;
        }

        .snapshot-icon:hover {
            background: rgba(24, 104, 219, 0.1);
        }

        .snapshot-icon:hover svg {
            fill: #1868DB;
        }

        /* Pie Chart Styles */
        .pie-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            position: relative;
        }

        .pie-chart-svg {
            width: 200px;
            height: 200px;
            transform: rotate(-90deg);
            border-radius: 50%;
        }

        .pie-slice {
            transition: opacity 0.2s, transform 0.2s;
            cursor: pointer;
            stroke: #fff;
            stroke-width: 0.02;
        }

        .pie-slice:hover {
            opacity: 0.8;
            transform: scale(1.02);
            transform-origin: center;
        }

        .pie-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .pie-center-count {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #333;
            line-height: 1;
        }

        .pie-center-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
            width: 100%;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #555;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Subtask Grouping Styles */
        .subtask-group {
            margin-bottom: 24px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }

        .group-header {
            background: #f8f9fa;
            padding: 12px 16px;
            margin: 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .group-key {
            font-family: monospace;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .group-key:hover {
            background: #1976d2;
            color: white;
            text-decoration: none;
        }

        .ticket-link {
            color: #1868DB;
            text-decoration: none;
            font-weight: 600;
        }

        .ticket-link:hover {
            text-decoration: underline;
        }

        .group-summary {
            font-weight: 500;
            color: #333;
        }

        .subtask-table {
            margin: 0 !important;
            border: none !important;
            width: 100%;
        }

        .subtask-table th {
            background: #fff !important;
            font-size: 0.85em;
            border-bottom: 2px solid #eee;
        }

        /* Toggle & Header Styles */
        .group-header.clickable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .group-header.clickable:hover {
            background: #eef2f6;
        }

        .caret-icon {
            display: inline-block;
            font-size: 10px;
            margin-right: 4px;
            transition: transform 0.2s;
            color: #666;
        }

        .caret-icon.open {
            transform: rotate(90deg);
        }

        .subtask-badge {
            margin-left: auto;
            font-size: 0.8em;
            color: #888;
            font-weight: normal;
        }

        .post-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-results-header h3 {
            margin: 0;
        }

        .expand-collapse-controls {
            font-size: 0.9em;
        }

        .text-btn {
            background: none;
            border: none;
            color: #1868DB;
            cursor: pointer;
            padding: 4px 8px;
            font-size: inherit;
        }

        .text-btn:hover {
            text-decoration: underline;
        }

        .separator {
            color: #ccc;
            margin: 0 4px;
        }


        .snapshot-icon:active {
            background: rgba(24, 104, 219, 0.2);
        }

        /* Dev View Styling */
        .clickable {
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <div class="container login-mode">
        <div class="login-svg-section">
            <div class="login-svg-content">
                <svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                    <!-- Background grid pattern -->
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1868DB" stroke-width="0.5"
                                opacity="0.08" />
                        </pattern>
                    </defs>
                    <rect width="800" height="600" fill="url(#grid)" />

                    <!-- Rotated Bar Chart Card (Top Left) -->
                    <g transform="translate(50, 40) rotate(-5)">
                        <rect x="0" y="0" width="180" height="140" fill="white" stroke="#1868DB" stroke-width="2"
                            opacity="0.25" rx="8" />
                        <text x="10" y="20" font-family="Arial, sans-serif" font-size="11" font-weight="600"
                            fill="#1868DB" opacity="0.5">Weekly Stats</text>
                        <rect x="20" y="50" width="20" height="60" fill="#1868DB" opacity="0.4" rx="2" />
                        <rect x="50" y="40" width="20" height="70" fill="#1868DB" opacity="0.5" rx="2" />
                        <rect x="80" y="30" width="20" height="80" fill="#1868DB" opacity="0.6" rx="2" />
                        <rect x="110" y="45" width="20" height="65" fill="#1868DB" opacity="0.45" rx="2" />
                        <rect x="140" y="35" width="20" height="75" fill="#1868DB" opacity="0.55" rx="2" />
                    </g>

                    <!-- Line Chart Card (Top Right, rotated) -->
                    <g transform="translate(550, 60) rotate(8)">
                        <rect x="0" y="0" width="200" height="120" fill="white" stroke="#1868DB" stroke-width="2"
                            opacity="0.25" rx="8" />
                        <text x="10" y="20" font-family="Arial, sans-serif" font-size="11" font-weight="600"
                            fill="#1868DB" opacity="0.5">Trend Analysis</text>
                        <polyline points="15,100 40,80 65,60 90,70 115,50 140,45 165,40 180,35" fill="none"
                            stroke="#1868DB" stroke-width="3" opacity="0.5" stroke-linecap="round" />
                        <circle cx="15" cy="100" r="3" fill="#1868DB" opacity="0.6" />
                        <circle cx="90" cy="70" r="3" fill="#1868DB" opacity="0.6" />
                        <circle cx="165" cy="40" r="3" fill="#1868DB" opacity="0.6" />
                    </g>

                    <!-- Pie Chart Card (Middle Left, rotated) -->
                    <g transform="translate(80, 220) rotate(-12)">
                        <rect x="0" y="0" width="160" height="160" fill="white" stroke="#1868DB" stroke-width="2"
                            opacity="0.25" rx="8" />
                        <text x="10" y="20" font-family="Arial, sans-serif" font-size="11" font-weight="600"
                            fill="#1868DB" opacity="0.5">Distribution</text>
                        <circle cx="80" cy="100" r="50" fill="none" stroke="#1868DB" stroke-width="2" opacity="0.3" />
                        <path d="M 80 50 L 80 100 A 50 50 0 0 1 120 100 Z" fill="#1868DB" opacity="0.4" />
                        <path d="M 80 100 L 120 100 A 50 50 0 0 1 100 150 Z" fill="#1868DB" opacity="0.5" />
                        <path d="M 80 100 L 100 150 A 50 50 0 0 1 40 120 Z" fill="#1868DB" opacity="0.6" />
                    </g>

                    <!-- Stat Cards (Middle Right, scattered) -->
                    <g transform="translate(480, 200)">
                        <rect x="0" y="0" width="120" height="90" fill="#1868DB" opacity="0.12" rx="6" />
                        <text x="10" y="18" font-family="Arial, sans-serif" font-size="10" fill="#1868DB"
                            opacity="0.5">Total Issues</text>
                        <text x="10" y="50" font-family="Arial, sans-serif" font-size="24" font-weight="700"
                            fill="#1868DB" opacity="0.7">142</text>
                        <text x="10" y="70" font-family="Arial, sans-serif" font-size="9" fill="#1868DB"
                            opacity="0.4">+12% this week</text>
                    </g>

                    <g transform="translate(620, 280) rotate(5)">
                        <rect x="0" y="0" width="120" height="90" fill="#1868DB" opacity="0.12" rx="6" />
                        <text x="10" y="18" font-family="Arial, sans-serif" font-size="10" fill="#1868DB"
                            opacity="0.5">Completed</text>
                        <text x="10" y="50" font-family="Arial, sans-serif" font-size="24" font-weight="700"
                            fill="#1868DB" opacity="0.7">89</text>
                        <text x="10" y="70" font-family="Arial, sans-serif" font-size="9" fill="#1868DB"
                            opacity="0.4">+8% this week</text>
                    </g>

                    <!-- Horizontal Bar Chart (Bottom Left, rotated) -->
                    <g transform="translate(120, 420) rotate(10)">
                        <rect x="0" y="0" width="220" height="130" fill="white" stroke="#1868DB" stroke-width="2"
                            opacity="0.25" rx="8" />
                        <text x="10" y="20" font-family="Arial, sans-serif" font-size="11" font-weight="600"
                            fill="#1868DB" opacity="0.5">Progress Overview</text>
                        <rect x="20" y="40" width="150" height="12" fill="#1868DB" opacity="0.4" rx="6" />
                        <rect x="20" y="60" width="120" height="12" fill="#1868DB" opacity="0.5" rx="6" />
                        <rect x="20" y="80" width="180" height="12" fill="#1868DB" opacity="0.6" rx="6" />
                        <rect x="20" y="100" width="90" height="12" fill="#1868DB" opacity="0.45" rx="6" />
                    </g>

                    <!-- Area Chart (Bottom Right, rotated) -->
                    <g transform="translate(500, 380) rotate(-8)">
                        <rect x="0" y="0" width="240" height="150" fill="white" stroke="#1868DB" stroke-width="2"
                            opacity="0.25" rx="8" />
                        <text x="10" y="20" font-family="Arial, sans-serif" font-size="11" font-weight="600"
                            fill="#1868DB" opacity="0.5">Performance</text>
                        <polyline points="20,130 50,110 80,90 110,100 140,80 170,70 200,65 220,60" fill="#1868DB"
                            fill-opacity="0.15" stroke="#1868DB" stroke-width="2" opacity="0.5"
                            stroke-linecap="round" />
                        <polyline points="20,130 50,110 80,90 110,100 140,80 170,70 200,65 220,60 L 220 130 L 20 130 Z"
                            fill="#1868DB" fill-opacity="0.1" />
                    </g>

                    <!-- Small Stat Card (Center, rotated) -->
                    <g transform="translate(350, 250) rotate(-15)">
                        <rect x="0" y="0" width="100" height="80" fill="#1868DB" opacity="0.12" rx="6" />
                        <text x="10" y="18" font-family="Arial, sans-serif" font-size="10" fill="#1868DB"
                            opacity="0.5">In Progress</text>
                        <text x="10" y="50" font-family="Arial, sans-serif" font-size="22" font-weight="700"
                            fill="#1868DB" opacity="0.7">53</text>
                    </g>

                    <!-- Decorative elements -->
                    <circle cx="700" cy="100" r="35" fill="#1868DB" opacity="0.08" />
                    <circle cx="100" cy="500" r="30" fill="#1868DB" opacity="0.08" />
                    <circle cx="650" cy="500" r="25" fill="#1868DB" opacity="0.08" />
                </svg>
            </div>
        </div>
        <div class="controls-wrapper">
            <form class="controls" autocomplete="on" onsubmit="handleSubmit(event)">
                <div class="input-group email-group">
                    <label class="input-label" for="emailInput">Username</label>
                    <input class="text-input" id="emailInput" name="email" type="text" autocomplete="username"
                        placeholder="username or email" value="sarvesh.s">
                </div>
                <div class="input-group password-group">
                    <label class="input-label" for="tokenInput">Password</label>
                    <input class="text-input" id="tokenInput" name="password" type="password"
                        autocomplete="current-password" placeholder="Enter your password">
                </div>
                <div class="input-group">
                    <label class="input-label" for="moduleSelect">Module</label>
                    <select class="select-input" id="moduleSelect" onchange="switchModule(this.value)">
                        <!-- Options will be populated dynamically from modules configuration -->
                    </select>
                </div>
                <button class="action-btn" type="submit" id="updateBtn">Fetch</button>
            </form>
        </div>
        <div class="fetch-time-container">
            <span id="lastFetchTime"></span>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <div class="error" id="error"></div>

        <div class="tickets-container" id="ticketsContainer">
            <div class="empty-state">
                <h2>Data has not been loaded yet.</h2>
                <p>Enter your username and password and click Fetch to continue.</p>
            </div>
        </div>
    </div>

    <script>
        // Add a timestamp to avoid caching issues

        function updateStatus(message) {
            // Status display removed
        }

        // Module configuration - Add new modules here by providing module ID, display name, and EM ID
        const modules = {
            licensing: {
                name: 'Sprint 4 - Licensing',
                emId: 'EM-896',
                sprintId: '1129'
            },
            assessments: {
                name: 'Sprint 4 - Assessments',
                emId: 'EM-1460',
                sprintId: '1128'
            },
            testmodule: {
                name: 'Testmodule',
                emId: 'EM-5860',
                sprintId: ''
            },
            licensing2: {
                name: 'Sprint 3 - Licensing',
                emId: 'EM-896',
                sprintId: '925'
            },
            assessments1: {
                name: 'Sprint 3 - Assessments',
                emId: 'EM-1460',
                sprintId: '923'
            },
            // To add a new module, uncomment and modify:
            // newModule: {
            //     name: 'New Module',
            //     emId: 'EM-XXXX'
            // }
        };

        let activeModule = 'licensing'; // Default module
        let viewMode = 'dashboard'; // 'table' | 'dashboard' | 'fr' | 'worklog' | 'sprintplan' | 'dev'
        let lastTickets = [];
        let frDataCache = [];
        let lastDevSubtasks = []; // Store fetched subtasks
        let lastDevBugsDetailed = []; // Store detailed bug information (assignee, dueDate)
        let devAssigneeFilters = []; // Store selected assignees for Dev View
        let devTypeFilter = ['Story', 'Sub Task', 'Bug']; // Store selected ticket types for Dev View
        let devStatusFilters = []; // Store selected statuses for Dev View
        let devWeekFilter = null; // Store selected weeks for Dev View
        let sortField = null;
        let sortDir = 'asc';
        let openDropdown = null;
        let hasDataBeenLoaded = false; // Track if data has been loaded at least once
        let savedEmail = '';
        let savedApiToken = '';
        let isFetchingDevData = false; // Track if dev data is currently being fetched
        let isFetchingSprintData = false; // Track if sprint details are currently being fetched
        let lastSprintDetails = null; // Store fetched sprint details
        let isACStatusExpanded = false; // Persistent state for AC Status widget expansion
        let isSubTaskStatusExpanded = false; // Persistent state for Sub-task Status widget expansion

        // Initialize module dropdown on page load
        function initializeModuleDropdown() {
            const moduleSelect = document.getElementById('moduleSelect');
            if (!moduleSelect) return;

            // Clear existing options
            moduleSelect.innerHTML = '';

            // Populate dropdown from modules configuration
            Object.entries(modules).forEach(([id, module]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = module.name;
                if (id === activeModule) {
                    option.selected = true;
                }
                moduleSelect.appendChild(option);
            });
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeModuleDropdown);
        } else {
            initializeModuleDropdown();
        }

        const columns = [
            { id: 'serial', label: '#', sortable: null, className: 'serial-col' },
            { id: 'key', label: 'Key', sortable: 'key' },
            { id: 'summary', label: 'Summary', sortable: 'summary' },
            { id: 'status', label: 'Status', sortable: 'status' },
            { id: 'assignee', label: 'Assignee', sortable: 'assignee' },
            { id: 'priority', label: 'Priority', sortable: 'priority' },
            { id: 'storyPoints', label: 'Story Points', sortable: 'storyPoints' },
            { id: 'dueDate', label: 'Due Date', sortable: 'dueDate' },
            { id: 'timeOriginalEstimate', label: 'Estimate', sortable: 'timeOriginalEstimate' },
            { id: 'actualHours', label: 'Time Spent', sortable: 'actualHours' },
            { id: 'timeDifference', label: 'Difference', sortable: 'timeDifference' },
            { id: 'created', label: 'Created', sortable: 'created' },
            { id: 'updated', label: 'Updated', sortable: 'updated' },
            { id: 'qaFailedCount', label: 'QA Loop', sortable: 'qaFailedCount', className: 'qa-col' },
            { id: 'totalBugs', label: 'Total Bugs', sortable: 'totalBugs', className: 'qa-col' },
            { id: 'openBugs', label: 'Open Bugs', sortable: 'openBugs', className: 'qa-col' },
            { id: 'subTaskCount', label: 'Sub Tasks', sortable: 'subTaskCount', className: 'qa-col' },
        ];

        // Single source of truth for default column visibility
        function getDefaultColumnVisibility() {
            return {
                serial: true,
                key: true,
                summary: false,
                status: true,
                assignee: true,
                priority: false,
                storyPoints: true,
                dueDate: true,
                timeOriginalEstimate: true,
                actualHours: true,
                timeDifference: true,
                created: false,
                updated: false,
                qaFailedCount: true,
                totalBugs: false,
                openBugs: true,
                subTaskCount: false
            };
        }

        const columnVisibility = getDefaultColumnVisibility();

        // Single source of truth for default filter values
        function getDefaultFilters() {
            return {
                key: '',
                summary: '',
                statusValues: [],
                assigneeValues: [],
                priorityValues: [],
                storyPoints: '',
                timeOriginalEstimate: '',
                actualHours: '',
                timeDifference: '',
                created: '',
                updated: '',
                qaFailedCount: '',
                dueDate: '',
                totalBugs: '',
                openBugs: '',
                subTaskCount: ''
            };
        }

        const filters = getDefaultFilters();

        function resetAllSelections() {
            // Reset filters to defaults
            Object.assign(filters, getDefaultFilters());

            // Reset column visibility to defaults
            Object.assign(columnVisibility, getDefaultColumnVisibility());

            // Reset sort settings
            sortField = null;
            sortDir = 'asc';

            // Reset view mode to dashboard (default)
            viewMode = 'dashboard';

            // Reset FR filters
            Object.assign(frFilters, getDefaultFRFilters());

            // Reset Dev View specific filters
            devAssigneeFilters = [];
            devTypeFilter = ['Story', 'Sub Task', 'Bug'];
            devStatusFilters = [];

            // Close any open dropdowns
            closeDropdowns();

            // Clear any filter input fields if they exist in the DOM
            const filterInputs = document.querySelectorAll('#ticketsContainer input[type="text"]');
            filterInputs.forEach(input => {
                if (input.placeholder && input.placeholder.toLowerCase().includes('search')) {
                    input.value = '';
                }
            });
        }

        function switchModule(moduleId) {
            // Validate module exists
            if (!modules[moduleId]) {
                console.error(`Module "${moduleId}" not found in configuration`);
                return;
            }

            activeModule = moduleId;

            // Update the select dropdown to reflect the current selection
            const moduleSelect = document.getElementById('moduleSelect');
            if (moduleSelect) {
                moduleSelect.value = moduleId;
            }

            // Reset all user selections to defaults
            resetAllSelections();

            // Hide fetch time when switching modules
            const fetchTimeEl = document.getElementById('lastFetchTime');
            if (fetchTimeEl) {
                fetchTimeEl.textContent = '';
            }

            hideError();
            showLoading(false);
            updateStatus('Enter username, password, then click Update');
            updateDashboardButton();
            const container = document.getElementById('ticketsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <h2>Data has not been loaded yet.</h2>
                    <p>Click Fetch to continue.</p>
                </div>
            `;
            lastTickets = [];

            // Only restore login mode if data has never been loaded (initial state)
            // Don't restore login mode when switching modules after data has been loaded
            const mainContainer = document.querySelector('.container');
            if (mainContainer && !hasDataBeenLoaded) {
                mainContainer.classList.add('login-mode');
            }
        }

        function setFilter(field, value, evt) {
            if (evt) {
                evt.stopPropagation();
            }
            filters[field] = value.toLowerCase();
            updateTableBody(lastTickets);
        }

        function setFilterMulti(field, selectEl, evt) {
            if (evt) {
                evt.stopPropagation();
            }
            const values = Array.from(selectEl.selectedOptions || []).map(o => o.value.toLowerCase());
            filters[field] = values;
            updateTableBody(lastTickets);
        }

        function toggleDropdown(field, evt) {
            if (evt) evt.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (!dropdown) return;
            closeDropdowns(field);
            const willOpen = !dropdown.classList.contains('open');
            if (willOpen) {
                dropdown.classList.add('open');
                openDropdown = field;
            } else {
                dropdown.classList.remove('open');
                openDropdown = null;
            }
        }

        function closeDropdowns(exceptField) {
            document.querySelectorAll('.multi-dd-options').forEach(el => {
                if (exceptField && el.id === `dropdown-${exceptField}`) return;
                el.classList.remove('open');
            });
            if (!exceptField) openDropdown = null;
        }

        document.addEventListener('click', (evt) => {
            // Only close dropdowns if click is outside any dropdown
            const clickedElement = evt.target;
            const isInsideDropdown = clickedElement.closest('.multi-dd');
            if (!isInsideDropdown) {
                closeDropdowns();
            }
        });

        function toggleMultiOption(field, value, checked, evt) {
            if (evt) evt.stopPropagation();
            const key = `${field}Values`;
            const arr = filters[key] || [];
            const norm = value.toLowerCase();
            const exists = arr.includes(norm);
            if (checked && !exists) {
                arr.push(norm);
                filters[key] = arr;
            } else if (!checked && exists) {
                filters[key] = arr.filter(v => v !== norm);
            }

            // Update table body without re-rendering (which would close the dropdown)
            updateTableBody(lastTickets);

            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${dropdownLabel(field)} <span class="caret"></span>`;
            }
        }

        function clearMultiFilter(field, evt) {
            if (evt) evt.stopPropagation();
            filters[`${field}Values`] = [];

            // Update table body without re-rendering (which would close the dropdown)
            updateTableBody(lastTickets);

            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${dropdownLabel(field)} <span class="caret"></span>`;
            }

            // Uncheck all checkboxes in the dropdown
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (dropdown) {
                const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        }

        function dropdownLabel(field) {
            const arr = filters[`${field}Values`] || [];
            if (arr.length === 0) return 'All';
            if (arr.length === 1) return arr[0];
            return `${arr.length} selected`;
        }

        function columnsDropdownLabel() {
            const visibleCount = Object.values(columnVisibility).filter(Boolean).length;
            const total = columns.length;
            return visibleCount === total ? 'Columns (All)' : `Columns (${visibleCount}/${total})`;
        }

        function updateTableHeaderAndBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderTickets(tickets);
                return;
            }

            // Save dropdown state
            const wasOpen = openDropdown === 'columns';
            const dropdown = document.getElementById('dropdown-columns');

            const visibleColumns = columns.filter(c => columnVisibility[c.id]);

            // Update header row
            const thead = table.querySelector('thead');
            if (thead) {
                const headerRow = thead.querySelector('tr:first-child');
                if (headerRow) {
                    const headerCells = visibleColumns.map(col => {
                        const sortableAttrs = col.sortable
                            ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setSort('${col.id}')"`
                            : `${col.className ? `class="${col.className}"` : ''}`;
                        const indicator = col.sortable ? `<span class="sort-indicator">${sortIndicator(col.id)}</span>` : '';
                        return `
                            <th ${sortableAttrs}>
                                ${col.label} ${indicator}
                            </th>
                        `;
                    }).join('');
                    headerRow.innerHTML = headerCells;
                }

                // Update filter row
                const filterRow = thead.querySelector('tr:last-child');
                if (filterRow) {
                    const statusOptions = getUniqueValues(tickets, 'status');
                    const assigneeOptions = getUniqueValues(tickets, 'assignee');
                    const priorityOptions = getUniqueValues(tickets, 'priority');

                    const optionHtml = (opts, selected, field) => opts.map(opt => {
                        const isSel = selected.includes(opt.toLowerCase());
                        const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        return `
                            <label>
                                <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleMultiOption('${field}', '${safe}', this.checked, event)">
                                ${safe}
                            </label>
                        `;
                    }).join('');

                    const filterCells = visibleColumns.map(col => {
                        if (col.id === 'serial') {
                            return `<th class="serial-col">#</th>`;
                        }
                        if (col.id === 'key') {
                            return `<th><input type="text" placeholder="Search key" oninput="setFilter('key', this.value, event)" onclick="event.stopPropagation();" value="${filters.key || ''}"></th>`;
                        }
                        if (col.id === 'summary') {
                            return `<th><input type="text" placeholder="Search summary" oninput="setFilter('summary', this.value, event)" onclick="event.stopPropagation();" value="${filters.summary || ''}"></th>`;
                        }
                        if (col.id === 'status') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-status" type="button" onclick="toggleDropdown('status', event)">
                                            ${dropdownLabel('status')} <span class="caret"></span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-status">
                                            ${optionHtml(statusOptions, filters.statusValues, 'status')}
                                            <button class="dd-clear" type="button" onclick="clearMultiFilter('status', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        if (col.id === 'assignee') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-assignee" type="button" onclick="toggleDropdown('assignee', event)">
                                            ${dropdownLabel('assignee')} <span class="caret"></span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-assignee">
                                            ${optionHtml(assigneeOptions, filters.assigneeValues, 'assignee')}
                                            <button class="dd-clear" type="button" onclick="clearMultiFilter('assignee', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        if (col.id === 'priority') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-priority" type="button" onclick="toggleDropdown('priority', event)">
                                            ${dropdownLabel('priority')} <span class="caret"></span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-priority">
                                            ${optionHtml(priorityOptions, filters.priorityValues, 'priority')}
                                            <button class="dd-clear" type="button" onclick="clearMultiFilter('priority', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        if (col.id === 'storyPoints') {
                            return `<th><input type="text" placeholder="Search story points" oninput="setFilter('storyPoints', this.value, event)" onclick="event.stopPropagation();" value="${filters.storyPoints || ''}"></th>`;
                        }
                        if (col.id === 'dueDate') {
                            return `<th><input type="text" placeholder="Search due date" oninput="setFilter('dueDate', this.value, event)" onclick="event.stopPropagation();" value="${filters.dueDate || ''}"></th>`;
                        }
                        if (col.id === 'timeOriginalEstimate') {
                            return `<th><input type="text" placeholder="Search estimate" oninput="setFilter('timeOriginalEstimate', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeOriginalEstimate || ''}"></th>`;
                        }
                        if (col.id === 'actualHours') {
                            return `<th><input type="text" placeholder="Search time spent" oninput="setFilter('actualHours', this.value, event)" onclick="event.stopPropagation();" value="${filters.actualHours || ''}"></th>`;
                        }
                        if (col.id === 'timeDifference') {
                            return `<th><input type="text" placeholder="Search difference" oninput="setFilter('timeDifference', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeDifference || ''}"></th>`;
                        }
                        if (col.id === 'created') {
                            return `<th><input type="text" placeholder="Search created" oninput="setFilter('created', this.value, event)" onclick="event.stopPropagation();" value="${filters.created || ''}"></th>`;
                        }
                        if (col.id === 'updated') {
                            return `<th><input type="text" placeholder="Search updated" oninput="setFilter('updated', this.value, event)" onclick="event.stopPropagation();" value="${filters.updated || ''}"></th>`;
                        }
                        if (col.id === 'qaFailedCount') {
                            return `<th class="qa-col"><input type="text" placeholder="Search QA loop" oninput="setFilter('qaFailedCount', this.value, event)" onclick="event.stopPropagation();" value="${filters.qaFailedCount || ''}"></th>`;
                        }
                        if (col.id === 'totalBugs') {
                            return `<th class="qa-col"><input type="text" placeholder="Search total bugs" oninput="setFilter('totalBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.totalBugs || ''}"></th>`;
                        }
                        if (col.id === 'openBugs') {
                            return `<th class="qa-col"><input type="text" placeholder="Search open bugs" oninput="setFilter('openBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.openBugs || ''}"></th>`;
                        }
                        if (col.id === 'subTaskCount') {
                            return `<th class="qa-col"><input type="text" placeholder="Search sub tasks" oninput="setFilter('subTaskCount', this.value, event)" onclick="event.stopPropagation();" value="${filters.subTaskCount || ''}"></th>`;
                        }
                        return '<th></th>';
                    }).join('');
                    filterRow.innerHTML = filterCells;
                }
            }

            // Update body
            updateTableBody(tickets);

            // Update column chooser button label
            const dropdownBtn = document.getElementById('dropdown-btn-columns');
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${columnsDropdownLabel()} <span class="caret"></span>`;
            }

            // Restore dropdown state
            if (wasOpen && dropdown) {
                dropdown.classList.add('open');
                openDropdown = 'columns';
            }
        }

        function toggleColumnVisibility(colId, checked, evt) {
            if (evt) evt.stopPropagation();
            columnVisibility[colId] = checked;
            if (viewMode === 'table') {
                updateTableHeaderAndBody(lastTickets);
            } else {
                renderTickets(lastTickets);
            }
        }

        function resetColumns(evt) {
            if (evt) evt.stopPropagation();
            Object.keys(columnVisibility).forEach(k => columnVisibility[k] = true);
            if (viewMode === 'table') {
                updateTableHeaderAndBody(lastTickets);
            } else {
                renderTickets(lastTickets);
            }
        }

        function setSort(field) {
            if (sortField === field) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDir = 'asc';
            }
            updateTableBody(lastTickets);
        }

        function sortIndicator(field) {
            if (sortField !== field) return '';
            return sortDir === 'asc' ? '' : '';
        }

        function toggleDashboard() {
            viewMode = 'dashboard';
            renderTickets(lastTickets);
        }

        function updateWorklogDate(date) {
            window.selectedWorklogDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);
            }
        }

        function updateWorklogToDate(date) {
            window.worklogToDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);
            }
        }

        function updateWorklogDateRangeToggle(checked) {
            window.useWorklogDateRange = checked;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);
            }
        }

        function updateWorklogDetailDate(date) {
            window.selectedWorklogDetailDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);
            }
        }

        function updateWorklogDetailToDate(date) {
            window.worklogDetailToDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);
            }
        }

        function updateWorklogDetailDateRangeToggle(checked) {
            window.useWorklogDetailDateRange = checked;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);
            }
        }

        function updateWorklogDetailAssignee(assignee) {
            window.selectedWorklogDetailAssignee = assignee;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            }
        }

        function selectAssigneeForWorklogDetails(assignee, date, toDate, useDateRange) {
            // Set both date and assignee
            window.selectedWorklogDetailDate = date;
            window.selectedWorklogDetailAssignee = assignee;

            // Sync date range settings from Assignee Time Tracking widget
            if (useDateRange !== undefined && useDateRange !== null) {
                window.useWorklogDetailDateRange = useDateRange;
            }
            if (toDate !== undefined && toDate !== null) {
                window.worklogDetailToDate = toDate;
            }

            // Re-render dashboard to update Worklog Details widget
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);

                // Scroll to Worklog Details widget after a short delay to ensure it's rendered
                setTimeout(() => {
                    const worklogDetailWidget = document.querySelector('.worklog-detail-widget');
                    if (worklogDetailWidget) {
                        worklogDetailWidget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            } else if (viewMode === 'worklog') {
                renderWorklogView(lastTickets);

                // Scroll to Worklog Details widget after a short delay to ensure it's rendered
                setTimeout(() => {
                    const worklogDetailWidget = document.querySelector('.worklog-detail-widget');
                    if (worklogDetailWidget) {
                        worklogDetailWidget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        function renderWorklogDetailWidget(tickets) {
            // Get today's date
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // Get all unique assignees
            const allAssignees = new Set();
            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                if (assignee) allAssignees.add(assignee);
            });
            const assigneesList = Array.from(allAssignees).sort();

            // Get selected date and assignee (default to today and first assignee)
            // Explicitly check if property exists and is not undefined/null
            const selectedDate = (window.selectedWorklogDetailDate !== undefined && window.selectedWorklogDetailDate !== null)
                ? window.selectedWorklogDetailDate
                : todayStr;
            const selectedAssignee = (window.selectedWorklogDetailAssignee !== undefined && window.selectedWorklogDetailAssignee !== null)
                ? window.selectedWorklogDetailAssignee
                : (assigneesList.length > 0 ? assigneesList[0] : '');

            // Initialize if not set
            if (window.selectedWorklogDetailDate === undefined || window.selectedWorklogDetailDate === null) {
                window.selectedWorklogDetailDate = todayStr;
            }
            if ((window.selectedWorklogDetailAssignee === undefined || window.selectedWorklogDetailAssignee === null) && assigneesList.length > 0) {
                window.selectedWorklogDetailAssignee = assigneesList[0];
            }

            // Get date range toggle state and to date
            const useDateRange = window.useWorklogDetailDateRange === true;
            const toDate = (window.worklogDetailToDate !== undefined && window.worklogDetailToDate !== null)
                ? window.worklogDetailToDate
                : todayStr;

            // Initialize if not set
            if (window.useWorklogDetailDateRange === undefined || window.useWorklogDetailDateRange === null) {
                window.useWorklogDetailDateRange = false;
            }
            if (window.worklogDetailToDate === undefined || window.worklogDetailToDate === null) {
                window.worklogDetailToDate = todayStr;
            }

            // Get worklog details
            const worklogDetails = getWorklogDetailsByDateAndAssignee(tickets, selectedDate, selectedAssignee, useDateRange ? toDate : null);

            // Build assignee options
            const assigneeOptions = assigneesList.map(assignee =>
                `<option value="${assignee}" ${assignee === selectedAssignee ? 'selected' : ''}>${assignee}</option>`
            ).join('');

            // Build worklog detail list
            const worklogDetailList = worklogDetails.length > 0
                ? worklogDetails.map(detail => {
                    const ticketKeyDisplay = detail.ticketKey || 'N/A';
                    const ticketKeyHtml = detail.ticketUrl
                        ? `<a href="${detail.ticketUrl}" target="_blank" onclick="event.stopPropagation();">${ticketKeyDisplay}</a>`
                        : ticketKeyDisplay;
                    return `
                    <li class="worklog-detail-item">
                        <span class="worklog-detail-time">${formatTimeHoursMinutes(detail.timeSpent)}</span>
                        <span class="worklog-detail-key">${ticketKeyHtml}</span>
                        <span class="worklog-detail-date">${detail.date || 'N/A'}</span>
                        <span class="worklog-detail-description">${detail.description}</span>
                    </li>
                `;
                }).join('')
                : '<li class="worklog-detail-item"><span class="worklog-detail-description">No worklogs found for this date and assignee.</span></li>';

            const totalTime = worklogDetails.reduce((sum, detail) => sum + detail.timeSpent, 0);
            const totalFormatted = formatTimeHoursMinutes(totalTime);

            return `
                <div class="dash-card worklog-detail-widget">
                    <h3>Worklog Details</h3>
                    <div class="worklog-input-container">
                        <div class="worklog-input-group">
                            <label class="date-picker-label" for="worklogDetailDatePicker">From Date:</label>
                            <input type="date" id="worklogDetailDatePicker" class="date-picker-input" value="${selectedDate}" onchange="updateWorklogDetailDate(this.value)">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; padding-bottom: 6px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="worklogDetailDateRangeToggle" ${useDateRange ? 'checked' : ''} onchange="updateWorklogDetailDateRangeToggle(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-size: 14px; font-weight: 600; color: #555;">Date Range</span>
                        </div>
                        ${useDateRange ? `
                        <div class="worklog-input-group">
                            <label class="date-picker-label" for="worklogDetailToDatePicker">To Date:</label>
                            <input type="date" id="worklogDetailToDatePicker" class="date-picker-input" value="${toDate}" onchange="updateWorklogDetailToDate(this.value)">
                        </div>
                        ` : ''}
                        <div class="worklog-input-group">
                            <label class="date-picker-label" for="worklogDetailAssigneePicker">Assignee:</label>
                            <select id="worklogDetailAssigneePicker" class="worklog-select" onchange="updateWorklogDetailAssignee(this.value)">
                                ${assigneeOptions}
                            </select>
                        </div>
                    </div>
                    <div class="dash-section">
                        <div class="dash-section-title">
                            <span>Total Time</span>
                            <span class="section-count">${totalFormatted}</span>
                        </div>
                    </div>
                    <ul class="worklog-detail-list">
                        ${worklogDetailList}
                    </ul>
                </div>
            `;
        }

        function updateDashboardButton() {
            const btn = document.getElementById('dashboardBtn');
            if (!btn) return;
            btn.textContent = viewMode === 'dashboard' ? 'AC View' : 'Dashboard';
        }

        async function copyFRStatusWidget(event) {
            const widget = document.getElementById('frStatusWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#frStatusWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);

                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'fr-status-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        async function copyACStatusWidget(event) {
            const widget = document.getElementById('acStatusWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#acStatusWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);

                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ac-status-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        function toggleACStatusSections() {
            isACStatusExpanded = !isACStatusExpanded;
            const widget = document.getElementById('acStatusWidget');
            if (widget) {
                if (isACStatusExpanded) {
                    widget.classList.remove('collapsed');
                } else {
                    widget.classList.add('collapsed');
                }
                // Update toggle icon
                const btn = widget.querySelector('.toggle-btn');
                if (btn) {
                    btn.innerHTML = isACStatusExpanded ?
                        '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>' :
                        '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>';
                }
            }
        }

        function toggleSubTaskStatus() {
            isSubTaskStatusExpanded = !isSubTaskStatusExpanded;
            const widget = document.getElementById('subTaskStatusWidget');
            if (widget) {
                if (isSubTaskStatusExpanded) {
                    widget.classList.remove('collapsed');
                } else {
                    widget.classList.add('collapsed');
                }
                // Update toggle icon
                const btn = widget.querySelector('.toggle-btn');
                if (btn) {
                    btn.innerHTML = isSubTaskStatusExpanded ?
                        '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>' :
                        '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>';
                }
            }
        }

        async function copySubTaskStatusWidget(event) {
            const widget = document.getElementById('subTaskStatusWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#subTaskStatusWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);

                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'sub-task-status-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        async function copyAssigneeTimeTrackingWidget(event) {
            const widget = document.getElementById('assigneeTimeTrackingWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#assigneeTimeTrackingWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);

                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'assignee-time-tracking-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        function toggleFRView() {
            viewMode = 'fr';
            renderTickets(lastTickets);
        }

        function toggleView(newMode) {
            viewMode = newMode;
            renderTickets(lastTickets);
        }

        // --- Pie Chart Helper ---
        function generatePieChartSVG(data, colors, totalValue) {
            if (!data || data.length === 0 || totalValue === 0) return '';

            const legendHtml = `
                <div class="pie-legend">
                    ${data.map(slice => `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${colors[slice.label] || '#ccc'}"></div>
                            <span>${slice.label} (${slice.value})</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Handle case where one slice is 100% or only one slice exists
            const nonZeroSlices = data.filter(d => d.value > 0);
            if (nonZeroSlices.length === 1) {
                const slice = nonZeroSlices[0];
                const percentage = ((slice.value / totalValue) * 100).toFixed(1);
                return `
                    <div class="pie-chart-container">
                        <svg viewBox="0 0 2 2" class="pie-chart-svg" style="display: block;">
                            <circle cx="1" cy="1" r="1" fill="${colors[slice.label] || '#ccc'}" class="pie-slice"
                                    onmouseover="updatePieCenter('${slice.value}', '${slice.label} (${percentage}%)')"
                                    onmouseout="updatePieCenter('${totalValue}', 'Total FRs')">
                                <title>${slice.label}: ${slice.value} (${percentage}%)</title>
                            </circle>
                        </svg>
                        <div class="pie-center-text" id="pieCenterText">
                            <span class="pie-center-count" id="pieCenterCount">${totalValue}</span>
                            <span class="pie-center-label" id="pieCenterLabel">Total FRs</span>
                        </div>
                    </div>
                    ${legendHtml}
                `;
            }

            let cumulativePercent = 0;
            const slices = data.filter(slice => slice.value > 0).map(slice => {
                const startPercent = cumulativePercent;
                const percent = slice.value / totalValue;
                cumulativePercent += percent;

                const [startX, startY] = getCoordinatesForPercent(startPercent);
                const [endX, endY] = getCoordinatesForPercent(cumulativePercent);

                const largeArcFlag = percent > 0.5 ? 1 : 0;

                const pathData = [
                    `M 1 1`, // Move to center
                    `L ${startX} ${startY}`, // Line to start
                    `A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY}`, // Arc
                    `Z` // Close
                ].join(' ');

                const percentage = (percent * 100).toFixed(1);
                return `
                    <path d="${pathData}" 
                          fill="${colors[slice.label] || '#ccc'}" 
                          class="pie-slice"
                          onmouseover="updatePieCenter('${slice.value}', '${slice.label} (${percentage}%)')"
                          onmouseout="updatePieCenter('${totalValue}', 'Total FRs')">
                        <title>${slice.label}: ${slice.value} (${percentage}%)</title>
                    </path>
                `;
            }).join('');

            return `
                <div class="pie-chart-container">
                    <svg viewBox="0 0 2 2" class="pie-chart-svg" style="display: block;">
                        ${slices}
                    </svg>
                    <div class="pie-center-text" id="pieCenterText">
                        <span class="pie-center-count" id="pieCenterCount">${totalValue}</span>
                        <span class="pie-center-label" id="pieCenterLabel">Total FRs</span>
                    </div>
                </div>
                ${legendHtml}
            `;
        }

        function getCoordinatesForPercent(percent) {
            const x = Math.cos(2 * Math.PI * percent);
            const y = Math.sin(2 * Math.PI * percent);
            // Translate from (-1,1) to (0,2) space with center at (1,1)
            return [x + 1, y + 1];
        }

        function updatePieCenter(count, label) {
            const countEl = document.getElementById('pieCenterCount');
            const labelEl = document.getElementById('pieCenterLabel');
            if (countEl) countEl.textContent = count;
            if (labelEl) labelEl.textContent = label;
        }

        // --- Helper function to escape CSV values ---
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            // If value contains comma, newline, or double quote, wrap in quotes and escape quotes
            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        }

        // Generic function to get cell value based on column and data item
        function getCellValue(col, item, idx, viewType) {
            let value = '';
            if (col.id === 'serial') {
                value = idx + 1;
            } else if (viewType === 'fr') {
                // FR view specific columns
                if (col.id === 'frId') {
                    value = item.frId || 'N/A';
                } else if (col.id === 'totalTickets') {
                    value = item.totalTickets || 0;
                } else if (col.id === 'doneTickets') {
                    value = item.doneTickets || 0;
                } else if (col.id === 'pendingTickets') {
                    value = item.pendingTickets || 0;
                } else if (col.id === 'frStatus') {
                    value = item.frStatus || 'N/A';
                }
            } else {
                // AC/Table view columns
                if (col.id === 'key') {
                    value = item.key || 'N/A';
                } else if (col.id === 'summary') {
                    value = item.summary || item.title || 'No title';
                } else if (col.id === 'status') {
                    value = item.status || 'Unknown';
                } else if (col.id === 'assignee') {
                    value = item.assignee || '';
                } else if (col.id === 'priority') {
                    value = item.priority || '';
                } else if (col.id === 'storyPoints') {
                    value = typeof item.storyPoints === 'number' ? item.storyPoints : '';
                } else if (col.id === 'dueDate') {
                    value = item.dueDate ? formatDueDate(item.dueDate) : '';
                } else if (col.id === 'timeOriginalEstimate') {
                    value = formatTimeFromSeconds(item.timeOriginalEstimate || 0);
                } else if (col.id === 'actualHours') {
                    value = formatTimeFromSeconds(item.actualHours || 0);
                } else if (col.id === 'timeDifference') {
                    const estimateSeconds = typeof item.timeOriginalEstimate === 'number' ? item.timeOriginalEstimate : 0;
                    const actualSeconds = typeof item.actualHours === 'number' ? item.actualHours : 0;
                    const diffSeconds = actualSeconds - estimateSeconds;
                    if (diffSeconds === 0) {
                        value = '';
                    } else {
                        const absDiff = Math.abs(diffSeconds);
                        const formatted = formatTimeFromSeconds(absDiff);
                        value = (diffSeconds > 0 ? '+' : '-') + formatted;
                    }
                } else if (col.id === 'created') {
                    value = item.created ? formatDate(item.created) : '';
                } else if (col.id === 'updated') {
                    value = item.updated ? formatDate(item.updated) : '';
                } else if (col.id === 'qaFailedCount') {
                    value = typeof item.qaFailedCount === 'number' ? item.qaFailedCount : '';
                } else if (col.id === 'totalBugs') {
                    value = typeof item.totalBugs === 'number' ? item.totalBugs : '';
                } else if (col.id === 'openBugs') {
                    value = typeof item.openBugs === 'number' ? item.openBugs : '';
                } else if (col.id === 'subTaskCount') {
                    value = typeof item.subTaskCount === 'number' ? item.subTaskCount : 0;
                }
            }
            return value;
        }

        // Helper function to generate filter action buttons based on current view
        function getFilterActionsButtons(columnChooser = '') {
            let tabs = [];
            let options = [];

            // Export button (available in table and FR views)
            if (viewMode === 'table' || viewMode === 'fr') {
                options.push(`<button class="clear-btn" type="button" onclick="exportToCSV()" title="Export to CSV">Export</button>`);
            }

            // Column chooser (available in table and FR views)
            if (columnChooser && (viewMode === 'table' || viewMode === 'fr')) {
                options.push(columnChooser);
            }

            // View toggle buttons - Always show all tabs
            const viewConfigs = [
                { id: 'dashboard', label: 'Dashboard', onClick: "toggleView('dashboard')" },
                { id: 'table', label: 'AC View', onClick: "toggleView('table')" },
                { id: 'fr', label: 'FR View', onClick: "toggleView('fr')" },
                { id: 'worklog', label: 'Worklog', onClick: "toggleView('worklog')" },
                { id: 'sprintplan', label: 'Sprint Plan ', onClick: "toggleView('sprintplan')" },
                { id: 'dev', label: 'Dev View', onClick: "toggleView('dev')" }
            ];

            viewConfigs.forEach(conf => {
                const isActive = (viewMode === conf.id);
                // For AC View tab, we special case the click to toggleView('table')
                // For Dashboard tab, we special case the click to toggleView('dashboard')
                tabs.push(`<button class="clear-btn ${isActive ? 'active' : ''}" type="button" onclick="${conf.onClick}">${conf.label}</button>`);
            });

            // Extra buttons for specific views
            if (viewMode === 'fr') {
                options.push(`<button class="clear-btn" type="button" onclick="clearFRFilters()">Clear filters</button>`);
            } else if (viewMode === 'table') {
                options.push(`<button class="clear-btn" type="button" onclick="clearFilters()">Clear filters</button>`);
            }

            return {
                tabs: tabs.join('\n                        '),
                options: options.join('\n                        ')
            };
        }

        // Unified export function for all views
        function exportToCSV() {
            let data = [];
            let visibleColumns = [];
            let viewType = '';
            let filenamePrefix = '';

            // Determine view type and prepare data
            if (viewMode === 'fr') {
                const frData = aggregateFRData(lastTickets);
                data = applyFRFiltersAndSort(frData);
                visibleColumns = frColumns.filter(c => frColumnVisibility[c.id]);
                viewType = 'fr';
                filenamePrefix = 'fr-view';
            } else {
                // AC/Table view
                data = applyFiltersAndSort(lastTickets);
                visibleColumns = columns.filter(c => columnVisibility[c.id]);
                viewType = 'table';
                filenamePrefix = 'ac-view';
            }

            // Build CSV header
            const headers = visibleColumns.map(col => escapeCSV(col.label));
            const csvRows = [headers.join(',')];

            // Build CSV rows
            data.forEach((item, idx) => {
                const row = [];
                visibleColumns.forEach(col => {
                    const value = getCellValue(col, item, idx, viewType);
                    row.push(escapeCSV(value));
                });
                csvRows.push(row.join(','));
            });

            // Create and download CSV
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filenamePrefix}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // FR View columns
        const frColumns = [
            { id: 'serial', label: '#', sortable: null, className: 'serial-col' },
            { id: 'frId', label: 'FR ID', sortable: 'frId' },
            { id: 'totalTickets', label: 'Total Tickets', sortable: 'totalTickets' },
            { id: 'doneTickets', label: 'Done Tickets', sortable: 'doneTickets' },
            { id: 'pendingTickets', label: 'Pending Tickets', sortable: 'pendingTickets' },
            { id: 'frStatus', label: 'Status', sortable: 'frStatus' },
        ];

        const frColumnVisibility = {
            serial: true,
            frId: true,
            totalTickets: true,
            doneTickets: true,
            pendingTickets: true,
            frStatus: true
        };

        const frFilters = {
            frId: '',
            totalTickets: '',
            doneTickets: '',
            pendingTickets: '',
            frStatusValues: []
        };

        function getDefaultFRFilters() {
            return {
                frId: '',
                totalTickets: '',
                doneTickets: '',
                pendingTickets: '',
                frStatusValues: []
            };
        }

        // Aggregate FR data from tickets
        function aggregateFRData(tickets) {
            const frMap = {};

            tickets.forEach(ticket => {
                if (!ticket.frId) return;

                if (!frMap[ticket.frId]) {
                    frMap[ticket.frId] = {
                        frId: ticket.frId,
                        totalTickets: 0,
                        doneTickets: 0,
                        pendingTickets: 0,
                        frStatus: ''
                    };
                }

                frMap[ticket.frId].totalTickets++;

                if (ticket.statusCategory === 'Done') {
                    frMap[ticket.frId].doneTickets++;
                }
            });

            // Calculate pending and status for each FR
            Object.values(frMap).forEach(fr => {
                fr.pendingTickets = fr.totalTickets - fr.doneTickets;

                if (fr.doneTickets === 0) {
                    fr.frStatus = 'Pending';
                } else if (fr.doneTickets === fr.totalTickets) {
                    fr.frStatus = 'Done';
                } else {
                    fr.frStatus = 'Partially Done';
                }
            });

            return Object.values(frMap);
        }

        function applyFRFiltersAndSort(frData) {
            const filtered = frData.filter(fr => {
                const frId = (fr.frId || '').toLowerCase().includes(frFilters.frId.toLowerCase());
                const totalTickets = String(fr.totalTickets || 0).toLowerCase().includes(frFilters.totalTickets.toLowerCase());
                const doneTickets = String(fr.doneTickets || 0).toLowerCase().includes(frFilters.doneTickets.toLowerCase());
                const pendingTickets = String(fr.pendingTickets || 0).toLowerCase().includes(frFilters.pendingTickets.toLowerCase());

                const statusValue = (fr.frStatus || '').toLowerCase();
                const status = frFilters.frStatusValues.length === 0 || frFilters.frStatusValues.includes(statusValue);

                return frId && totalTickets && doneTickets && pendingTickets && status;
            });

            if (!sortField) return filtered;

            const dir = sortDir === 'asc' ? 1 : -1;
            return filtered.slice().sort((a, b) => {
                // Handle numeric fields
                if (sortField === 'totalTickets' || sortField === 'doneTickets' || sortField === 'pendingTickets') {
                    const va = typeof a[sortField] === 'number' ? a[sortField] : 0;
                    const vb = typeof b[sortField] === 'number' ? b[sortField] : 0;
                    return (va - vb) * dir;
                }
                // Handle string fields
                const va = (a[sortField] ?? '').toString().toLowerCase();
                const vb = (b[sortField] ?? '').toString().toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
        }

        function setFRFilter(field, value, evt) {
            if (evt) evt.stopPropagation();
            frFilters[field] = value.toLowerCase();
            if (viewMode === 'fr') {
                updateFRTableBody(lastTickets);
            }
        }

        function toggleFRMultiOption(field, value, checked, evt) {
            if (evt) evt.stopPropagation();
            const key = `${field}Values`;
            const arr = frFilters[key] || [];
            const norm = value.toLowerCase();
            const exists = arr.includes(norm);
            if (checked && !exists) {
                arr.push(norm);
                frFilters[key] = arr;
            } else if (!checked && exists) {
                frFilters[key] = arr.filter(v => v !== norm);
            }
            if (viewMode === 'fr') {
                updateFRTableBody(lastTickets);
            }

            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${frDropdownLabel(field)} <span class="caret"></span>`;
            }
        }

        function clearFRMultiFilter(field, evt) {
            if (evt) evt.stopPropagation();
            frFilters[`${field}Values`] = [];
            if (viewMode === 'fr') {
                updateFRTableBody(lastTickets);
            }

            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${frDropdownLabel(field)} <span class="caret"></span>`;
            }

            // Uncheck all checkboxes in the dropdown
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (dropdown) {
                const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        }

        function frDropdownLabel(field) {
            const arr = frFilters[`${field}Values`] || [];
            if (arr.length === 0) return 'All';
            if (arr.length === 1) return arr[0];
            return `${arr.length} selected`;
        }

        function frColumnsDropdownLabel() {
            const visibleCount = Object.values(frColumnVisibility).filter(Boolean).length;
            const total = frColumns.length;
            return visibleCount === total ? 'Columns (All)' : `Columns (${visibleCount}/${total})`;
        }

        function updateFRTableHeaderAndBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderFRView(tickets);
                return;
            }

            // Save dropdown state
            const wasOpen = openDropdown === 'frColumns';
            const dropdown = document.getElementById('dropdown-frColumns');

            const visibleColumns = frColumns.filter(c => frColumnVisibility[c.id]);

            // Update header row
            const thead = table.querySelector('thead');
            if (thead) {
                const headerRow = thead.querySelector('tr:first-child');
                if (headerRow) {
                    const headerCells = visibleColumns.map(col => {
                        const sortableAttrs = col.sortable
                            ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setFRSort('${col.id}')"`
                            : `${col.className ? `class="${col.className}"` : ''}`;
                        const indicator = col.sortable ? `<span class="sort-indicator">${frSortIndicator(col.id)}</span>` : '';
                        return `
                            <th ${sortableAttrs}>
                                ${col.label} ${indicator}
                            </th>
                        `;
                    }).join('');
                    headerRow.innerHTML = headerCells;
                }

                // Update filter row
                const filterRow = thead.querySelector('tr:last-child');
                if (filterRow) {
                    const statusOptions = ['Done', 'Pending', 'Partially Done'];

                    const optionHtml = (opts, selected, field) => opts.map(opt => {
                        const isSel = selected.includes(opt.toLowerCase());
                        const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        return `
                            <label>
                                <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleFRMultiOption('${field}', '${safe}', this.checked, event)">
                                ${safe}
                            </label>
                        `;
                    }).join('');

                    const filterCells = visibleColumns.map(col => {
                        if (col.id === 'serial') {
                            return `<th class="serial-col">#</th>`;
                        }
                        if (col.id === 'frId') {
                            return `<th><input type="text" placeholder="Search FR ID" oninput="setFRFilter('frId', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.frId || ''}"></th>`;
                        }
                        if (col.id === 'totalTickets') {
                            return `<th><input type="text" placeholder="Search total" oninput="setFRFilter('totalTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.totalTickets || ''}"></th>`;
                        }
                        if (col.id === 'doneTickets') {
                            return `<th><input type="text" placeholder="Search done" oninput="setFRFilter('doneTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.doneTickets || ''}"></th>`;
                        }
                        if (col.id === 'pendingTickets') {
                            return `<th><input type="text" placeholder="Search pending" oninput="setFRFilter('pendingTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.pendingTickets || ''}"></th>`;
                        }
                        if (col.id === 'frStatus') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-frStatus" type="button" onclick="toggleDropdown('frStatus', event)">
                                            ${frDropdownLabel('frStatus')} <span class="caret"></span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-frStatus">
                                            ${optionHtml(statusOptions, frFilters.frStatusValues, 'frStatus')}
                                            <button class="dd-clear" type="button" onclick="clearFRMultiFilter('frStatus', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        return '<th></th>';
                    }).join('');
                    filterRow.innerHTML = filterCells;
                }
            }

            // Update body
            updateFRTableBody(tickets);

            // Update column chooser button label
            const dropdownBtn = document.getElementById('dropdown-btn-frColumns');
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${frColumnsDropdownLabel()} <span class="caret"></span>`;
            }

            // Restore dropdown state
            if (wasOpen && dropdown) {
                dropdown.classList.add('open');
                openDropdown = 'frColumns';
            }
        }

        function toggleFRColumnVisibility(colId, checked, evt) {
            if (evt) evt.stopPropagation();
            frColumnVisibility[colId] = checked;
            if (viewMode === 'fr') {
                updateFRTableHeaderAndBody(lastTickets);
            }
        }

        function resetFRColumns(evt) {
            if (evt) evt.stopPropagation();
            Object.keys(frColumnVisibility).forEach(k => frColumnVisibility[k] = true);
            if (viewMode === 'fr') {
                updateFRTableHeaderAndBody(lastTickets);
            }
        }

        function setFRSort(field) {
            if (sortField === field) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDir = 'asc';
            }
            if (viewMode === 'fr') {
                renderFRView(lastTickets);
            }
        }

        function frSortIndicator(field) {
            if (sortField !== field) return '';
            return sortDir === 'asc' ? '' : '';
        }

        function clearFRFilters() {
            Object.assign(frFilters, getDefaultFRFilters());
            if (viewMode === 'fr') {
                renderFRView(lastTickets);
            }
        }

        function clearFilters() {
            Object.assign(filters, getDefaultFilters());
            renderTickets(lastTickets);
        }

        function resetDevViewFilters() {
            const initialAssigneeSet = new Set();
            const initialStatusSet = new Set();

            (lastTickets || []).forEach(t => {
                initialAssigneeSet.add(t.assignee || 'Unassigned');
                initialStatusSet.add(t.status);
                (t.linkedBugs || []).forEach(b => {
                    initialAssigneeSet.add(b.assignee || 'Unassigned');
                    initialStatusSet.add(b.status);
                });
            });
            (lastDevSubtasks || []).forEach(t => {
                initialAssigneeSet.add(t.assignee || 'Unassigned');
                initialStatusSet.add(t.status);
                (t.linkedBugs || []).forEach(b => {
                    initialAssigneeSet.add(b.assignee || 'Unassigned');
                    initialStatusSet.add(b.status);
                });
            });

            devAssigneeFilters = Array.from(initialAssigneeSet);
            devStatusFilters = Array.from(initialStatusSet);
            devTypeFilter = ['Story', 'Sub Task', 'Bug'];

            renderPostResults();
        }

        function getUniqueValues(tickets, field) {
            const set = new Set();
            (tickets || []).forEach(t => {
                const val = (t[field] || '').trim();
                if (val) set.add(val);
            });
            return Array.from(set).sort((a, b) => a.localeCompare(b));
        }

        function applyFiltersAndSort(tickets) {
            const filtered = tickets.filter(t => {
                const key = (t.key || '').toLowerCase().includes(filters.key);
                const summary = (t.summary || t.title || '').toLowerCase().includes(filters.summary);

                const statusValue = (t.status || '').toLowerCase();
                const status = filters.statusValues.length === 0 || filters.statusValues.includes(statusValue);

                const assigneeValue = (t.assignee || '').toLowerCase();
                const assignee = filters.assigneeValues.length === 0 || filters.assigneeValues.includes(assigneeValue);

                const priorityValue = (t.priority || '').toLowerCase();
                const priority = filters.priorityValues.length === 0 || filters.priorityValues.includes(priorityValue);

                const storyPoints = String(typeof t.storyPoints === 'number' ? t.storyPoints : '').toLowerCase().includes(filters.storyPoints);
                const timeEstimate = formatTimeFromSeconds(t.timeOriginalEstimate || 0).toLowerCase().includes(filters.timeOriginalEstimate);
                const actualHrs = formatTimeFromSeconds(t.actualHours || 0).toLowerCase().includes(filters.actualHours);
                // For timeDifference, calculate the difference and format for filtering (without HTML)
                const estimateSeconds = typeof t.timeOriginalEstimate === 'number' ? t.timeOriginalEstimate : 0;
                const actualSeconds = typeof t.actualHours === 'number' ? t.actualHours : 0;
                const diffSeconds = actualSeconds - estimateSeconds;
                const timeDiffFormatted = diffSeconds !== 0 ? (diffSeconds > 0 ? '+' : '-') + formatTimeFromSeconds(Math.abs(diffSeconds)) : '';
                const timeDiff = timeDiffFormatted.toLowerCase().includes(filters.timeDifference);
                const created = (t.created || '').toLowerCase().includes(filters.created);
                const updated = (t.updated || '').toLowerCase().includes(filters.updated);
                const dueDate = (t.dueDate ? formatDueDate(t.dueDate) : '').toLowerCase().includes(filters.dueDate);
                const qaFailed = String(typeof t.qaFailedCount === 'number' ? t.qaFailedCount : '').toLowerCase().includes(filters.qaFailedCount);
                const totalBugs = String(typeof t.totalBugs === 'number' ? t.totalBugs : '').toLowerCase().includes(filters.totalBugs);
                const openBugs = String(typeof t.openBugs === 'number' ? t.openBugs : '').toLowerCase().includes(filters.openBugs);
                const subTaskCount = String(typeof t.subTaskCount === 'number' ? t.subTaskCount : 0).toLowerCase().includes(filters.subTaskCount);
                return key && summary && status && assignee && priority && storyPoints && timeEstimate && actualHrs && timeDiff && created && updated && dueDate && qaFailed && totalBugs && openBugs && subTaskCount;
            });

            if (!sortField) return filtered;

            const dir = sortDir === 'asc' ? 1 : -1;
            return filtered.slice().sort((a, b) => {
                // Handle numeric fields (storyPoints, qaFailedCount, timeOriginalEstimate, actualHours, timeDifference, totalBugs, openBugs, subTaskCount)
                if (sortField === 'storyPoints' || sortField === 'qaFailedCount' || sortField === 'timeOriginalEstimate' || sortField === 'actualHours' || sortField === 'timeDifference' || sortField === 'totalBugs' || sortField === 'openBugs' || sortField === 'subTaskCount') {
                    let va, vb;
                    if (sortField === 'timeDifference') {
                        // Calculate difference for sorting
                        va = (typeof a.actualHours === 'number' ? a.actualHours : 0) - (typeof a.timeOriginalEstimate === 'number' ? a.timeOriginalEstimate : 0);
                        vb = (typeof b.actualHours === 'number' ? b.actualHours : 0) - (typeof b.timeOriginalEstimate === 'number' ? b.timeOriginalEstimate : 0);
                    } else {
                        va = typeof a[sortField] === 'number' ? a[sortField] : 0;
                        vb = typeof b[sortField] === 'number' ? b[sortField] : 0;
                    }
                    return (va - vb) * dir;
                }
                // Handle string fields
                const va = (a[sortField] ?? '').toString().toLowerCase();
                const vb = (b[sortField] ?? '').toString().toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
        }

        function updateTableBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderTickets(tickets);
                return;
            }
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const visible = applyFiltersAndSort(tickets || []);
            tbody.innerHTML = visible.map((ticket, idx) => {
                const cells = [];
                if (columnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                if (columnVisibility.key) cells.push(`<td>${ticket.key || 'N/A'}</td>`);
                if (columnVisibility.summary) cells.push(`<td>${ticket.summary || ticket.title || 'No title'}</td>`);
                if (columnVisibility.status) cells.push(`<td><span class="ticket-status">${ticket.status || 'Unknown'}</span></td>`);
                if (columnVisibility.assignee) cells.push(`<td>${ticket.assignee || ''}</td>`);
                if (columnVisibility.priority) cells.push(`<td>${ticket.priority || ''}</td>`);
                if (columnVisibility.storyPoints) cells.push(`<td>${typeof ticket.storyPoints === 'number' ? ticket.storyPoints : ''}</td>`);
                if (columnVisibility.dueDate) {
                    const formattedDueDate = ticket.dueDate ? formatDueDate(ticket.dueDate) : '';
                    const isOverdue = formattedDueDate.startsWith('+ ');
                    const dueDateClass = isOverdue ? ' class="due-date-overdue"' : '';
                    cells.push(`<td${dueDateClass}>${formattedDueDate}</td>`);
                }
                if (columnVisibility.timeOriginalEstimate) cells.push(`<td>${formatTimeFromSeconds(ticket.timeOriginalEstimate || 0)}</td>`);
                if (columnVisibility.actualHours) cells.push(`<td>${formatTimeFromSeconds(ticket.actualHours || 0)}</td>`);
                if (columnVisibility.timeDifference) cells.push(`<td>${formatTimeDifference(ticket.timeOriginalEstimate, ticket.actualHours)}</td>`);
                if (columnVisibility.created) cells.push(`<td>${ticket.created ? formatDate(ticket.created) : ''}</td>`);
                if (columnVisibility.updated) cells.push(`<td>${ticket.updated ? formatDate(ticket.updated) : ''}</td>`);
                if (columnVisibility.qaFailedCount) cells.push(`<td>${typeof ticket.qaFailedCount === 'number' ? ticket.qaFailedCount : ''}</td>`);
                if (columnVisibility.totalBugs) cells.push(`<td>${typeof ticket.totalBugs === 'number' ? ticket.totalBugs : ''}</td>`);
                if (columnVisibility.openBugs) cells.push(`<td>${typeof ticket.openBugs === 'number' ? ticket.openBugs : ''}</td>`);
                if (columnVisibility.subTaskCount) cells.push(`<td>${typeof ticket.subTaskCount === 'number' ? ticket.subTaskCount : ''}</td>`);
                return `<tr onclick="window.open('${ticket.url || '#'}', '_blank')" style="cursor:pointer;">${cells.join('')}</tr>`;
            }).join('');
        }

        function updateFRTableBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderFRView(tickets);
                return;
            }
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            const frData = aggregateFRData(tickets || []);
            const filteredAndSorted = applyFRFiltersAndSort(frData);

            tbody.innerHTML = filteredAndSorted.map((fr, idx) => {
                const cells = [];
                if (frColumnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                if (frColumnVisibility.frId) cells.push(`<td>${fr.frId || 'N/A'}</td>`);
                if (frColumnVisibility.totalTickets) cells.push(`<td>${fr.totalTickets || 0}</td>`);
                if (frColumnVisibility.doneTickets) cells.push(`<td>${fr.doneTickets || 0}</td>`);
                if (frColumnVisibility.pendingTickets) cells.push(`<td>${fr.pendingTickets || 0}</td>`);
                if (frColumnVisibility.frStatus) cells.push(`<td>${fr.frStatus || 'N/A'}</td>`);
                // Construct Jira URL with FR ID - only make clickable if FR ID exists
                const frId = fr.frId || '';
                let rowAttrs = '';
                if (frId && frId !== 'N/A') {
                    const parent = modules[activeModule].emId;
                    const jqlQuery = `cf[10049] = "${frId}" AND parent = ${parent}`;
                    const encodedJql = encodeURIComponent(jqlQuery);
                    const jiraUrl = `https://cardyai-hawaii.atlassian.net/issues/?jql=${encodedJql}`;
                    rowAttrs = `onclick="window.open('${jiraUrl}', '_blank')" style="cursor:pointer;"`;
                }
                return `<tr ${rowAttrs}>${cells.join('')}</tr>`;
            }).join('');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.remove('active');
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('done') || statusLower.includes('closed') || statusLower.includes('resolved')) {
                return 'status-done';
            } else if (statusLower.includes('progress')) {
                return 'status-in-progress';
            } else if (statusLower.includes('todo') || statusLower.includes('open') || statusLower.includes('backlog')) {
                return 'status-todo';
            }
            return 'status-default';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatDueDate(dateString) {
            if (!dateString) return '';
            try {
                const dueDate = new Date(dateString);
                const today = new Date();
                // Set time to midnight for accurate date comparison
                today.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);

                const year = dueDate.getFullYear();
                const month = String(dueDate.getMonth() + 1).padStart(2, '0');
                const day = String(dueDate.getDate()).padStart(2, '0');
                const formattedDate = `${year}/${month}/${day}`;

                // If current date is greater than due date, add "+" prefix
                if (today > dueDate) {
                    return `+ ${formattedDate}`;
                }
                return formattedDate;
            } catch (e) {
                return dateString;
            }
        }

        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function getWeekRangeLabel(dateString) {
            if (!dateString) return 'No due dates';
            try {
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return 'No due dates';
                const monday = getMonday(d);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);

                const options = { month: 'short', day: 'numeric' };
                return `${monday.toLocaleDateString('en-US', options)} to ${sunday.toLocaleDateString('en-US', options)}`;
            } catch (e) {
                return 'No due dates';
            }
        }

        function formatWorklogDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatTimeFromSeconds(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '';
            if (seconds === 0) return '0h';

            // Custom conversions: 60m = 1h, 8h = 1d, 5d = 1w
            const SECONDS_PER_MINUTE = 60;
            const SECONDS_PER_HOUR = 60 * SECONDS_PER_MINUTE; // 3600
            const SECONDS_PER_DAY = 8 * SECONDS_PER_HOUR; // 28800 (8 hours = 1 day)
            const SECONDS_PER_WEEK = 5 * SECONDS_PER_DAY; // 144000 (5 days = 1 week)

            const weeks = Math.floor(seconds / SECONDS_PER_WEEK);
            const days = Math.floor((seconds % SECONDS_PER_WEEK) / SECONDS_PER_DAY);
            const hours = Math.floor((seconds % SECONDS_PER_DAY) / SECONDS_PER_HOUR);
            const minutes = Math.floor((seconds % SECONDS_PER_HOUR) / SECONDS_PER_MINUTE);

            const parts = [];
            if (weeks > 0) parts.push(`${weeks}w`);
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);

            return parts.length > 0 ? parts.join(' ') : '0h';
        }

        function formatTimeHoursMinutes(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '';
            if (seconds === 0) return '0h';

            // Standard conversions: 60m = 1h (no days or weeks)
            const SECONDS_PER_MINUTE = 60;
            const SECONDS_PER_HOUR = 60 * SECONDS_PER_MINUTE; // 3600

            const hours = Math.floor(seconds / SECONDS_PER_HOUR);
            const minutes = Math.floor((seconds % SECONDS_PER_HOUR) / SECONDS_PER_MINUTE);

            const parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);

            return parts.length > 0 ? parts.join(' ') : '0h';
        }

        function formatTimeDifference(estimate, actual) {
            if (estimate === null || estimate === undefined || actual === null || actual === undefined) {
                return '';
            }

            const estimateSeconds = typeof estimate === 'number' ? estimate : 0;
            const actualSeconds = typeof actual === 'number' ? actual : 0;
            const difference = actualSeconds - estimateSeconds;

            if (difference === 0) {
                return '';
            }

            const absDifference = Math.abs(difference);
            const formatted = formatTimeFromSeconds(absDifference);

            if (difference > 0) {
                return `<span class="time-diff-positive">+${formatted}</span>`;
            } else {
                return `<span class="time-diff-negative">-${formatted}</span>`;
            }
        }

        function getStatusCategory(status) {
            const statusLower = (status || '').toLowerCase().trim();
            const todoStatuses = ['backlog', 'ready for sprint'];
            const devStatuses = ['dev in progress', 'qa failed', 'ready for dev', 'dev complete', 'bug fixes - dev'];
            const qaStatuses = ['ready to review', 'qa in progress', 'review failed'];
            const baStatuses = ['review completed', 'qa complete', 'ba review'];
            const blockedStatuses = ['blocked', 'awaiting clarification'];
            const doneStatuses = ['done', 'descoped'];

            if (todoStatuses.some(s => statusLower === s)) {
                return 'Backlog';
            }
            if (devStatuses.some(s => statusLower === s)) {
                return 'Dev';
            }
            if (qaStatuses.some(s => statusLower === s)) {
                return 'QA';
            }
            if (baStatuses.some(s => statusLower === s)) {
                return 'BA';
            }
            if (blockedStatuses.some(s => statusLower === s)) {
                return 'Blocked';
            }
            if (doneStatuses.some(s => statusLower === s)) {
                return 'Done';
            }
            return 'Backlog'; // Default to Backlog and remove "Other"
        }

        const getReportCategory = (status) => {
            const s = (status || '').toLowerCase().trim();
            if (['to do', 'assigned'].includes(s)) return 'todo';
            if (['in progress', 'dev complete', 'review failed'].includes(s)) return 'inprogress';
            if (['blocked', 'awaiting clarification'].includes(s)) return 'blocked';
            if (['closed', 'descoped'].includes(s)) return 'closed';
            if (['dev review'].includes(s)) return 'review';
            return 'todo';
        };

        function getWorklogsByDate(tickets, selectedDate, toDate) {
            if (!selectedDate) return {};

            const assigneeTimeMap = {};
            // selectedDate is in YYYY-MM-DD format
            const selectedDateStr = selectedDate;
            const toDateStr = toDate || selectedDate; // If no toDate, use selectedDate (single date mode)

            // Convert to Date objects for comparison
            const fromDateObj = new Date(selectedDateStr);
            const toDateObj = new Date(toDateStr);
            toDateObj.setHours(23, 59, 59, 999); // Include the entire end date

            tickets.forEach(ticket => {
                if (!ticket.worklog || !ticket.worklog.worklogs) return;

                ticket.worklog.worklogs.forEach(worklog => {
                    if (!worklog.started || !worklog.timeSpentSeconds || !worklog.author) return;

                    // Parse the started date - format: "2025-12-11T14:00:00.000+0530"
                    // Extract just the date part (YYYY-MM-DD) from the ISO string
                    const worklogDateStr = worklog.started.split('T')[0];
                    const worklogDateObj = new Date(worklogDateStr);

                    // Check if worklog is within the date range (inclusive)
                    if (worklogDateObj >= fromDateObj && worklogDateObj <= toDateObj) {
                        const assigneeName = worklog.author.displayName || 'Unknown';
                        const timeSpent = worklog.timeSpentSeconds || 0;

                        if (!assigneeTimeMap[assigneeName]) {
                            assigneeTimeMap[assigneeName] = 0;
                        }
                        assigneeTimeMap[assigneeName] += timeSpent;
                    }
                });
            });

            return assigneeTimeMap;
        }

        function extractTextFromComment(comment) {
            if (!comment || !comment.content) return '';

            let text = '';

            function extractFromContent(content) {
                if (Array.isArray(content)) {
                    content.forEach(item => {
                        if (item.type === 'text' && item.text) {
                            text += item.text + ' ';
                        } else if (item.content) {
                            extractFromContent(item.content);
                        }
                    });
                }
            }

            extractFromContent(comment.content);
            return text.trim();
        }

        function getWorklogDetailsByDateAndAssignee(tickets, selectedDate, selectedAssignee, toDate) {
            if (!selectedDate || !selectedAssignee) return [];

            const worklogDetails = [];
            const selectedDateStr = selectedDate;
            const toDateStr = toDate || selectedDate; // If no toDate, use selectedDate (single date mode)

            // Convert to Date objects for comparison
            const fromDateObj = new Date(selectedDateStr);
            const toDateObj = new Date(toDateStr);
            toDateObj.setHours(23, 59, 59, 999); // Include the entire end date

            tickets.forEach(ticket => {
                if (!ticket.worklog || !ticket.worklog.worklogs) return;

                ticket.worklog.worklogs.forEach(worklog => {
                    if (!worklog.started || !worklog.timeSpentSeconds || !worklog.author) return;

                    const worklogDateStr = worklog.started.split('T')[0];
                    const worklogDateObj = new Date(worklogDateStr);
                    const assigneeName = worklog.author.displayName || 'Unknown';

                    // Check if worklog matches selected date range and assignee
                    if (worklogDateObj >= fromDateObj && worklogDateObj <= toDateObj && assigneeName === selectedAssignee) {
                        const description = extractTextFromComment(worklog.comment) || 'No description';
                        // Format date as "Dec 10"
                        const formattedDate = formatWorklogDate(worklogDateStr);
                        worklogDetails.push({
                            timeSpent: worklog.timeSpentSeconds,
                            timeSpentFormatted: worklog.timeSpent || formatTimeHoursMinutes(worklog.timeSpentSeconds),
                            description: description,
                            ticketKey: ticket.key,
                            ticketUrl: ticket.url,
                            started: worklog.started,
                            date: formattedDate
                        });
                    }
                });
            });

            // Sort by started time (most recent first)
            worklogDetails.sort((a, b) => new Date(b.started) - new Date(a.started));

            return worklogDetails;
        }

        function renderDashboard(tickets) {
            const container = document.getElementById('ticketsContainer');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            const statusCounts = {};
            const assigneeCounts = {};
            const totalTickets = tickets.length;

            tickets.forEach(t => {
                const status = (t.status || 'Unknown').trim();
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                const assignee = (t.assignee || 'Unassigned').trim();
                assigneeCounts[assignee] = (assigneeCounts[assignee] || 0) + 1;
            });

            // Group statuses by category
            const statusByCategory = {
                'Backlog': [],
                'Dev': [],
                'QA': [],
                'BA': [],
                'Blocked': [],
                'Done': []
            };

            Object.entries(statusCounts).forEach(([status, count]) => {
                const category = getStatusCategory(status);
                statusByCategory[category].push({ status, count });
            });

            // Sort statuses within each category by count (descending)
            Object.keys(statusByCategory).forEach(category => {
                statusByCategory[category].sort((a, b) => b.count - a.count);
            });

            // Calculate section totals
            const sectionTotals = {};
            Object.keys(statusByCategory).forEach(category => {
                sectionTotals[category] = statusByCategory[category].reduce((sum, { count }) => sum + count, 0);
            });

            // Render status sections
            const sectionOrder = ['Backlog', 'Dev', 'QA', 'BA', 'Blocked', 'Done'];
            const statusSections = sectionOrder.map(category => {
                const statuses = statusByCategory[category];
                // if (statuses.length === 0) return '';

                const sectionTotal = sectionTotals[category];
                const sectionPercentage = totalTickets > 0 ? ((sectionTotal / totalTickets) * 100).toFixed(1) : '0.0';

                const statusItems = statuses.map(({ status, count }) => {
                    const percentage = totalTickets > 0 ? ((count / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${status}</span><span>${count} (${percentage}%)</span></li>`;
                }).join('');

                return `
                    <div class="dash-section">
                        <div class="dash-section-title">
                            <span>${category}</span>
                            <span class="section-count">${sectionTotal} (${sectionPercentage}%)</span>
                        </div>
                        <ul class="dash-list">
                            ${statusItems}
                        </ul>
                    </div>
                `;
            }).filter(section => section !== '').join('');

            const assigneeList = Object.entries(assigneeCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const percentage = totalTickets > 0 ? ((v / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${k}</span><span>${v} (${percentage}%)</span></li>`;
                })
                .join('');

            const assigneeSubTaskCounts = {};
            let totalSubTasks = 0;
            (lastDevSubtasks || []).forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                assigneeSubTaskCounts[assignee] = (assigneeSubTaskCounts[assignee] || 0) + 1;
                totalSubTasks++;
            });

            const subTasksCountList = Object.entries(assigneeSubTaskCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const percentage = totalSubTasks > 0 ? ((v / totalSubTasks) * 100).toFixed(1) : '0.0';
                    return `<li><span>${k}</span><span>${v} (${percentage}%)</span></li>`;
                })
                .join('');

            // Calculate Assignee (Sub Task Story Points)
            const assigneeSubTaskSP = {};
            let totalSubTaskSP = 0;
            (lastDevSubtasks || []).forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                // Ensure storyPoints is treated as a number
                // Check various possible locations/names for Story Points
                let item = t;
                // If backend returns raw fields in a property (unlikely based on assignee, but possible)
                if (t.fields) item = t.fields;

                let sp = item.storyPoints || item.customfield_10048 || item.customfield_10026 || item.customfield_10016 || item.customfield_10034;

                if (typeof sp !== 'number') {
                    sp = parseFloat(sp);
                }
                if (isNaN(sp)) sp = 0;

                assigneeSubTaskSP[assignee] = (assigneeSubTaskSP[assignee] || 0) + sp;
                totalSubTaskSP += sp;
            });

            const subTasksSPList = Object.entries(assigneeSubTaskSP)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const percentage = totalSubTaskSP > 0 ? ((v / totalSubTaskSP) * 100).toFixed(1) : '0.0';
                    return `<li><span>${k}</span><span>${Math.round(v * 10) / 10} (${percentage}%)</span></li>`;
                })
                .join('');

            // Calculate QA Loop count breakdown
            const qaFailedCounts = {};
            tickets.forEach(t => {
                const count = typeof t.qaFailedCount === 'number' ? t.qaFailedCount : 0;
                qaFailedCounts[count] = (qaFailedCounts[count] || 0) + 1;
            });

            const qaFailedList = Object.entries(qaFailedCounts)
                .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                .map(([count, ticketCount]) => {
                    const percentage = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${count}</span><span>${ticketCount} (${percentage}%)</span></li>`;
                })
                .join('');

            // Calculate Assignee (Story Points)
            const assigneeSP = {};
            let totalSP = 0;
            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                const sp = typeof t.storyPoints === 'number' ? t.storyPoints : 0;
                assigneeSP[assignee] = (assigneeSP[assignee] || 0) + sp;
                totalSP += sp;
            });

            const assigneeSPList = Object.entries(assigneeSP)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const percentage = totalSP > 0 ? ((v / totalSP) * 100).toFixed(1) : '0.0';
                    return `<li><span>${k}</span><span>${v} (${percentage}%)</span></li>`;
                })
                .join('');

            // Calculate Sub-task status report (for horizontal bar chart)
            const subTaskReportData = {};
            const overallData = {
                todo: { count: 0, sp: 0, vsp: 0 },
                inprogress: { count: 0, sp: 0, vsp: 0 },
                blocked: { count: 0, sp: 0, vsp: 0 },
                review: { count: 0, sp: 0, vsp: 0 },
                closed: { count: 0, sp: 0, vsp: 0 },
                totalCount: 0,
                totalSP: 0,
                totalVSP: 0
            };

            (lastDevSubtasks || []).forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                const category = getReportCategory(t.status);

                // Get Story Points for this subtask
                let item = t;
                if (t.fields) item = t.fields;
                let sp = item.storyPoints || item.customfield_10048 || item.customfield_10026 || item.customfield_10016 || item.customfield_10034;
                if (typeof sp !== 'number') sp = parseFloat(sp);
                if (isNaN(sp)) sp = 0;

                // Visual Weight Logic: Assume at least 1 SP for visualization if missing
                const vsp = sp > 0 ? sp : 1;

                // Initialize assignee data if not exists
                if (!subTaskReportData[assignee]) {
                    subTaskReportData[assignee] = {
                        todo: { count: 0, sp: 0, vsp: 0 },
                        inprogress: { count: 0, sp: 0, vsp: 0 },
                        blocked: { count: 0, sp: 0, vsp: 0 },
                        review: { count: 0, sp: 0, vsp: 0 },
                        closed: { count: 0, sp: 0, vsp: 0 },
                        totalCount: 0,
                        totalSP: 0,
                        totalVSP: 0
                    };
                }

                // Update Assignee data
                subTaskReportData[assignee][category].count++;
                subTaskReportData[assignee][category].sp += sp;
                subTaskReportData[assignee][category].vsp += vsp;
                subTaskReportData[assignee].totalCount++;
                subTaskReportData[assignee].totalSP += sp;
                subTaskReportData[assignee].totalVSP += vsp;

                // Update Overall aggregate data
                overallData[category].count++;
                overallData[category].sp += sp;
                overallData[category].vsp += vsp;
                overallData.totalCount++;
                overallData.totalSP += sp;
                overallData.totalVSP += vsp;
            });

            const renderReportRow = (label, data, isOverall = false) => {
                // Denominator is based on Total Visual Story Points (VSP)
                const getWidth = (vsp) => (data.totalVSP > 0 ? (vsp / data.totalVSP) * 100 : 0);
                const formatSP = (val) => val % 1 === 0 ? val : val.toFixed(1);

                // Overall row styling: blue background and a visible bottom border for separation gap
                const rowStyle = isOverall ? ' style="background: rgba(24, 104, 219, 0.08); font-weight: 700; border-bottom: 3px solid #eee;"' : '';

                return `
                    <tr${rowStyle}>
                        <td class="report-assignee" title="${label}">${label}</td>
                        <td class="report-bar-cell">
                            <div class="stacked-bar">
                                ${data.todo.count > 0 ? `<div class="bar-segment seg-todo" style="width: ${getWidth(data.todo.vsp)}%" title="To Do: ${data.todo.count} (SP: ${formatSP(data.todo.sp)})"></div>` : ''}
                                ${data.inprogress.count > 0 ? `<div class="bar-segment seg-inprogress" style="width: ${getWidth(data.inprogress.vsp)}%" title="In Progress: ${data.inprogress.count} (SP: ${formatSP(data.inprogress.sp)})"></div>` : ''}
                                ${data.blocked.count > 0 ? `<div class="bar-segment seg-blocked" style="width: ${getWidth(data.blocked.vsp)}%" title="Blocked: ${data.blocked.count} (SP: ${formatSP(data.blocked.sp)})"></div>` : ''}
                                ${data.review.count > 0 ? `<div class="bar-segment seg-review" style="width: ${getWidth(data.review.vsp)}%" title="Review: ${data.review.count} (SP: ${formatSP(data.review.sp)})"></div>` : ''}
                                ${data.closed.count > 0 ? `<div class="bar-segment seg-closed" style="width: ${getWidth(data.closed.vsp)}%" title="Closed: ${data.closed.count} (SP: ${formatSP(data.closed.sp)})"></div>` : ''}
                            </div>
                        </td>
                        <td class="report-total">${data.totalCount} (${formatSP(data.totalSP)})</td>
                    </tr>
                `;
            };

            const overallRowHtml = overallData.totalCount > 0 ? renderReportRow('Overall', overallData, true) : '';
            const subTaskReportRows = overallRowHtml + Object.entries(subTaskReportData)
                .sort((a, b) => b[1].totalCount - a[1].totalCount)
                .map(([name, data]) => renderReportRow(name, data))
                .join('');

            // Calculate AC status report (ACs Progress)
            const acReportData = {};
            const overallACData = {
                'Backlog': { count: 0, sp: 0, vsp: 0 },
                Dev: { count: 0, sp: 0, vsp: 0 },
                QA: { count: 0, sp: 0, vsp: 0 },
                BA: { count: 0, sp: 0, vsp: 0 },
                Blocked: { count: 0, sp: 0, vsp: 0 },
                Done: { count: 0, sp: 0, vsp: 0 },
                totalCount: 0,
                totalSP: 0,
                totalVSP: 0
            };

            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                const category = getStatusCategory(t.status);

                const sp = typeof t.storyPoints === 'number' ? t.storyPoints : 0;
                const vsp = sp > 0 ? sp : 1;

                if (!acReportData[assignee]) {
                    acReportData[assignee] = {
                        'Backlog': { count: 0, sp: 0, vsp: 0 },
                        Dev: { count: 0, sp: 0, vsp: 0 },
                        QA: { count: 0, sp: 0, vsp: 0 },
                        BA: { count: 0, sp: 0, vsp: 0 },
                        Blocked: { count: 0, sp: 0, vsp: 0 },
                        Done: { count: 0, sp: 0, vsp: 0 },
                        totalCount: 0,
                        totalSP: 0,
                        totalVSP: 0
                    };
                }

                acReportData[assignee][category].count++;
                acReportData[assignee][category].sp += sp;
                acReportData[assignee][category].vsp += vsp;
                acReportData[assignee].totalCount++;
                acReportData[assignee].totalSP += sp;
                acReportData[assignee].totalVSP += vsp;

                overallACData[category].count++;
                overallACData[category].sp += sp;
                overallACData[category].vsp += vsp;
                overallACData.totalCount++;
                overallACData.totalSP += sp;
                overallACData.totalVSP += vsp;
            });

            const renderACReportRow = (label, data, isOverall = false) => {
                const getWidth = (vsp) => (data.totalVSP > 0 ? (vsp / data.totalVSP) * 100 : 0);
                const formatSP = (val) => val % 1 === 0 ? val : val.toFixed(1);
                const rowStyle = isOverall ? ' style="background: rgba(24, 104, 219, 0.08); font-weight: 700; border-bottom: 3px solid #eee;"' : '';

                return `
                    <tr${rowStyle}>
                        <td class="report-assignee" title="${label}">${label}</td>
                        <td class="report-bar-cell">
                            <div class="stacked-bar">
                                ${data['Backlog'].count > 0 ? `<div class="bar-segment seg-todo" style="width: ${getWidth(data['Backlog'].vsp)}%" title="Backlog: ${data['Backlog'].count} (SP: ${formatSP(data['Backlog'].sp)})"></div>` : ''}
                                ${data.Dev.count > 0 ? `<div class="bar-segment seg-dev" style="width: ${getWidth(data.Dev.vsp)}%" title="Dev: ${data.Dev.count} (SP: ${formatSP(data.Dev.sp)})"></div>` : ''}
                                ${data.QA.count > 0 ? `<div class="bar-segment seg-qa" style="width: ${getWidth(data.QA.vsp)}%" title="QA: ${data.QA.count} (SP: ${formatSP(data.QA.sp)})"></div>` : ''}
                                ${data.BA.count > 0 ? `<div class="bar-segment seg-ba" style="width: ${getWidth(data.BA.vsp)}%" title="BA: ${data.BA.count} (SP: ${formatSP(data.BA.sp)})"></div>` : ''}
                                ${data.Blocked.count > 0 ? `<div class="bar-segment seg-blocked" style="width: ${getWidth(data.Blocked.vsp)}%" title="Blocked: ${data.Blocked.count} (SP: ${formatSP(data.Blocked.sp)})"></div>` : ''}
                                ${data.Done.count > 0 ? `<div class="bar-segment seg-done" style="width: ${getWidth(data.Done.vsp)}%" title="Done: ${data.Done.count} (SP: ${formatSP(data.Done.sp)})"></div>` : ''}
                            </div>
                        </td>
                        <td class="report-total">${data.totalCount} (${formatSP(data.totalSP)})</td>
                    </tr>
                `;
            };

            const overallACRowHtml = overallACData.totalCount > 0 ? renderACReportRow('Overall', overallACData, true) : '';
            const acReportRows = overallACRowHtml + Object.entries(acReportData)
                .sort((a, b) => b[1].totalCount - a[1].totalCount)
                .map(([name, data]) => renderACReportRow(name, data))
                .join('');

            // Calculate Sub-task status by category
            const subTaskStatusMap = {};
            (lastDevSubtasks || []).forEach(t => {
                const status = (t.status || 'Unknown').trim();
                subTaskStatusMap[status] = (subTaskStatusMap[status] || 0) + 1;
            });

            const subTaskStatusByCategory = {
                'To Do': [],
                'In Progress': [],
                'Review': [],
                'Closed': [],
                'Blocked': [],
                'Other': []
            };

            const subTaskCatMap = {
                'todo': 'To Do',
                'inprogress': 'In Progress',
                'review': 'Review',
                'closed': 'Closed',
                'blocked': 'Blocked'
            };

            Object.entries(subTaskStatusMap).forEach(([status, count]) => {
                const reportCat = getReportCategory(status);
                const category = subTaskCatMap[reportCat] || 'Other';
                subTaskStatusByCategory[category].push({ status, count });
            });

            // Sort statuses within each category by count (descending)
            Object.keys(subTaskStatusByCategory).forEach(category => {
                subTaskStatusByCategory[category].sort((a, b) => b.count - a.count);
            });

            // Calculate category totals
            const subTaskSectionTotals = {};
            Object.keys(subTaskStatusByCategory).forEach(category => {
                subTaskSectionTotals[category] = subTaskStatusByCategory[category].reduce((sum, { count }) => sum + count, 0);
            });

            // Render sub-task status sections
            const subTaskSectionOrder = ['Other', 'To Do', 'In Progress', 'Blocked', 'Review', 'Closed'];
            const subTaskStatusSections = subTaskSectionOrder.map(category => {
                const statuses = subTaskStatusByCategory[category];
                const sectionTotal = subTaskSectionTotals[category];
                if (sectionTotal === 0 && category === 'Other') return '';

                const sectionPercentage = totalSubTasks > 0 ? ((sectionTotal / totalSubTasks) * 100).toFixed(1) : '0.0';

                const statusItems = statuses.map(({ status, count }) => {
                    const percentage = totalSubTasks > 0 ? ((count / totalSubTasks) * 100).toFixed(1) : '0.0';
                    return `<li><span>${status}</span><span>${count} (${percentage}%)</span></li>`;
                }).join('');

                return `
                    <div class="dash-section">
                        <div class="dash-section-title">
                            <span>${category}</span>
                            <span class="section-count">${sectionTotal} (${sectionPercentage}%)</span>
                        </div>
                        <ul class="dash-list">
                            ${statusItems}
                        </ul>
                    </div>
                `;
            }).filter(section => section !== '').join('');



            // Calculate FR Status counts - dynamically from available FR data
            const frData = aggregateFRData(tickets);
            const frStatusCounts = {
                'Done': 0,
                'Partially Done': 0,
                'Pending': 0
            };
            frData.forEach(fr => {
                const status = fr.frStatus || 'Pending';
                frStatusCounts[status] = (frStatusCounts[status] || 0) + 1;
            });
            const totalFRs = frData.length;
            // Sort statuses: Done first, then Partially Done, then Pending, then others alphabetically
            const statusOrder = ['Pending', 'Partially Done', 'Done'];
            const sortedStatuses = Object.entries(frStatusCounts).sort((a, b) => {
                const indexA = statusOrder.indexOf(a[0]);
                const indexB = statusOrder.indexOf(b[0]);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a[0].localeCompare(b[0]);
            });
            const frStatusList = sortedStatuses
                .map(([status, count]) => {
                    const percentage = totalFRs > 0 ? ((count / totalFRs) * 100).toFixed(1) : '0.0';
                    return `<li><span>${status}</span><span>${count} (${percentage}%)</span></li>`;
                })
                .join('');

            container.innerHTML = `
                <div class="filter-actions">
                    ${getFilterActionsButtons().tabs}
                </div>
                <div class="dash-grid">
                    ${renderSprintDetailsWidget()}
                    <div class="dash-card" id="frStatusWidget">
                        <div class="widget-header">
                            <h3>FR Status</h3>
                            <button class="snapshot-icon" onclick="copyFRStatusWidget(event)" title="Copy widget as image">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="dash-section" style="margin-bottom: 0;">
                            ${totalFRs > 0 ? generatePieChartSVG(
                sortedStatuses.map(([label, value]) => ({ label, value })),
                { 'Pending': '#9e9e9e', 'Partially Done': '#ff9800', 'Done': '#4caf50' },
                totalFRs
            ) : '<div class="empty-state" style="padding: 20px;">No FRs available</div>'}
                        </div>
                    </div>
                    <div class="dash-card">
                        <h3>QA Loop</h3>
                        <ul class="dash-list">
                            ${qaFailedList || '<li><span>0</span><span>0 tickets (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card ${isACStatusExpanded ? '' : 'collapsed'}" id="acStatusWidget">
                        <div class="widget-header">
                            <h3>AC Status</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="snapshot-icon toggle-btn" onclick="toggleACStatusSections()" title="${isACStatusExpanded ? 'Collapse' : 'Expand'}">
                                    ${isACStatusExpanded ?
                    '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>' :
                    '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>'}
                                </button>
                                <button class="snapshot-icon" onclick="copyACStatusWidget(event)" title="Copy widget as image">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                    </svg>
                                </button>
                                <span class="section-count" style="font-weight: 700;">${totalTickets}</span>
                            </div>
                        </div>
                        ${statusSections || '<div class="dash-section"><div class="dash-section-title">Other</div><ul class="dash-list"><li><span>None</span><span>0 (0.0%)</span></li></ul></div>'}
                    </div>
                    <div class="dash-card">
                        <div class="widget-header">
                            <h3>AC Ownership</h3>
                            <span class="section-count" style="font-weight: 700;">${totalTickets}</span>
                        </div>
                        <ul class="dash-list">
                            ${assigneeList || '<li><span>None</span><span>0 (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card">
                        <div class="widget-header">
                            <div>
                                <h3>AC Story Points</h3>
                                <span class="widget-subtitle">1 story point = 4 hours</span>
                            </div>
                            <span class="section-count" style="font-weight: 700;">${totalSP % 1 === 0 ? totalSP : totalSP.toFixed(1)}</span>
                        </div>
                        <ul class="dash-list">
                            ${assigneeSPList || '<li><span>None</span><span>0 (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card ${isSubTaskStatusExpanded ? '' : 'collapsed'}" id="subTaskStatusWidget">
                        <div class="widget-header">
                            <h3>Sub Tasks Status</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="snapshot-icon toggle-btn" onclick="toggleSubTaskStatus()" title="${isSubTaskStatusExpanded ? 'Collapse' : 'Expand'}">
                                    ${isSubTaskStatusExpanded ?
                    '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/></svg>' :
                    '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>'}
                                </button>
                                <button class="snapshot-icon" onclick="copySubTaskStatusWidget(event)" title="Copy widget as image">
                                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                    </svg>
                                </button>
                                <span class="section-count" style="font-weight: 700;">${totalSubTasks}</span>
                            </div>
                        </div>
                        ${isFetchingDevData ? '<div class="dash-section" style="text-align: center; color: #777; padding: 20px;">Loading sub-task status...</div>' : (subTaskStatusSections || '<div class="dash-section"><div class="dash-section-title">Other</div><ul class="dash-list"><li><span>None</span><span>0 (0.0%)</span></li></ul></div>')}
                    </div>
                    <div class="dash-card">
                        <div class="widget-header">
                            <h3>Sub Tasks Assignee</h3>
                            <span class="section-count" style="font-weight: 700;">
                                ${isFetchingDevData ? '<span style="font-size: 12px; font-weight: normal;">Fetching...</span>' : totalSubTasks}
                            </span>
                        </div>
                        <ul class="dash-list">
                            ${isFetchingDevData ? '<li style="justify-content: center; color: #777;">Loading...</li>' : (subTasksCountList || '<li><span>None</span><span>0 (0.0%)</span></li>')}
                        </ul>
                    </div>
                    <div class="dash-card">
                        <div class="widget-header">
                            <div>
                                <h3>Sub Tasks Story Points</h3>
                                <span class="widget-subtitle">1 story point = 4 hours</span>
                            </div>
                            <span class="section-count" style="font-weight: 700;">
                                ${isFetchingDevData ? '<span style="font-size: 12px; font-weight: normal;">Fetching...</span>' : Math.round(totalSubTaskSP * 10) / 10}
                            </span>
                        </div>
                        <ul class="dash-list">
                            ${isFetchingDevData ? '<li style="justify-content: center; color: #777;">Loading...</li>' : (subTasksSPList || '<li><span>None</span><span>0 (0.0%)</span></li>')}
                        </ul>
                    </div>
                    <div class="dash-card wide" id="acReportWidget">
                        <div class="widget-header">
                            <h3>AC Progress</h3>
                        </div>
                        <div class="dash-section" style="margin-bottom: 0;">
                            <table class="report-table">
                                <tbody>
                                    ${acReportRows || '<tr><td colspan="3" style="text-align: center; color: #777; padding: 20px;">No AC available</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="dash-card wide" id="subTaskReportWidget">
                        <div class="widget-header">
                            <h3>Sub Tasks Progress</h3>
                        </div>
                        <div class="dash-section" style="margin-bottom: 0;">
                            <table class="report-table">
                                <tbody>
                                    ${isFetchingDevData ? '<tr><td colspan="3" style="text-align: center; color: #777; padding: 20px;">Loading sub-task data...</td></tr>' : (subTaskReportRows || '<tr><td colspan="3" style="text-align: center; color: #777; padding: 20px;">No sub-tasks available</td></tr>')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSprintDetailsWidget() {
            if (isFetchingSprintData || (!lastSprintDetails && isFetchingDevData)) {
                return `
                    <div class="dash-card">
                        <div class="widget-header">
                            <h3>Sprint Details</h3>
                        </div>
                        <div style="padding: 20px; text-align: center; color: #777;">
                            Data loading...
                        </div>
                    </div>
                `;
            }

            if (!lastSprintDetails) {
                return `
                    <div class="dash-card">
                        <div class="widget-header">
                            <h3>Sprint Details</h3>
                        </div>
                        <div style="padding: 20px; text-align: center; color: #777;">
                            No sprint details available.
                        </div>
                    </div>
                `;
            }

            const sprint = lastSprintDetails;
            const calculateWorkdays = (startDate, endDate) => {
                if (!startDate || !endDate) return 'N/A';
                const start = new Date(startDate);
                const end = new Date(endDate);
                if (isNaN(start.getTime()) || isNaN(end.getTime())) return 'N/A';

                // Normalize to midnight for accurate comparison
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);

                let count = 0;
                let cur = new Date(start.getTime());
                while (cur <= end) {
                    const dayOfWeek = cur.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        count++;
                    }
                    cur.setDate(cur.getDate() + 1);
                }
                return count;
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'N/A';
                }
            };

            return `
                <div class="dash-card">
                    <div class="widget-header">
                        <h3>Sprint Details</h3>
                    </div>
                    <ul class="dash-list">
                        <li><span>Sprint Name</span><span>${sprint.name || 'N/A'}</span></li>
                        <li><span>Status</span><span style="text-transform: capitalize;">${sprint.state || 'N/A'}</span></li>
                        <li><span>Start Date</span><span>${formatDate(sprint.startDate)}</span></li>
                        <li><span>End Date</span><span>${formatDate(sprint.endDate)}</span></li>
                        <li><span>Total Days</span><span>${calculateWorkdays(sprint.startDate, sprint.endDate)}</span></li>
                        ${sprint.state === 'active' ? (() => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const endDate = new Date(sprint.endDate);
                    endDate.setHours(0, 0, 0, 0);

                    const isOverdue = today > endDate;

                    let daysLeft = 0;
                    if (isOverdue) {
                        // For overdue, count workdays between endDate and today (exclusive of endDate itself)
                        // calculateWorkdays is inclusive, so we start from tomorrow of endDate
                        const nextDay = new Date(endDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        daysLeft = calculateWorkdays(nextDay, today);
                    } else {
                        // For active, count workdays between today and endDate
                        daysLeft = calculateWorkdays(today, endDate);
                        // If today is a workday, it is included in daysLeft. 
                        // This matches the user's expectation of 5 days left when today is Saturday (Jan 3)
                        // and the remaining workdays are Mon-Fri (Jan 5-9).
                    }

                    const colorStyle = isOverdue ? ' style="color: #d32f2f; font-weight: bold;"' : '';
                    const label = isOverdue ? 'Overdue' : 'Days Left';
                    const prefix = isOverdue ? '+' : '';

                    return `<li><span>${label}</span><span${colorStyle}>${prefix}${daysLeft}</span></li>`;
                })() : ''}
                        ${sprint.state === 'closed' ? `<li><span>Completion Date</span><span>${formatDate(sprint.completeDate)}</span></li>` : ''}
                    </ul>
                </div>
            `;
        }

        function renderWorklogView(tickets) {
            const container = document.getElementById('ticketsContainer');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            // Calculate worklog data
            const selectedDate = window.selectedWorklogDate || new Date().toISOString().split('T')[0];
            const toDate = window.worklogToDate || selectedDate;
            const useDateRange = window.useWorklogDateRange || false;

            const assigneeTime = {};
            let totalSeconds = 0;

            // Initialize all unique assignees with 0 time
            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                // Ensure we have an entry for every assignee, even if they have no worklogs
                if (assignee && !assigneeTime.hasOwnProperty(assignee)) {
                    assigneeTime[assignee] = 0;
                }
            });

            tickets.forEach(ticket => {
                const worklog = ticket.worklog;
                if (!worklog || !worklog.worklogs || worklog.worklogs.length === 0) return;

                worklog.worklogs.forEach(entry => {
                    const entryDate = entry.started ? entry.started.split('T')[0] : '';
                    const timeSpent = entry.timeSpentSeconds || 0;

                    if (useDateRange) {
                        if (entryDate >= selectedDate && entryDate <= toDate) {
                            const author = entry.author?.displayName || 'Unknown';
                            assigneeTime[author] = (assigneeTime[author] || 0) + timeSpent;
                            totalSeconds += timeSpent;
                        }
                    } else {
                        if (entryDate === selectedDate) {
                            const author = entry.author?.displayName || 'Unknown';
                            assigneeTime[author] = (assigneeTime[author] || 0) + timeSpent;
                            totalSeconds += timeSpent;
                        }
                    }
                });
            });

            const totalFormatted = formatTimeHoursMinutes(totalSeconds);
            const assigneeTimeList = Object.entries(assigneeTime)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const formatted = formatTimeHoursMinutes(v);
                    const safeAssignee = k.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeToDate = (useDateRange && toDate) ? toDate.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
                    const dateRangeParam = useDateRange ? `, '${safeToDate}', true` : `, null, false`;

                    // Apply red color if less than 8 hours AND date range toggle is OFF
                    const EIGHT_HOURS_IN_SECONDS = 8 * 3600;
                    const timeClass = (!useDateRange && v < EIGHT_HOURS_IN_SECONDS) ? 'time-low-hours' : '';

                    return `<li class="clickable" onclick="selectAssigneeForWorklogDetails('${safeAssignee}', '${selectedDate}'${dateRangeParam})"><span>${k}</span><span class="${timeClass}">${formatted}</span></li>`;
                })
                .join('');

            // Render worklog detail widget content
            const worklogDetailWidget = renderWorklogDetailWidget(tickets);

            container.innerHTML = `
                <div class="filter-actions">
                    ${getFilterActionsButtons().tabs}
                </div>
                <div class="dash-grid">
                    <div class="dash-card time-tracking-widget" id="assigneeTimeTrackingWidget">
                        <div class="widget-header">
                            <h3>Assignee Time Tracking</h3>
                            <button class="snapshot-icon" onclick="copyAssigneeTimeTrackingWidget(event)" title="Copy widget as image">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="date-picker-container">
                            <div class="worklog-input-group" style="min-width: auto;">
                                <label class="date-picker-label" for="worklogDatePicker">From Date:</label>
                                <input type="date" id="worklogDatePicker" class="date-picker-input" value="${selectedDate}" onchange="updateWorklogDate(this.value)">
                            </div>
                            <div class="worklog-input-group" style="min-width: auto; justify-content: flex-end;">
                                <label class="date-picker-label" style="visibility: hidden;">Placeholder</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="worklogDateRangeToggle" ${useDateRange ? 'checked' : ''} onchange="updateWorklogDateRangeToggle(this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="font-size: 14px; font-weight: 600; color: #555;">Date Range</span>
                                </div>
                            </div>
                            ${useDateRange ? `
                            <div class="worklog-input-group" style="min-width: auto;">
                                <label class="date-picker-label" for="worklogToDatePicker">To Date:</label>
                                <input type="date" id="worklogToDatePicker" class="date-picker-input" value="${toDate}" onchange="updateWorklogToDate(this.value)">
                            </div>
                            ` : ''}
                        </div>
                        <div class="dash-section">
                            <div class="dash-section-title">
                                <span>Total Time</span>
                                <span class="section-count">${totalFormatted}</span>
                            </div>
                        </div>
                        <ul class="dash-list">
                            ${assigneeTimeList || '<li><span>No time logged</span><span>0m</span></li>'}
                        </ul>
                    </div>
                    ${worklogDetailWidget}
                </div>
            `;
        }

        function renderSprintPlanView(tickets) {
            const container = document.getElementById('ticketsContainer');
            container.innerHTML = `
                <div class="filter-actions">
                    ${getFilterActionsButtons().tabs}
                </div>
                <div class="sprint-plan-container" style="padding: 40px; text-align: center; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;"></div>
                    <h2 style="margin-bottom: 15px; color: #444;">Sprint Plan </h2>
                    <p style="font-style: italic;">This view is in progress. Sarvesh is exploring ideas and will soon introduce a feature designed to help plan sprints and track tasks before the sprint begins.</p>
                </div>
            `;
        }

        // --- DEV VIEW LOGIC ---

        function renderDevView(tickets) {
            const container = document.getElementById('ticketsContainer');

            let content = '';

            if (lastDevSubtasks.length > 0 || (lastTickets && lastTickets.length > 0 && !lastTickets.some(t => t.subtaskKeys && t.subtaskKeys.length > 0))) {
                // Data already loaded OR no subtasks to load
                // We need to delay this slightly to let the container render first if we want to call renderPostResults immediately 
                // but since we are replacing innerHTML, we can just set up the structure and then call renderPostResults
                setTimeout(() => renderPostResults(), 0);
                content = `
                    <div id="devResultsContainer">
                        <!-- Results will be rendered here -->
                    </div>
                 `;
            } else if (isFetchingDevData) {
                content = `
                    <div id="devResultsContainer">
                        <div class="loading-state">Fetching Dev Tickets (Sub-tasks & Linked Bugs)...</div>
                    </div>
                `;
            } else {
                content = `
                    <div style="margin-bottom: 20px;">
                         <button class="primary-btn" onclick="fetchDevTicketsPost()">
                            <span class="btn-icon"></span>Fetch Dev Tickets
                        </button>
                    </div>
                    <div id="devResultsContainer">
                        <div class="empty-state">
                            <p>Click Fetch Dev Tickets to fetch data</p>
                        </div>
                    </div>
                 `;
            }

            const viewActions = getFilterActionsButtons();
            container.innerHTML = `
                <div class="filter-actions" style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    ${viewActions.tabs}
                </div>
                <div class="dev-view-container" style="padding: 20px;">
                    ${content}
                </div>
            `;
        }

        async function fetchDevTicketsPost() {
            const devContainer = document.getElementById('devResultsContainer');
            if (devContainer) {
                devContainer.innerHTML = '<div class="loading-state">Fetching..</div>';
            }
            showLoading(true);

            try {
                await fetchDevDataOnly();
                renderPostResults();
            } catch (error) {
                console.error("Dev POST Error:", error);
                if (devContainer) {
                    devContainer.innerHTML = `<div class="error-msg">Error: ${error.message}</div>`;
                }
            } finally {
                showLoading(false);
            }
        }

        async function fetchDevDataOnly() {
            // Extract subtask keys from currently loaded tickets
            if (!lastTickets || lastTickets.length === 0) {
                return;
            }

            const keys = lastTickets.flatMap(t => t.subtaskKeys || []);

            if (keys.length === 0) {
                // If no subtasks, just clear subtasks
                lastDevSubtasks = [];
                // But still initialize assignee filters from main tickets
                const initialAssigneeSet = new Set();
                (lastTickets || []).forEach(t => {
                    initialAssigneeSet.add(t.assignee || 'Unassigned');
                    (t.linkedBugs || []).forEach(b => initialAssigneeSet.add(b.assignee || 'Unassigned'));
                });
                devAssigneeFilters = Array.from(initialAssigneeSet);
                return;
            }

            isFetchingDevData = true;
            isFetchingSprintData = true;

            // Trigger dashboard update to show loading state in the widget
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            }

            try {
                // Construct URL (using centralized SCRIPT_URL)
                const email = savedEmail || document.getElementById('emailInput')?.value;
                const apiToken = savedApiToken || document.getElementById('tokenInput')?.value;

                if (!email || !apiToken) {
                    throw new Error("Missing credentials. Please ensure you are logged in.");
                }

                // Parent and Sprint info for GET requests
                const currentModule = modules[activeModule];
                const parent = currentModule.emId;
                const sprintId = currentModule.sprintId;

                // Construct concurrent requests
                const subtaskUrl = `${SCRIPT_URL}?email=${encodeURIComponent(email)}&apiToken=${encodeURIComponent(apiToken)}&requestType=post_search`;
                const subtaskPayload = {
                    requestType: 'post_search',
                    email: email,
                    apiToken: apiToken,
                    keys: keys,
                    fields: ['summary', 'status', 'assignee', 'storyPoints', 'customfield_10048', 'customfield_10026', 'customfield_10016', 'customfield_10034', 'issuetype', 'parent', 'priority']
                };

                const bugsUrl = `${SCRIPT_URL}?email=${encodeURIComponent(email)}&apiToken=${encodeURIComponent(apiToken)}&requestType=fetch_bugs&parent=${encodeURIComponent(parent)}&sprintId=${encodeURIComponent(sprintId)}&maxResults=500`;
                const bugsPayload = {
                    requestType: 'fetch_bugs',
                    email: email,
                    apiToken: apiToken,
                    parent: parent,
                    sprintId: sprintId
                };

                const sprintUrl = `${SCRIPT_URL}?email=${encodeURIComponent(email)}&apiToken=${encodeURIComponent(apiToken)}&requestType=sprint_details&sprintId=${encodeURIComponent(sprintId)}`;
                const sprintPayload = {
                    requestType: 'sprint_details',
                    email: email,
                    apiToken: apiToken,
                    sprintId: sprintId
                };

                const [subtaskResp, bugsResp, sprintResp] = await Promise.all([
                    fetch(subtaskUrl, { method: 'POST', body: JSON.stringify(subtaskPayload) }),
                    fetch(bugsUrl, { method: 'POST', body: JSON.stringify(bugsPayload) }),
                    fetch(sprintUrl, { method: 'POST', body: JSON.stringify(sprintPayload) })
                ]);

                const subtaskData = await subtaskResp.json();
                const bugsData = await bugsResp.json();
                const sprintData = await sprintResp.json();

                if (!subtaskData.success) {
                    throw new Error(subtaskData.error || 'Subtask fetch failed');
                }
                if (!bugsData.success) {
                    console.warn("Bugs detailed fetch failed:", bugsData.error);
                }
                if (sprintData.success) {
                    lastSprintDetails = sprintData.sprint;
                } else {
                    console.warn("Sprint details fetch failed:", sprintData.error);
                }

                // Store data
                lastDevSubtasks = subtaskData.tickets || [];
                lastDevBugsDetailed = bugsData.tickets || [];



                // key: Initialize filters with all assignees and statuses from parents AND fetched subtasks (and their bugs)
                const initialAssigneeSet = new Set();
                const initialStatusSet = new Set();

                (lastTickets || []).forEach(t => {
                    initialAssigneeSet.add(t.assignee || 'Unassigned');
                    initialStatusSet.add(t.status);
                    (t.linkedBugs || []).forEach(b => {
                        // Supplement linked bug with detailed info if available
                        const bugDetail = lastDevBugsDetailed.find(bd => bd.key === b.key);
                        if (bugDetail) {
                            b.assignee = bugDetail.assignee;
                            b.dueDate = bugDetail.dueDate;
                        }
                        initialAssigneeSet.add(b.assignee || 'Unassigned');
                        initialStatusSet.add(b.status);
                    });
                });
                (lastDevSubtasks || []).forEach(t => {
                    initialAssigneeSet.add(t.assignee || 'Unassigned');
                    initialStatusSet.add(t.status);
                    (t.linkedBugs || []).forEach(b => {
                        // Supplement linked bug with detailed info if available
                        const bugDetail = lastDevBugsDetailed.find(bd => bd.key === b.key);
                        if (bugDetail) {
                            b.assignee = bugDetail.assignee;
                            b.dueDate = bugDetail.dueDate;
                        }
                        initialAssigneeSet.add(b.assignee || 'Unassigned');
                        initialStatusSet.add(b.status);
                    });
                });

                devAssigneeFilters = Array.from(initialAssigneeSet); // Select all by default
                devStatusFilters = Array.from(initialStatusSet); // Select all by default

            } finally {
                isFetchingDevData = false;
                isFetchingSprintData = false;
                // If currently in Dev View, we should re-render or at least remove loading state
                if (viewMode === 'dev') {
                    // We can try to render results if container exists
                    if (document.getElementById('devResultsContainer')) {
                        renderPostResults();
                    }
                } else if (viewMode === 'dashboard') {
                    // Update dashboard if we're on it, to show subtask stats
                    renderDashboard(lastTickets);
                }
            }
        }

        function renderPostResults() {
            const devContainer = document.getElementById('devResultsContainer');

            // Consolidate only bugs that are linked to stories (or their sub-tasks) of this sprint
            const bugMap = new Map();
            const storyKeys = new Set((lastTickets || []).map(t => t.key));

            // 1. Collect from Stories (both issuelinks and parent/child relation)
            (lastTickets || []).forEach(p => {
                // Issuelinks
                (p.linkedBugs || []).forEach(b => {
                    const detail = (lastDevBugsDetailed || []).find(d => d.key === b.key);
                    bugMap.set(b.key, detail || b);
                });
            });

            // 2. Collect from Sub-tasks (issuelinks)
            (lastDevSubtasks || []).forEach(st => {
                (st.linkedBugs || []).forEach(b => {
                    const detail = (lastDevBugsDetailed || []).find(d => d.key === b.key);
                    bugMap.set(b.key, detail || b);
                });
            });

            // 3. Collect from Detailed list (parent relation - bugs that are children of stories)
            (lastDevBugsDetailed || []).forEach(b => {
                if (b.parentKey && storyKeys.has(b.parentKey)) {
                    if (!bugMap.has(b.key)) bugMap.set(b.key, b);
                }
            });

            const allPossibleBugs = Array.from(bugMap.values());

            // Create global maps for expansion context (all children, unfiltered)
            const subtaskMapByParent = {};
            (lastDevSubtasks || []).forEach(st => {
                const pk = st.parentKey || (st.parent ? st.parent.key : null);
                if (pk) {
                    if (!subtaskMapByParent[pk]) subtaskMapByParent[pk] = [];
                    if (!subtaskMapByParent[pk].some(x => x.key === st.key)) {
                        subtaskMapByParent[pk].push(st);
                    }
                }
            });

            const bugMapByParent = {};
            allPossibleBugs.forEach(b => {
                const parents = b.parentKeys || (b.parentKey ? [b.parentKey] : (b.parent ? [b.parent.key] : []));
                parents.forEach(pk => {
                    if (pk) {
                        if (!bugMapByParent[pk]) bugMapByParent[pk] = [];
                        if (!bugMapByParent[pk].some(x => x.key === b.key)) {
                            bugMapByParent[pk].push(b);
                        }
                    }
                });
            });

            if ((!lastTickets || lastTickets.length === 0) && (!lastDevSubtasks || lastDevSubtasks.length === 0) && (allPossibleBugs.length === 0)) {
                devContainer.innerHTML = '<div class="empty-state">No results returned.</div>';
                return;
            }

            // Get available assignees/statuses for dropdowns
            const assigneeSet = new Set();
            const statusSet = new Set();

            [...(lastTickets || []), ...(lastDevSubtasks || []), ...allPossibleBugs].forEach(t => {
                assigneeSet.add(t.assignee || 'Unassigned');
                statusSet.add(t.status);
            });

            const allAssignees = Array.from(assigneeSet).sort((a, b) => a.localeCompare(b));
            const allAssigneesSelected = devAssigneeFilters.length === allAssignees.length;
            const allStatuses = Array.from(statusSet).sort((a, b) => a.localeCompare(b));
            const allStatusesSelected = devStatusFilters.length === allStatuses.length;
            const allTypes = ['Story', 'Sub Task', 'Bug'];
            const allTypesSelected = devTypeFilter.length === allTypes.length;

            // Calculate Weeks
            const weekSet = new Set();
            [...(lastTickets || []), ...(lastDevSubtasks || []), ...allPossibleBugs].forEach(t => {
                const label = getWeekRangeLabel(t.dueDate);
                weekSet.add(label);
            });
            // Convert to array and sort strictly by date
            const allWeeks = Array.from(weekSet).sort((a, b) => {
                if (a === 'No due dates') return 1;
                if (b === 'No due dates') return -1;

                // Parse dates from label "Dec 22 to Dec 28"
                // Can cheat by creating a temporary bucket-like structure or just parsing
                // Helper to parse start date
                const getStartDate = (lbl) => {
                    try {
                        // "Mon DD to Mon DD"
                        const parts = lbl.split(' to ');
                        if (parts.length > 0) {
                            return new Date(parts[0] + ', ' + new Date().getFullYear()); // Append current year for sort context? 
                            // Note: getWeekRangeLabel uses 'short' month. 'Dec 22'.
                            // Warning: Year boundary issues.
                            // Better approach: Find a ticket with this label and use its due date?
                            // Or utilize the sorting logic used for buckets later.
                        }
                    } catch (e) { }
                    return new Date();
                };

                // More robust: find one ticket for each label to get a real date
                // But efficient way:
                // Let's use the buckets logic later? No, we need it sorted for dropdown
                return 0; // Temporary, reliance on buckets sorting might be safer or do proper parsing
            });

            // Re-sort allWeeks based on actual dates using a sample ticket or parsing
            const weekDateMap = {};
            [...(lastTickets || []), ...(lastDevSubtasks || []), ...allPossibleBugs].forEach(t => {
                const label = getWeekRangeLabel(t.dueDate);
                if (!weekDateMap[label]) {
                    weekDateMap[label] = t.dueDate ? new Date(t.dueDate) : null;
                }
            });

            allWeeks.sort((a, b) => {
                if (a === 'No due dates') return 1;
                if (b === 'No due dates') return -1;
                const da = weekDateMap[a] || new Date(8640000000000000);
                const db = weekDateMap[b] || new Date(8640000000000000);
                return da - db;
            });

            // Initialize week filter if empty
            // Initialize week filter if null (first load)
            if (devWeekFilter === null) {
                devWeekFilter = [...allWeeks];
            }
            const allWeeksSelected = devWeekFilter.length === allWeeks.length;

            // Generate Header HTML
            const weekDropdownHtml = `
                <div class="dev-filter-container" style="display:inline-block;">
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-devWeek" onclick="toggleDropdown('devWeek', event)">
                            Week: ${allWeeksSelected ? 'All' : devWeekFilter.length + ' selected'} <span class="caret"></span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-devWeek">
                            <label class="dd-option" onclick="toggleDevWeekAll(event)">
                                <input type="checkbox" ${allWeeksSelected ? 'checked' : ''}>
                                <span>(Select All)</span>
                            </label>
                            ${allWeeks.map(week => `
                                <label class="dd-option" onclick="toggleDevWeek('${week}', event)">
                                    <input type="checkbox" ${devWeekFilter.includes(week) ? 'checked' : ''}>
                                    <span>${week}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            const typeDropdownHtml = `
                <div class="dev-filter-container" style="display:inline-block; margin-left: 10px;">
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-devType" onclick="toggleDropdown('devType', event)">
                            Type: ${allTypesSelected ? 'All' : devTypeFilter.length + ' selected'} <span class="caret"></span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-devType">
                            <label class="dd-option" onclick="toggleDevTypeAll(event)">
                                <input type="checkbox" ${allTypesSelected ? 'checked' : ''}>
                                <span>(Select All)</span>
                            </label>
                            ${allTypes.map(type => `
                                <label class="dd-option" onclick="toggleDevType('${type}', event)">
                                    <input type="checkbox" ${devTypeFilter.includes(type) ? 'checked' : ''}>
                                    <span>${type}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            const assigneeDropdownHtml = `
                <div class="dev-filter-container" style="display:inline-block; margin-left: 10px;">
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-devAssignee" onclick="toggleDropdown('devAssignee', event)">
                            Assignee: ${allAssigneesSelected ? 'All' : devAssigneeFilters.length + ' selected'} <span class="caret"></span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-devAssignee">
                            <!-- Select All Option -->
                            <label class="dd-option" onclick="toggleDevAssigneeAll(event)">
                                <input type="checkbox" ${allAssigneesSelected ? 'checked' : ''}>
                                <span>(Select All)</span>
                            </label>
                            ${allAssignees.map(val => `
                                <label class="dd-option" onclick="toggleDevAssignee('${val}', event)">
                                    <input type="checkbox" ${devAssigneeFilters.includes(val) ? 'checked' : ''}>
                                    <span>${val}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            // Dropdown HTML for Status
            const statusDropdownHtml = `
                <div class="dev-filter-container" style="display:inline-block; margin-left: 10px;">
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-devStatus" onclick="toggleDropdown('devStatus', event)">
                            Status: ${allStatusesSelected ? 'All' : devStatusFilters.length + ' selected'} <span class="caret"></span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-devStatus">
                            <label class="dd-option" onclick="toggleDevStatusAll(event)">
                                <input type="checkbox" ${allStatusesSelected ? 'checked' : ''}>
                                <span>(Select All)</span>
                            </label>
                            ${allStatuses.map(status => `
                                <label class="dd-option" onclick="toggleDevStatus('${status}', event)">
                                    <input type="checkbox" ${devStatusFilters.includes(status) ? 'checked' : ''}>
                                    <span>${status}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            const clearFilterBtnHtml = `
                <button class="clear-btn" type="button" style="margin-left: 15px; background: #fff; border: 1px solid #d0d0d0; color: #666; font-size: 13px; font-weight: 500;" onclick="resetDevViewFilters()">
                    Clear Filters
                </button>
            `;

            // --- Sub-task Status Widget Logic ---
            const subTaskStats = {};
            let totalSubTasksForWidget = 0;

            // Filter logic for widget: Respect Assignee and Week, Ignore Type and Status
            const processForWidget = (list) => {
                if (!list) return;
                list.forEach(t => {
                    // Only consider Sub Tasks
                    if (t.type !== 'Sub Task' && !t.subtaskKeys) { // Check if it's a subtask (or has type if we added it)
                        // Wait, in lastDevSubtasks, do we have 'type'? 
                        // No, we usually map it. Let's look at how we get 'type' in render buckets.
                        // render buckets uses 'lastDevSubtasks' and passes 'Sub Task'.
                        // So here we iterate lastDevSubtasks specifically.
                    }
                });
            };

            // , we should iterate specifically over subtasks
            const subTaskAggregate = {
                todo: 0,
                inprogress: 0,
                blocked: 0,
                review: 0,
                closed: 0,
                total: 0
            };

            (lastDevSubtasks || []).forEach(st => {
                // 1. Check Assignee Filter
                const assignee = st.assignee || 'Unassigned';
                if (!devAssigneeFilters.includes(assignee)) return;

                // 2. Check Week Filter
                const weekLabel = getWeekRangeLabel(st.dueDate);
                if (!devWeekFilter.includes(weekLabel)) return;

                // If passes, aggregate status
                const category = getReportCategory(st.status);
                subTaskAggregate[category]++;
                subTaskAggregate.total++;
            });

            // Generate Widget HTML
            const getWidth = (count) => (subTaskAggregate.total > 0 ? (count / subTaskAggregate.total) * 100 : 0);
            let widgetHtml = '';
            if (subTaskAggregate.total > 0) {
                widgetHtml = `
                    <div class="dash-card subtask-status-widget" style="margin-top: 15px; margin-bottom: 20px;">
                        <div class="widget-header">
                            <h3>Sub Tasks in View</h3>
                            <span class="section-count" style="font-weight: 700;">${subTaskAggregate.total}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <div class="stacked-bar">
                                ${subTaskAggregate.todo > 0 ? `<div class="bar-segment seg-todo" style="width: ${getWidth(subTaskAggregate.todo)}%" title="ToDo: ${subTaskAggregate.todo}"></div>` : ''}
                                ${subTaskAggregate.inprogress > 0 ? `<div class="bar-segment seg-inprogress" style="width: ${getWidth(subTaskAggregate.inprogress)}%" title="In Progress: ${subTaskAggregate.inprogress}"></div>` : ''}
                                ${subTaskAggregate.blocked > 0 ? `<div class="bar-segment seg-blocked" style="width: ${getWidth(subTaskAggregate.blocked)}%" title="Blocked: ${subTaskAggregate.blocked}"></div>` : ''}
                                ${subTaskAggregate.review > 0 ? `<div class="bar-segment seg-review" style="width: ${getWidth(subTaskAggregate.review)}%" title="Review: ${subTaskAggregate.review}"></div>` : ''}
                                ${subTaskAggregate.closed > 0 ? `<div class="bar-segment seg-closed" style="width: ${getWidth(subTaskAggregate.closed)}%" title="Closed: ${subTaskAggregate.closed}"></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                widgetHtml = `
                    <div class="dash-card subtask-status-widget" style="margin-top: 15px; margin-bottom: 20px;">
                        <div class="widget-header">
                            <h3>Sub Tasks Status</h3>
                            <span class="section-count" style="font-weight: 700;">0</span>
                        </div>
                        <div style="padding: 10px 0; color: #666; font-style: italic; font-size: 14px;">
                            No sub-tasks found for selected options.
                        </div>
                    </div>
                `;
            }

            devContainer.innerHTML = `
                <div class="post-results-header" style="margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; align-items: center; flex-wrap: wrap;">
                            ${weekDropdownHtml}
                            ${assigneeDropdownHtml}
                            ${typeDropdownHtml}
                            ${statusDropdownHtml}
                            ${clearFilterBtnHtml}
                            <div class="expand-collapse-controls" style="margin-left: 15px; display: flex; align-items: center;">
                                <button class="text-btn" onclick="expandAllDevStories()">Expand All</button>
                                <span class="separator">|</span>
                                <button class="text-btn" onclick="collapseAllDevStories()">Collapse All</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    ${widgetHtml}
                </div>
                <div id="devTicketsList"></div>
            `;

            const ticketsList = document.getElementById('devTicketsList');
            const buckets = {};

            // Helper to add entity to bucket
            const addToBucket = (ticket, type) => {
                if (!devTypeFilter.includes(type)) return;
                if (!devAssigneeFilters.includes(ticket.assignee || 'Unassigned')) return;
                if (!devStatusFilters.includes(ticket.status)) return;

                const label = getWeekRangeLabel(ticket.dueDate);
                if (!buckets[label]) buckets[label] = [];
                buckets[label].push({
                    type: type,
                    data: ticket,
                    dueDateObj: ticket.dueDate ? new Date(ticket.dueDate) : null
                });
            };

            // Process all
            (lastTickets || []).forEach(t => addToBucket(t, 'Story'));
            (lastDevSubtasks || []).forEach(t => addToBucket(t, 'Sub Task'));
            allPossibleBugs.forEach(t => addToBucket(t, 'Bug'));

            // Sort buckets
            const sortedLabels = Object.keys(buckets).sort((a, b) => {
                if (a === 'No due dates') return 1;
                if (b === 'No due dates') return -1;
                const da = buckets[a][0].dueDateObj || new Date(8640000000000000);
                const db = buckets[b][0].dueDateObj || new Date(8640000000000000);
                return da - db;
            }).filter(label => devWeekFilter.includes(label));

            let html = '';
            if (sortedLabels.length === 0) {
                html = '<div class="empty-state">No tickets found matching filters.</div>';
            } else {
                sortedLabels.forEach(label => {
                    // Check if this week is in the past
                    let isWeekOverdue = false;
                    if (label !== 'No due dates' && buckets[label].length > 0) {
                        const firstItemDate = buckets[label][0].dueDateObj;
                        if (firstItemDate) {
                            const monday = getMonday(firstItemDate);
                            const sunday = new Date(monday);
                            sunday.setDate(monday.getDate() + 6);
                            sunday.setHours(23, 59, 59, 999);
                            if (sunday < new Date()) {
                                isWeekOverdue = true;
                                // If all items in this overdue week are Done, do not show red header
                                const doneStatuses = ['done', 'closed', 'resolved', 'not a defect', 'descoped'];
                                const allDone = buckets[label].every(item => {
                                    const status = (item.data.status || '').toLowerCase().trim();
                                    return doneStatuses.includes(status);
                                });
                                if (allDone) {
                                    isWeekOverdue = false;
                                }
                            }
                        }
                    }

                    const headerColor = isWeekOverdue ? '#d32f2f' : '#1868DB';
                    const headerIcon = isWeekOverdue ? '' : '';

                    html += `
                        <div class="week-section" style="margin-top: 30px;">
                            <h3 class="week-header" style="background: #f8f9fa; padding: 10px 15px; border-left: 4px solid ${headerColor}; color: ${headerColor}; font-size: 16px; font-weight: 700; border-radius: 4px; display: flex; align-items: center; margin-bottom: 15px;">
                                <span style="margin-right: 10px;">${headerIcon}</span> ${label}
                                <span style="margin-left: auto; font-size: 13px; font-weight: 400; color: #666;">${buckets[label].length} items</span>
                            </h3>
                            <div class="week-content" style="padding-left: 0;">
                                <table class="tickets-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;"></th>
                                            <th style="width: 150px;">Key</th>
                                            <th>Summary</th>
                                            <th style="width: 150px;">Status</th>
                                            <th style="width: 150px;">Assignee</th>
                                            <th style="width: 120px;">Due Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${buckets[label].map(item => {
                        const t = item.data;
                        const rawDue = t.dueDate ? formatDueDate(t.dueDate) : '-';
                        const due = rawDue.startsWith('+ ') ? rawDue.substring(2) : rawDue;
                        const skippedHighlightStatuses = ['done', 'closed', 'not a defect', 'descoped'];
                        const statusLower = (t.status || '').toLowerCase().trim();
                        const overdueClass = (rawDue.startsWith('+ ') && !skippedHighlightStatuses.includes(statusLower)) ? 'due-date-overdue' : '';
                        const rowClass = item.type === 'Story' ? 'dev-story-row clickable' : (item.type === 'Sub Task' ? 'dev-subtask-row' : 'dev-bug-row');
                        const isStory = item.type === 'Story';

                        // Handle Story Expansion Context
                        // Combine data from maps (detailed fetch) and ticket properties (fallback context)
                        const mapSubtasks = (isStory && subtaskMapByParent[t.key]) ? subtaskMapByParent[t.key] : [];
                        const ticketSubtasks = (isStory && t.subtasks) ? t.subtasks : [];

                        // Merge uniquely by key
                        const storySubtasks = [...mapSubtasks];
                        ticketSubtasks.forEach(st => {
                            if (!storySubtasks.some(x => x.key === st.key)) storySubtasks.push(st);
                        });

                        const mapBugs = (isStory && bugMapByParent[t.key]) ? bugMapByParent[t.key] : [];
                        const ticketBugs = (isStory && t.linkedBugs) ? t.linkedBugs : [];

                        const storyBugs = [...mapBugs];
                        ticketBugs.forEach(b => {
                            if (!storyBugs.some(x => x.key === b.key)) storyBugs.push(b);
                        });

                        const hasChildren = storySubtasks.length > 0 || storyBugs.length > 0 || (isStory && (t.subtaskKeys && t.subtaskKeys.length > 0));
                        const expandAttr = isStory ? `onclick="toggleStoryExpansion('${t.key.replace(/[^a-zA-Z0-9]/g, '-')}')"` : '';
                        const caretHtml = (isStory && hasChildren) ? `<span class="caret-icon" id="caret-${t.key.replace(/[^a-zA-Z0-9]/g, '-')}"></span>` : '';

                        // Helper for icons
                        const getDevTypeIcon = (type) => {
                            if (type === 'Bug') return `<svg viewBox="0 0 24 24" width="14" height="14" stroke="red" stroke-width="2" fill="none" style="margin-right: 6px; vertical-align: middle;"><path d="m8 2 1.88 1.88M14.12 3.88 16 2M9 7.13v-1a3.003 3.003 0 1 1 6 0v1M12 20c-3.31 0-6-2.69-6-6 0-1 0-4 6-4s6 3 6 4c0 3.31-2.69 6-6 6ZM12 10v10M6 13H4M20 13h-2M6.71 18.29 5.3 19.7M18.7 19.7l-1.41-1.41"/></svg>`;
                            if (type === 'Story') return `<svg viewBox="0 0 24 24" width="14" height="14" stroke="green" stroke-width="2" fill="none" style="margin-right: 6px; vertical-align: middle;"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>`;
                            // DNA symbol for Sub Task
                            return `<svg viewBox="0 0 24 24" width="14" height="14" stroke="#1868DB" stroke-width="2" fill="none" style="margin-right: 6px; vertical-align: middle;"><path d="m8 3 .1.1c.3.3.6.8.9 1.4.3.6.6 1.2.9 1.9.3.7.6 1.5.8 2.3.2.8.3 1.6.4 2.3 0 .7 0 1.4-.1 2-.1.6-.2 1.1-.3 1.5-.1.4-.3.7-.4 1-.1.3-.2.5-.3.6l-.1.1M16 3l-.1.1c-.3.3-.6.8-.9 1.4-.3.6-.6 1.2-.9 1.9-.3.7-.6 1.5-.8 2.3-.2.8-.3 1.6-.4 2.3 0 .7 0 1.4.1 2 .1.6.2 1.1.3 1.5.1.4.3.7.4 1 .1.3.2.5.3.6l.1.1M8 10h8M8 14h8"/></svg>`;
                        };

                        let rowHtml = `
                                                <tr class="${rowClass}" ${expandAttr}>
                                                    <td style="text-align: center;">${caretHtml}</td>
                                                    <td style="white-space: nowrap; font-size: 13px;">
                                                        <span style="display: flex; align-items: center;">
                                                            ${getDevTypeIcon(item.type)}
                                                            <a href="${JIRA_BASE_URL}${t.key}" target="_blank" class="ticket-link" onclick="event.stopPropagation()">${t.key}</a>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div style="font-weight: 500;">${t.summary}</div>
                                                    </td>
                                                    <td><span class="ticket-status">${t.status}</span></td>
                                                    <td>${t.assignee || 'Unassigned'}</td>
                                                    <td class="${overdueClass}">${due}</td>
                                                </tr>
                                            `;

                        if (isStory && hasChildren) {
                            rowHtml += `
                                                    <tr id="expansion-${t.key.replace(/[^a-zA-Z0-9]/g, '-')}" class="expansion-row" style="display: none; background: #fafafa;">
                                                        <td colspan="7" style="padding: 15px 30px;">
                                                            <div style="border-left: 3px solid #ccc; padding-left: 20px;">
                                                                <h4 style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">Related Items for ${t.key}</h4>
                                                                <table class="tickets-table" style="width: 100%; font-size: 13px; background: #fff;">
                                                                    <thead>
                                                                        <tr style="background: #f0f0f0;">
                                                                            <th style="width: 150px;">Key</th>
                                                                            <th>Summary</th>
                                                                            <th style="width: 150px;">Status</th>
                                                                            <th style="width: 150px;">Assignee</th>
                                                                            <th style="width: 120px;">Due Date</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        ${storySubtasks.map(st => `
                                                                            <tr class="dev-subtask-row">
                                                                                <td>
                                                                                    <span style="display: flex; align-items: center;">
                                                                                        ${getDevTypeIcon('Sub Task')}
                                                                                        <a href="${JIRA_BASE_URL}${st.key}" target="_blank" class="ticket-link">${st.key}</a>
                                                                                    </span>
                                                                                </td>
                                                                                <td>${st.summary}</td>
                                                                                <td><span class="ticket-status">${st.status}</span></td>
                                                                                <td>${st.assignee || 'Unassigned'}</td>
                                                                                <td>
                                                                                    ${(() => {
                                    const rd = st.dueDate ? formatDueDate(st.dueDate) : '-';
                                    const d = rd.startsWith('+ ') ? rd.substring(2) : rd;
                                    const skippedHighlightStatuses = ['done', 'closed', 'not a defect', 'descoped'];
                                    const statusLower = (st.status || '').toLowerCase().trim();
                                    const oc = (rd.startsWith('+ ') && !skippedHighlightStatuses.includes(statusLower)) ? 'due-date-overdue' : '';
                                    return `<span class="${oc}">${d}</span>`;
                                })()}
                                                                                </td>
                                                                            </tr>
                                                                        `).join('')}
                                                                        ${storyBugs.map(b => `
                                                                            <tr class="dev-bug-row">
                                                                                <td>
                                                                                    <span style="display: flex; align-items: center;">
                                                                                        ${getDevTypeIcon('Bug')}
                                                                                        <a href="${JIRA_BASE_URL}${b.key}" target="_blank" class="ticket-link">${b.key}</a>
                                                                                    </span>
                                                                                </td>
                                                                                <td>${b.summary}</td>
                                                                                <td><span class="ticket-status">${b.status}</span></td>
                                                                                <td>${b.assignee || 'Unassigned'}</td>
                                                                                <td>
                                                                                    ${(() => {
                                        const rd = b.dueDate ? formatDueDate(b.dueDate) : '-';
                                        const d = rd.startsWith('+ ') ? rd.substring(2) : rd;
                                        const skippedHighlightStatuses = ['done', 'closed', 'not a defect', 'descoped'];
                                        const statusLower = (b.status || '').toLowerCase().trim();
                                        const oc = (rd.startsWith('+ ') && !skippedHighlightStatuses.includes(statusLower)) ? 'due-date-overdue' : '';
                                        return `<span class="${oc}">${d}</span>`;
                                    })()}
                                                                                </td>
                                                                            </tr>
                                                                        `).join('')}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                        }
                        return rowHtml;
                    }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }
            ticketsList.innerHTML = html;
        }

        function toggleStoryExpansion(key) {
            const row = document.getElementById(`expansion-${key}`);
            const caret = document.getElementById(`caret-${key}`);
            if (row) {
                if (row.style.display === 'none') {
                    row.style.display = 'table-row';
                    if (caret) caret.classList.add('open');
                } else {
                    row.style.display = 'none';
                    if (caret) caret.classList.remove('open');
                }
            }
        }

        function expandAllDevStories() {
            document.querySelectorAll('.expansion-row').forEach(row => {
                row.style.display = 'table-row';
            });
            document.querySelectorAll('.caret-icon').forEach(caret => {
                caret.classList.add('open');
            });
        }

        function collapseAllDevStories() {
            document.querySelectorAll('.expansion-row').forEach(row => {
                row.style.display = 'none';
            });
            document.querySelectorAll('.caret-icon').forEach(caret => {
                caret.classList.remove('open');
            });
        }

        function toggleDevType(val, evt) {
            if (evt) evt.stopPropagation();
            const index = devTypeFilter.indexOf(val);
            if (index === -1) {
                devTypeFilter.push(val);
            } else {
                devTypeFilter.splice(index, 1);
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devType');
                if (dd) dd.classList.add('open');
                openDropdown = 'devType';
            }, 0);
        }

        function toggleDevTypeAll(evt) {
            if (evt) evt.stopPropagation();
            const allTypes = ['Story', 'Sub Task', 'Bug'];
            if (devTypeFilter.length === allTypes.length) {
                devTypeFilter = [];
            } else {
                devTypeFilter = [...allTypes];
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devType');
                if (dd) dd.classList.add('open');
                openDropdown = 'devType';
            }, 0);
        }

        function toggleDevAssignee(val, evt) {
            if (evt) evt.stopPropagation();
            const index = devAssigneeFilters.indexOf(val);
            if (index === -1) {
                devAssigneeFilters.push(val);
            } else {
                devAssigneeFilters.splice(index, 1);
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devAssignee');
                if (dd) dd.classList.add('open');
                openDropdown = 'devAssignee';
            }, 0);
        }

        function toggleDevAssigneeAll(evt) {
            if (evt) evt.stopPropagation();

            // Re-calculate all assignees
            const assigneeSet = new Set();
            (lastTickets || []).forEach(t => assigneeSet.add(t.assignee || 'Unassigned'));
            (lastDevSubtasks || []).forEach(t => assigneeSet.add(t.assignee || 'Unassigned'));
            const allAssignees = Array.from(assigneeSet);

            if (devAssigneeFilters.length === allAssignees.length) {
                devAssigneeFilters = [];
            } else {
                devAssigneeFilters = [...allAssignees];
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devAssignee');
                if (dd) dd.classList.add('open');
                openDropdown = 'devAssignee';
            }, 0);
        }
        function toggleDevStatus(val, evt) {
            if (evt) evt.stopPropagation();
            const index = devStatusFilters.indexOf(val);
            if (index === -1) {
                devStatusFilters.push(val);
            } else {
                devStatusFilters.splice(index, 1);
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devStatus');
                if (dd) dd.classList.add('open');
                openDropdown = 'devStatus';
            }, 0);
        }

        function toggleDevStatusAll(evt) {
            if (evt) evt.stopPropagation();

            // Re-calculate all status values
            const statusSet = new Set();
            (lastTickets || []).forEach(t => {
                statusSet.add(t.status);
                (t.linkedBugs || []).forEach(b => statusSet.add(b.status));
            });
            (lastDevSubtasks || []).forEach(t => {
                statusSet.add(t.status);
                (t.linkedBugs || []).forEach(b => statusSet.add(b.status));
            });
            const allStatuses = Array.from(statusSet);

            if (devStatusFilters.length === allStatuses.length) {
                devStatusFilters = [];
            } else {
                devStatusFilters = [...allStatuses];
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devStatus');
                if (dd) dd.classList.add('open');
                openDropdown = 'devStatus';
            }, 0);
        }

        function toggleDevWeek(val, evt) {
            if (evt) evt.stopPropagation();
            const index = devWeekFilter.indexOf(val);
            if (index === -1) {
                devWeekFilter.push(val);
            } else {
                devWeekFilter.splice(index, 1);
            }
            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devWeek');
                if (dd) dd.classList.add('open');
                openDropdown = 'devWeek';
            }, 0);
        }

        function toggleDevWeekAll(evt) {
            if (evt) evt.stopPropagation();

            const weekSet = new Set();
            const process = (list) => {
                if (!list) return;
                list.forEach(t => {
                    weekSet.add(getWeekRangeLabel(t.dueDate));
                    if (t.linkedBugs) t.linkedBugs.forEach(b => weekSet.add(getWeekRangeLabel(b.dueDate)));
                });
            };
            process(lastTickets);
            process(lastDevSubtasks);
            if (lastDevBugsDetailed) lastDevBugsDetailed.forEach(b => weekSet.add(getWeekRangeLabel(b.dueDate)));

            const allWeeks = Array.from(weekSet);

            // Toggle logic: if null(All) or full, switch to empty. Else select all.
            if (devWeekFilter === null || devWeekFilter.length === allWeeks.length) {
                devWeekFilter = [];
            } else {
                devWeekFilter = [...allWeeks];
            }

            renderPostResults();
            setTimeout(() => {
                const dd = document.getElementById('dropdown-devWeek');
                if (dd) dd.classList.add('open');
                openDropdown = 'devWeek';
            }, 0);
        }

        function resetDevViewFilters() {
            const assigneeSet = new Set();
            const statusSet = new Set();

            const process = (list) => {
                if (!list) return;
                list.forEach(t => {
                    assigneeSet.add(t.assignee || 'Unassigned');
                    statusSet.add(t.status);
                    (t.linkedBugs || []).forEach(b => {
                        assigneeSet.add(b.assignee || 'Unassigned');
                        statusSet.add(b.status);
                    });
                });
            };

            process(lastTickets);
            process(lastDevSubtasks);
            if (lastDevBugsDetailed) {
                lastDevBugsDetailed.forEach(b => {
                    assigneeSet.add(b.assignee || 'Unassigned');
                    statusSet.add(b.status);
                });
            }

            devAssigneeFilters = Array.from(assigneeSet);
            devStatusFilters = Array.from(statusSet);
            devTypeFilter = ['Story', 'Sub Task', 'Bug'];

            devWeekFilter = null;

            renderPostResults();
        }




        function toggleSubtaskGroup(groupId) {
            const content = document.getElementById(groupId);
            if (!content) return;

            const group = content.closest('.subtask-group');
            const isHidden = content.style.display === 'none';

            content.style.display = isHidden ? 'block' : 'none';

            if (isHidden) {
                group.classList.add('expanded');
            } else {
                group.classList.remove('expanded');
            }
        }

        function expandAllSubtasks() {
            document.querySelectorAll('.subtask-content').forEach(el => {
                el.style.display = 'block';
                el.closest('.subtask-group').classList.add('expanded');
            });
        }

        function collapseAllSubtasks() {
            document.querySelectorAll('.subtask-content').forEach(el => {
                el.style.display = 'none';
                el.closest('.subtask-group').classList.remove('expanded');
            });
        }

        function renderFRView(tickets) {
            const container = document.getElementById('ticketsContainer');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            const frData = aggregateFRData(tickets);

            if (frData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No FR data found</h2>
                        <p>No tickets have FR IDs assigned</p>
                    </div>
                `;
                return;
            }

            // Get unique status values for filter
            const statusOptions = ['Done', 'Pending', 'Partially Done'];

            const optionHtml = (opts, selected, field) => opts.map(opt => {
                const isSel = selected.includes(opt.toLowerCase());
                const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return `
                    <label>
                        <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleFRMultiOption('${field}', '${safe}', this.checked, event)">
                        ${safe}
                    </label>
                `;
            }).join('');

            const visibleColumns = frColumns.filter(c => frColumnVisibility[c.id]);

            const headerCells = visibleColumns.map(col => {
                const sortableAttrs = col.sortable
                    ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setFRSort('${col.id}')"`
                    : `${col.className ? `class="${col.className}"` : ''}`;
                const indicator = col.sortable ? `<span class="sort-indicator">${frSortIndicator(col.id)}</span>` : '';
                return `
                    <th ${sortableAttrs}>
                        ${col.label} ${indicator}
                    </th>
                `;
            }).join('');

            const filterRow = `
                <tr>
                    ${visibleColumns.map(col => {
                if (col.id === 'serial') {
                    return `<th class="serial-col">#</th>`;
                }
                if (col.id === 'frId') {
                    return `<th><input type="text" placeholder="Search FR ID" oninput="setFRFilter('frId', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.frId || ''}"></th>`;
                }
                if (col.id === 'totalTickets') {
                    return `<th><input type="text" placeholder="Search total" oninput="setFRFilter('totalTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.totalTickets || ''}"></th>`;
                }
                if (col.id === 'doneTickets') {
                    return `<th><input type="text" placeholder="Search done" oninput="setFRFilter('doneTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.doneTickets || ''}"></th>`;
                }
                if (col.id === 'pendingTickets') {
                    return `<th><input type="text" placeholder="Search pending" oninput="setFRFilter('pendingTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.pendingTickets || ''}"></th>`;
                }
                if (col.id === 'frStatus') {
                    return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-frStatus" type="button" onclick="toggleDropdown('frStatus', event)">
                                            ${frDropdownLabel('frStatus')} <span class="caret"></span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-frStatus">
                                            ${optionHtml(statusOptions, frFilters.frStatusValues, 'frStatus')}
                                            <button class="dd-clear" type="button" onclick="clearFRMultiFilter('frStatus', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                }
                return '<th></th>';
            }).join('')}
                </tr>
            `;

            const columnChooser = `
                <div class="multi-dd" onclick="event.stopPropagation();">
                    <button class="multi-dd-btn" id="dropdown-btn-frColumns" type="button" onclick="toggleDropdown('frColumns', event)">
                        ${frColumnsDropdownLabel()} <span class="caret"></span>
                    </button>
                    <div class="multi-dd-options" id="dropdown-frColumns">
                        ${frColumns.map(col => `
                            <label>
                                <input type="checkbox" ${frColumnVisibility[col.id] ? 'checked' : ''} onchange="toggleFRColumnVisibility('${col.id}', this.checked, event)">
                                ${col.label}
                            </label>
                        `).join('')}
                        <button class="dd-clear" type="button" onclick="resetFRColumns(event)">Show all</button>
                    </div>
                </div>
            `;

            const filteredAndSorted = applyFRFiltersAndSort(frData);

            const viewActions = getFilterActionsButtons(columnChooser);
            container.innerHTML = `
                <div class="filter-actions" style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    ${viewActions.tabs}
                </div>
                <div class="filter-actions">
                    ${viewActions.options}
                </div>
                <table class="tickets-table">
                    <thead>
                        <tr>
                            ${headerCells}
                        </tr>
                        ${filterRow}
                    </thead>
                    <tbody>
                        ${filteredAndSorted.map((fr, idx) => {
                const cells = [];
                if (frColumnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                if (frColumnVisibility.frId) cells.push(`<td>${fr.frId || 'N/A'}</td>`);
                if (frColumnVisibility.totalTickets) cells.push(`<td>${fr.totalTickets || 0}</td>`);
                if (frColumnVisibility.doneTickets) cells.push(`<td>${fr.doneTickets || 0}</td>`);
                if (frColumnVisibility.pendingTickets) cells.push(`<td>${fr.pendingTickets || 0}</td>`);
                if (frColumnVisibility.frStatus) cells.push(`<td>${fr.frStatus || 'N/A'}</td>`);
                // Construct Jira URL with FR ID - only make clickable if FR ID exists
                const frId = fr.frId || '';
                let rowAttrs = '';
                if (frId && frId !== 'N/A') {
                    const parent = modules[activeModule].emId;
                    const jqlQuery = `cf[10049] = "${frId}" AND parent = ${parent}`;
                    const encodedJql = encodeURIComponent(jqlQuery);
                    const jiraUrl = `https://cardyai-hawaii.atlassian.net/issues/?jql=${encodedJql}`;
                    rowAttrs = `onclick="window.open('${jiraUrl}', '_blank')" style="cursor:pointer;"`;
                }
                return `<tr ${rowAttrs}>${cells.join('')}</tr>`;
            }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderTickets(tickets) {
            lastTickets = tickets || [];
            const container = document.getElementById('ticketsContainer');
            container.classList.remove('grid-mode');

            // Mark that data has been loaded and remove login mode
            if (tickets && tickets.length > 0) {
                hasDataBeenLoaded = true;
                const mainContainer = document.querySelector('.container');
                if (mainContainer) {
                    mainContainer.classList.remove('login-mode');
                    // Hide email and password fields after data is loaded
                    const emailGroup = document.querySelector('.email-group');
                    const passwordGroup = document.querySelector('.password-group');
                    if (emailGroup) emailGroup.style.display = 'none';
                    if (passwordGroup) passwordGroup.style.display = 'none';
                }
            }

            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            if (viewMode === 'dashboard') {
                renderDashboard(tickets);
                return;
            }

            if (viewMode === 'fr') {
                renderFRView(tickets);
                return;
            }

            if (viewMode === 'worklog') {
                renderWorklogView(tickets);
                return;
            }

            if (viewMode === 'sprintplan') {
                renderSprintPlanView(tickets);
                return;
            }

            if (viewMode === 'dev') {
                renderDevView(tickets);
                return;
            }

            const visibleTickets = applyFiltersAndSort(tickets);

            {
                const statusOptions = getUniqueValues(tickets, 'status');
                const assigneeOptions = getUniqueValues(tickets, 'assignee');
                const priorityOptions = getUniqueValues(tickets, 'priority');

                const optionHtml = (opts, selected, field) => opts.map(opt => {
                    const isSel = selected.includes(opt.toLowerCase());
                    const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    return `
                        <label>
                            <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleMultiOption('${field}', '${safe}', this.checked, event)">
                            ${safe}
                        </label>
                    `;
                }).join('');

                const visibleColumns = columns.filter(c => columnVisibility[c.id]);

                const headerCells = visibleColumns.map(col => {
                    const sortableAttrs = col.sortable
                        ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setSort('${col.id}')"`
                        : `${col.className ? `class="${col.className}"` : ''}`;
                    const indicator = col.sortable ? `<span class="sort-indicator">${sortIndicator(col.id)}</span>` : '';
                    return `
                        <th ${sortableAttrs}>
                            ${col.label} ${indicator}
                        </th>
                    `;
                }).join('');

                const filterRow = `
                    <tr>
                        ${visibleColumns.map(col => {
                    if (col.id === 'serial') {
                        return `<th class="serial-col">#</th>`;
                    }
                    if (col.id === 'key') {
                        return `<th><input type="text" placeholder="Search key" oninput="setFilter('key', this.value, event)" onclick="event.stopPropagation();" value="${filters.key || ''}"></th>`;
                    }
                    if (col.id === 'summary') {
                        return `<th><input type="text" placeholder="Search summary" oninput="setFilter('summary', this.value, event)" onclick="event.stopPropagation();" value="${filters.summary || ''}"></th>`;
                    }
                    if (col.id === 'status') {
                        return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-status" type="button" onclick="toggleDropdown('status', event)">
                                                ${dropdownLabel('status')} <span class="caret"></span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-status">
                                                ${optionHtml(statusOptions, filters.statusValues, 'status')}
                                                <button class="dd-clear" type="button" onclick="clearMultiFilter('status', event)">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                    }
                    if (col.id === 'assignee') {
                        return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-assignee" type="button" onclick="toggleDropdown('assignee', event)">
                                                ${dropdownLabel('assignee')} <span class="caret"></span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-assignee">
                                                ${optionHtml(assigneeOptions, filters.assigneeValues, 'assignee')}
                                                <button class="dd-clear" type="button" onclick="clearMultiFilter('assignee', event)">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                    }
                    if (col.id === 'priority') {
                        return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-priority" type="button" onclick="toggleDropdown('priority', event)">
                                                ${dropdownLabel('priority')} <span class="caret"></span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-priority">
                                                ${optionHtml(priorityOptions, filters.priorityValues, 'priority')}
                                                <button class="dd-clear" type="button" onclick="clearMultiFilter('priority', event)">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                    }
                    if (col.id === 'storyPoints') {
                        return `<th><input type="text" placeholder="Search story points" oninput="setFilter('storyPoints', this.value, event)" onclick="event.stopPropagation();" value="${filters.storyPoints || ''}"></th>`;
                    }
                    if (col.id === 'dueDate') {
                        return `<th><input type="text" placeholder="Search due date" oninput="setFilter('dueDate', this.value, event)" onclick="event.stopPropagation();" value="${filters.dueDate || ''}"></th>`;
                    }
                    if (col.id === 'timeOriginalEstimate') {
                        return `<th><input type="text" placeholder="Search estimate" oninput="setFilter('timeOriginalEstimate', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeOriginalEstimate || ''}"></th>`;
                    }
                    if (col.id === 'actualHours') {
                        return `<th><input type="text" placeholder="Search time spent" oninput="setFilter('actualHours', this.value, event)" onclick="event.stopPropagation();" value="${filters.actualHours || ''}"></th>`;
                    }
                    if (col.id === 'timeDifference') {
                        return `<th><input type="text" placeholder="Search difference" oninput="setFilter('timeDifference', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeDifference || ''}"></th>`;
                    }
                    if (col.id === 'created') {
                        return `<th><input type="text" placeholder="Search created" oninput="setFilter('created', this.value, event)" onclick="event.stopPropagation();" value="${filters.created || ''}"></th>`;
                    }
                    if (col.id === 'updated') {
                        return `<th><input type="text" placeholder="Search updated" oninput="setFilter('updated', this.value, event)" onclick="event.stopPropagation();" value="${filters.updated || ''}"></th>`;
                    }
                    if (col.id === 'qaFailedCount') {
                        return `<th class="qa-col"><input type="text" placeholder="Search QA loop" oninput="setFilter('qaFailedCount', this.value, event)" onclick="event.stopPropagation();" value="${filters.qaFailedCount || ''}"></th>`;
                    }
                    if (col.id === 'totalBugs') {
                        return `<th class="qa-col"><input type="text" placeholder="Search total bugs" oninput="setFilter('totalBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.totalBugs || ''}"></th>`;
                    }
                    if (col.id === 'openBugs') {
                        return `<th class="qa-col"><input type="text" placeholder="Search open bugs" oninput="setFilter('openBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.openBugs || ''}"></th>`;
                    }
                    return '<th></th>';
                }).join('')}
                    </tr>
                `;

                const columnChooser = `
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-columns" type="button" onclick="toggleDropdown('columns', event)">
                            ${columnsDropdownLabel()} <span class="caret"></span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-columns">
                            ${columns.map(col => `
                                <label>
                                    <input type="checkbox" ${columnVisibility[col.id] ? 'checked' : ''} onchange="toggleColumnVisibility('${col.id}', this.checked, event)">
                                    ${col.label}
                                </label>
                            `).join('')}
                            <button class="dd-clear" type="button" onclick="resetColumns(event)">Show all</button>
                        </div>
                    </div>
                `;

                const viewActions = getFilterActionsButtons(columnChooser);
                container.innerHTML = `
                    <div class="filter-actions" style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                        ${viewActions.tabs}
                    </div>
                    <div class="filter-actions">
                        ${viewActions.options}
                    </div>
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                ${headerCells}
                            </tr>
                            ${filterRow}
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                updateTableBody(tickets);
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card" onclick="window.open('${ticket.url || '#'}', '_blank')">
                    <div class="ticket-header">
                        <span class="ticket-key">${ticket.key || 'N/A'}</span>
                        <span class="ticket-status ${getStatusClass(ticket.status || '')}">
                            ${ticket.status || 'Unknown'}
                        </span>
                    </div>
                    <div class="ticket-title">${ticket.summary || ticket.title || 'No title'}</div>
                    <div class="ticket-meta">
                        ${ticket.assignee ? `<div class="ticket-meta-item"> ${ticket.assignee}</div>` : ''}
                        ${ticket.priority ? `<div class="ticket-meta-item"> ${ticket.priority}</div>` : ''}
                        ${ticket.created ? `<div class="ticket-meta-item"> Created: ${formatDate(ticket.created)}</div>` : ''}
                        ${ticket.updated ? `<div class="ticket-meta-item"> Updated: ${formatDate(ticket.updated)}</div>` : ''}
                        ${typeof ticket.qaFailedCount === 'number' ? `<div class="ticket-meta-item"> QA Loop: ${ticket.qaFailedCount}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function handleSubmit(event) {
            event.preventDefault();
            loadTickets();
        }

        async function loadTickets() {
            const updateBtn = document.getElementById('updateBtn');
            let email = document.getElementById('emailInput').value.trim();
            const apiToken = document.getElementById('tokenInput').value.trim();
            const container = document.getElementById('ticketsContainer');

            if (!email || !apiToken) {
                showError('Please enter your username and password.');
                updateStatus('Missing credentials');
                return;
            }

            // If username doesn't contain "@", append "@cardyai.com"
            if (!email.includes('@')) {
                email = email + '@cardyai.com';
            }

            // Save credentials for subsequent requests
            savedEmail = email;
            savedApiToken = apiToken;

            updateBtn.disabled = true;
            showLoading(true);
            hideError();
            updateStatus('Loading tickets...');

            try {
                // Get the EM ID for the currently selected module
                const currentModule = modules[activeModule];
                if (!currentModule) {
                    throw new Error(`Module "${activeModule}" not found in configuration`);
                }
                const parent = currentModule.emId;
                const sprintId = currentModule.sprintId;

                // Build form body, only include sprintId if it has a value
                const formData = { email, apiToken, parent };
                if (sprintId && sprintId.trim() !== '') {
                    formData.sprintId = sprintId;
                    isFetchingSprintData = true;
                }
                isFetchingDevData = true;
                const formBody = new URLSearchParams(formData).toString();

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formBody
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const tickets = data.tickets || data.issues || data;
                const normalized = Array.isArray(tickets) ? tickets : [tickets];

                // Ensure viewMode is set to dashboard after each fetch
                viewMode = 'dashboard';

                // Mark that data has been loaded
                if (normalized && normalized.length > 0) {
                    hasDataBeenLoaded = true;
                }

                // Remove login mode when data is successfully loaded
                const mainContainer = document.querySelector('.container');
                if (mainContainer && normalized && normalized.length > 0) {
                    mainContainer.classList.remove('login-mode');
                    // Hide email and password fields after data is loaded
                    const emailGroup = document.querySelector('.email-group');
                    const passwordGroup = document.querySelector('.password-group');
                    if (emailGroup) emailGroup.style.display = 'none';
                    if (passwordGroup) passwordGroup.style.display = 'none';
                }

                renderTickets(normalized);
                updateStatus(`Loaded ${normalized.length} ticket(s)`);

                // Update last fetch time
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                const dateStr = now.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
                const fetchTimeEl = document.getElementById('lastFetchTime');
                if (fetchTimeEl) {
                    fetchTimeEl.textContent = `${dateStr} ${timeStr}`;
                }

                // Trigger Dev tickets fetch in the background
                fetchDevDataOnly().catch(err => console.error('Background Dev Fetch Error:', err));
            } catch (error) {
                console.error('Error loading tickets:', error);
                showError(`Error loading tickets: ${error.message}`);
                updateStatus('Error loading tickets');
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets loaded</h2>
                        <p>Update failed. Please check your credentials and try again.</p>
                    </div>
                `;
            } finally {
                showLoading(false);
                updateBtn.disabled = false;
            }
        }

        // Do not auto-load; user triggers via Update button
    </script>
</body>

</html>