<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRV JIRA Status</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Atlassian Sans", ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 0;
            position: relative;
        }


        .container {
            width: 100%;
            margin: 0;
            background: white;
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }

        .container.login-mode {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header {
            background: white;
            color: #333;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls-wrapper {
            width: 100%;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .container.login-mode .controls-wrapper {
            width: auto;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            background: white;
            max-width: 500px;
            margin: 0 auto;
        }

        .controls {
            padding: 20px 30px;
            background: white;
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 15px;
            align-items: end;
            max-width: 35%;
            transition: all 0.3s ease;
        }

        .container.login-mode .controls {
            grid-template-columns: 1fr;
            max-width: 100%;
            gap: 20px;
            padding: 40px;
        }

        /* Hide email and password inputs after data is loaded */
        .input-group.email-group,
        .input-group.password-group {
            display: none;
        }

        .container.login-mode .input-group.email-group,
        .container.login-mode .input-group.password-group {
            display: flex;
        }

        /* Adjust controls layout when email/password are hidden */
        .container:not(.login-mode) .controls {
            grid-template-columns: 1fr auto;
        }

        .container.login-mode .fetch-time-container {
            display: none;
        }

        .container.login-mode .tickets-container {
            display: none;
        }

        .container.login-mode .error {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 500px;
            width: calc(100% - 40px);
            z-index: 1000;
        }

        .container.login-mode .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .fetch-time-container {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 11px;
            color: #888;
            font-style: italic;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }

        .text-input {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .text-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .select-input {
            padding: 10px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .select-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .action-btn {
            background: #1868DB;
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            white-space: nowrap;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(24, 104, 219, 0.4);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            color: #666;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1868DB;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            background: #fee;
            color: #c33;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            border-left: 4px solid #c33;
        }

        .error.active {
            display: block;
        }

        .tickets-container {
            padding: 30px;
            overflow-x: auto;
        }

        .ticket-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ticket-key {
            font-size: 1.2em;
            font-weight: 600;
            color: #1868DB;
        }

        .ticket-status {
            font-weight: 600;
            color: #444;
        }

        .ticket-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .ticket-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #666;
        }

        .ticket-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: #666;
        }



        .tickets-table {
            width: 100%;
            min-width: 1100px;
            border-collapse: collapse;
        }

        .tickets-table th, .tickets-table td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
            font-size: 14px;
        }

        .tickets-table th {
            background: rgba(24, 104, 219, 0.12);
            font-weight: 700;
            color: #444;
            white-space: nowrap;
        }

        .tickets-table tbody tr:hover {
            background: rgba(24, 104, 219, 0.06);
        }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sorted {
            background: rgba(24, 104, 219, 0.12);
            color: #1868DB;
        }

        .sort-indicator {
            margin-left: 6px;
            font-size: 11px;
            color: #888;
        }

        .filter-actions {
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
        }

        .clear-btn {
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: background 0.2s, border-color 0.2s, color 0.2s;
        }

        .clear-btn:hover {
            background: rgba(24, 104, 219, 0.08);
            border-color: #1868DB;
            color: #444;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .dash-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dash-grid {
                grid-template-columns: 1fr;
            }
        }

        .dash-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .dash-card h3 {
            margin-bottom: 12px;
            color: #444;
        }

        .dash-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .dash-list li {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .dash-list li.clickable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .dash-list li.clickable:hover {
            background: rgba(24, 104, 219, 0.06);
            padding-left: 4px;
            padding-right: 4px;
            margin-left: -4px;
            margin-right: -4px;
        }

        .dash-list li span:last-child {
            text-align: right;
        }

        .dash-list li:last-child {
            border-bottom: none;
        }

        .dash-section {
            margin-bottom: 20px;
        }

        .dash-section:last-child {
            margin-bottom: 0;
        }

        .date-picker-container {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-picker-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .date-picker-input {
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .date-picker-input:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .time-tracking-widget {
            grid-column: 1 / -1;
        }

        .worklog-detail-widget {
            grid-column: 1 / -1;
        }

        .worklog-input-container {
            display: flex;
            gap: 15px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .worklog-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
        }

        .worklog-select {
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fff;
        }

        .worklog-select:focus {
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .worklog-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .worklog-detail-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .worklog-detail-item:last-child {
            border-bottom: none;
        }

        .worklog-detail-time {
            font-weight: 600;
            color: #1868DB;
            white-space: nowrap;
            min-width: 80px;
        }

        .worklog-detail-key {
            font-weight: 600;
            color: #1868DB;
            white-space: nowrap;
            min-width: 100px;
            margin-right: 15px;
        }

        .worklog-detail-key a {
            color: #1868DB;
            text-decoration: none;
            cursor: pointer;
            transition: text-decoration 0.2s;
        }

        .worklog-detail-key a:hover {
            text-decoration: underline;
        }

        .worklog-detail-description {
            flex: 1;
            color: #444;
            word-wrap: break-word;
        }

        .time-low-hours {
            color: #d32f2f;
            font-weight: 600;
        }

        .dash-section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 15px;
            color: #1868DB;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid #1868DB;
        }

        .dash-section-title .section-count {
            text-align: right;
            font-weight: 700;
        }

        .multi-dd {
            position: relative;
            min-width: 180px;
        }

        .multi-dd-btn {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            background: #fff;
            color: #444;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
        }

        .multi-dd-btn:focus {
            outline: none;
            border-color: #1868DB;
            box-shadow: 0 0 0 3px rgba(24, 104, 219, 0.15);
        }

        .multi-dd .caret {
            float: right;
            color: #888;
        }

        .multi-dd-options {
            position: absolute;
            z-index: 10;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            max-height: 220px;
            overflow: auto;
            padding: 8px 10px;
            display: none;
            pointer-events: auto;
        }

        .multi-dd-options.open {
            display: block;
        }

        .multi-dd-options label {
            display: block;
            font-size: 13px;
            color: #444;
            margin: 4px 0;
            cursor: pointer;
        }

        .multi-dd-options .dd-clear {
            margin-top: 8px;
            width: 100%;
            padding: 6px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-weight: 600;
        }

        .qa-col {
            min-width: 90px;
            white-space: nowrap;
        }

        .serial-col {
            width: 60px;
            text-align: center;
            white-space: nowrap;
        }

        .time-diff-positive {
            color: #d32f2f;
            font-weight: 600;
        }

        .time-diff-negative {
            color: #2e7d32;
            font-weight: 600;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .widget-header h3 {
            margin-bottom: 0;
        }

        .snapshot-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .snapshot-icon svg {
            width: 18px;
            height: 18px;
            fill: #666;
            transition: fill 0.2s;
        }

        .snapshot-icon:hover {
            background: rgba(24, 104, 219, 0.1);
        }

        .snapshot-icon:hover svg {
            fill: #1868DB;
        }

        .snapshot-icon:active {
            background: rgba(24, 104, 219, 0.2);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container login-mode">
        <div class="controls-wrapper">
            <form class="controls" autocomplete="on" onsubmit="handleSubmit(event)">
            <div class="input-group email-group">
                <label class="input-label" for="emailInput">Username</label>
                <input class="text-input" id="emailInput" name="email" type="text" autocomplete="username" placeholder="username or email" value="sarvesh.s">
            </div>
            <div class="input-group password-group">
                <label class="input-label" for="tokenInput">Password</label>
                <input class="text-input" id="tokenInput" name="password" type="password" autocomplete="current-password" placeholder="Enter your password">
            </div>
            <div class="input-group">
                <label class="input-label" for="moduleSelect">Module</label>
                <select class="select-input" id="moduleSelect" onchange="switchModule(this.value)">
                    <!-- Options will be populated dynamically from modules configuration -->
                </select>
            </div>
            <button class="action-btn" type="submit" id="updateBtn">Fetch</button>
            </form>
        </div>
        <div class="fetch-time-container">
            <span id="lastFetchTime"></span>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <div class="error" id="error"></div>

        <div class="tickets-container" id="ticketsContainer">
            <div class="empty-state">
                <h2>Data has not been loaded yet.</h2>
                <p>Enter your username and password and click Fetch to continue.</p>
            </div>
        </div>
    </div>

    <script>
        // Add a timestamp to avoid caching issues
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJZR89idUZgp7CS_bt5d3I5ftDLjUlr6gbbfzib0zMUbfvPYGXnSrfQSCzlJ37H1zcoA/exec';

        function updateStatus(message) {
            // Status display removed
        }

        // Module configuration - Add new modules here by providing module ID, display name, and EM ID
        const modules = {
            licensing: {
                name: 'Licensing',
                emId: 'EM-896'
            },
            assessments: {
                name: 'Assessments',
                emId: 'EM-1460'
            },
            testmodule: {
                name: 'Testmodule',
                emId: 'EM-5860'
            }
            // To add a new module, uncomment and modify:
            // newModule: {
            //     name: 'New Module',
            //     emId: 'EM-XXXX'
            // }
        };

        let activeModule = 'licensing'; // Default module
        let viewMode = 'dashboard'; // 'table' | 'dashboard' | 'fr'
        let lastTickets = [];
        let sortField = null;
        let sortDir = 'asc';
        let openDropdown = null;
        let hasDataBeenLoaded = false; // Track if data has been loaded at least once

        // Initialize module dropdown on page load
        function initializeModuleDropdown() {
            const moduleSelect = document.getElementById('moduleSelect');
            if (!moduleSelect) return;
            
            // Clear existing options
            moduleSelect.innerHTML = '';
            
            // Populate dropdown from modules configuration
            Object.entries(modules).forEach(([id, module]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = module.name;
                if (id === activeModule) {
                    option.selected = true;
                }
                moduleSelect.appendChild(option);
            });
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeModuleDropdown);
        } else {
            initializeModuleDropdown();
        }

        const columns = [
            { id: 'serial', label: '#', sortable: null, className: 'serial-col' },
            { id: 'key', label: 'Key', sortable: 'key' },
            { id: 'summary', label: 'Summary', sortable: 'summary' },
            { id: 'status', label: 'Status', sortable: 'status' },
            { id: 'assignee', label: 'Assignee', sortable: 'assignee' },
            { id: 'priority', label: 'Priority', sortable: 'priority' },
            { id: 'storyPoints', label: 'Story Points', sortable: 'storyPoints' },
            { id: 'timeOriginalEstimate', label: 'Estimate', sortable: 'timeOriginalEstimate' },
            { id: 'actualHours', label: 'Time Spent', sortable: 'actualHours' },
            { id: 'timeDifference', label: 'Difference', sortable: 'timeDifference' },
            { id: 'created', label: 'Created', sortable: 'created' },
            { id: 'updated', label: 'Updated', sortable: 'updated' },
            { id: 'qaFailedCount', label: 'QA Loop', sortable: 'qaFailedCount', className: 'qa-col' },
            { id: 'totalBugs', label: 'Total Bugs', sortable: 'totalBugs', className: 'qa-col' },
            { id: 'openBugs', label: 'Open Bugs', sortable: 'openBugs', className: 'qa-col' },
        ];
        
        // Single source of truth for default column visibility
        function getDefaultColumnVisibility() {
            return {
                serial: true,
                key: true,
                summary: false,
                status: true,
                assignee: true,
                priority: false,
                storyPoints: true,
                timeOriginalEstimate: true,
                actualHours: true,
                timeDifference: true,
                created: false,
                updated: false,
                qaFailedCount: true,
                totalBugs: false,
                openBugs: true
            };
        }
        
        const columnVisibility = getDefaultColumnVisibility();
        
        // Single source of truth for default filter values
        function getDefaultFilters() {
            return {
                key: '',
                summary: '',
                statusValues: [],
                assigneeValues: [],
                priorityValues: [],
                storyPoints: '',
                timeOriginalEstimate: '',
                actualHours: '',
                timeDifference: '',
                created: '',
                updated: '',
                qaFailedCount: '',
                totalBugs: '',
                openBugs: ''
            };
        }
        
        const filters = getDefaultFilters();

        function resetAllSelections() {
            // Reset filters to defaults
            Object.assign(filters, getDefaultFilters());
            
            // Reset column visibility to defaults
            Object.assign(columnVisibility, getDefaultColumnVisibility());
            
            // Reset sort settings
            sortField = null;
            sortDir = 'asc';
            
            // Reset view mode to dashboard (default)
            viewMode = 'dashboard';
            
            // Reset FR filters
            Object.assign(frFilters, getDefaultFRFilters());
            
            // Reset widget selections - explicitly set to undefined to ensure they're truly reset
            window.selectedWorklogDate = undefined;
            window.selectedWorklogDetailDate = undefined;
            window.selectedWorklogDetailAssignee = undefined;
            
            // Close any open dropdowns
            closeDropdowns();
            
            // Clear any filter input fields if they exist in the DOM
            const filterInputs = document.querySelectorAll('#ticketsContainer input[type="text"]');
            filterInputs.forEach(input => {
                if (input.placeholder && input.placeholder.toLowerCase().includes('search')) {
                    input.value = '';
                }
            });
        }

        function switchModule(moduleId) {
            // Validate module exists
            if (!modules[moduleId]) {
                console.error(`Module "${moduleId}" not found in configuration`);
                return;
            }
            
            activeModule = moduleId;
            
            // Update the select dropdown to reflect the current selection
            const moduleSelect = document.getElementById('moduleSelect');
            if (moduleSelect) {
                moduleSelect.value = moduleId;
            }
            
            // Reset all user selections to defaults
            resetAllSelections();
            
            // Hide fetch time when switching modules
            const fetchTimeEl = document.getElementById('lastFetchTime');
            if (fetchTimeEl) {
                fetchTimeEl.textContent = '';
            }
            
            hideError();
            showLoading(false);
            updateStatus('Enter username, password, then click Update');
            updateDashboardButton();
            const container = document.getElementById('ticketsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <h2>Data has not been loaded yet.</h2>
                    <p>Click Fetch to continue.</p>
                </div>
            `;
            lastTickets = [];
            
            // Only restore login mode if data has never been loaded (initial state)
            // Don't restore login mode when switching modules after data has been loaded
            const mainContainer = document.querySelector('.container');
            if (mainContainer && !hasDataBeenLoaded) {
                mainContainer.classList.add('login-mode');
            }
        }

        function setFilter(field, value, evt) {
            if (evt) {
                evt.stopPropagation();
            }
            filters[field] = value.toLowerCase();
            updateTableBody(lastTickets);
        }

        function setFilterMulti(field, selectEl, evt) {
            if (evt) {
                evt.stopPropagation();
            }
            const values = Array.from(selectEl.selectedOptions || []).map(o => o.value.toLowerCase());
            filters[field] = values;
            updateTableBody(lastTickets);
        }

        function toggleDropdown(field, evt) {
            if (evt) evt.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (!dropdown) return;
            closeDropdowns(field);
            const willOpen = !dropdown.classList.contains('open');
            if (willOpen) {
                dropdown.classList.add('open');
                openDropdown = field;
            } else {
                dropdown.classList.remove('open');
                openDropdown = null;
            }
        }

        function closeDropdowns(exceptField) {
            document.querySelectorAll('.multi-dd-options').forEach(el => {
                if (exceptField && el.id === `dropdown-${exceptField}`) return;
                el.classList.remove('open');
            });
            if (!exceptField) openDropdown = null;
        }

        document.addEventListener('click', (evt) => {
            // Only close dropdowns if click is outside any dropdown
            const clickedElement = evt.target;
            const isInsideDropdown = clickedElement.closest('.multi-dd');
            if (!isInsideDropdown) {
                closeDropdowns();
            }
        });

        function toggleMultiOption(field, value, checked, evt) {
            if (evt) evt.stopPropagation();
            const key = `${field}Values`;
            const arr = filters[key] || [];
            const norm = value.toLowerCase();
            const exists = arr.includes(norm);
            if (checked && !exists) {
                arr.push(norm);
                filters[key] = arr;
            } else if (!checked && exists) {
                filters[key] = arr.filter(v => v !== norm);
            }
            
            // Update table body without re-rendering (which would close the dropdown)
            updateTableBody(lastTickets);
            
            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${dropdownLabel(field)} <span class="caret">▾</span>`;
            }
        }

        function clearMultiFilter(field, evt) {
            if (evt) evt.stopPropagation();
            filters[`${field}Values`] = [];
            
            // Update table body without re-rendering (which would close the dropdown)
            updateTableBody(lastTickets);
            
            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${dropdownLabel(field)} <span class="caret">▾</span>`;
            }
            
            // Uncheck all checkboxes in the dropdown
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (dropdown) {
                const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        }

        function dropdownLabel(field) {
            const arr = filters[`${field}Values`] || [];
            if (arr.length === 0) return 'All';
            if (arr.length === 1) return arr[0];
            return `${arr.length} selected`;
        }

        function columnsDropdownLabel() {
            const visibleCount = Object.values(columnVisibility).filter(Boolean).length;
            const total = columns.length;
            return visibleCount === total ? 'Columns (All)' : `Columns (${visibleCount}/${total})`;
        }

        function updateTableHeaderAndBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderTickets(tickets);
                return;
            }
            
            // Save dropdown state
            const wasOpen = openDropdown === 'columns';
            const dropdown = document.getElementById('dropdown-columns');
            
            const visibleColumns = columns.filter(c => columnVisibility[c.id]);
            
            // Update header row
            const thead = table.querySelector('thead');
            if (thead) {
                const headerRow = thead.querySelector('tr:first-child');
                if (headerRow) {
                    const headerCells = visibleColumns.map(col => {
                        const sortableAttrs = col.sortable
                            ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setSort('${col.id}')"`
                            : `${col.className ? `class="${col.className}"` : ''}`;
                        const indicator = col.sortable ? `<span class="sort-indicator">${sortIndicator(col.id)}</span>` : '';
                        return `
                            <th ${sortableAttrs}>
                                ${col.label} ${indicator}
                            </th>
                        `;
                    }).join('');
                    headerRow.innerHTML = headerCells;
                }
                
                // Update filter row
                const filterRow = thead.querySelector('tr:last-child');
                if (filterRow) {
                    const statusOptions = getUniqueValues(tickets, 'status');
                    const assigneeOptions = getUniqueValues(tickets, 'assignee');
                    const priorityOptions = getUniqueValues(tickets, 'priority');
                    
                    const optionHtml = (opts, selected, field) => opts.map(opt => {
                        const isSel = selected.includes(opt.toLowerCase());
                        const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        return `
                            <label>
                                <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleMultiOption('${field}', '${safe}', this.checked, event)">
                                ${safe}
                            </label>
                        `;
                    }).join('');
                    
                    const filterCells = visibleColumns.map(col => {
                        if (col.id === 'serial') {
                            return `<th class="serial-col">#</th>`;
                        }
                        if (col.id === 'key') {
                            return `<th><input type="text" placeholder="Search key" oninput="setFilter('key', this.value, event)" onclick="event.stopPropagation();" value="${filters.key || ''}"></th>`;
                        }
                        if (col.id === 'summary') {
                            return `<th><input type="text" placeholder="Search summary" oninput="setFilter('summary', this.value, event)" onclick="event.stopPropagation();" value="${filters.summary || ''}"></th>`;
                        }
                        if (col.id === 'status') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-status" type="button" onclick="toggleDropdown('status', event)">
                                            ${dropdownLabel('status')} <span class="caret">▾</span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-status">
                                            ${optionHtml(statusOptions, filters.statusValues, 'status')}
                                            <button class="dd-clear" type="button" onclick="clearMultiFilter('status', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        if (col.id === 'assignee') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-assignee" type="button" onclick="toggleDropdown('assignee', event)">
                                            ${dropdownLabel('assignee')} <span class="caret">▾</span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-assignee">
                                            ${optionHtml(assigneeOptions, filters.assigneeValues, 'assignee')}
                                            <button class="dd-clear" type="button" onclick="clearMultiFilter('assignee', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        if (col.id === 'priority') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-priority" type="button" onclick="toggleDropdown('priority', event)">
                                            ${dropdownLabel('priority')} <span class="caret">▾</span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-priority">
                                            ${optionHtml(priorityOptions, filters.priorityValues, 'priority')}
                                            <button class="dd-clear" type="button" onclick="clearMultiFilter('priority', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        if (col.id === 'storyPoints') {
                            return `<th><input type="text" placeholder="Search story points" oninput="setFilter('storyPoints', this.value, event)" onclick="event.stopPropagation();" value="${filters.storyPoints || ''}"></th>`;
                        }
                        if (col.id === 'timeOriginalEstimate') {
                            return `<th><input type="text" placeholder="Search estimate" oninput="setFilter('timeOriginalEstimate', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeOriginalEstimate || ''}"></th>`;
                        }
                        if (col.id === 'actualHours') {
                            return `<th><input type="text" placeholder="Search time spent" oninput="setFilter('actualHours', this.value, event)" onclick="event.stopPropagation();" value="${filters.actualHours || ''}"></th>`;
                        }
                        if (col.id === 'timeDifference') {
                            return `<th><input type="text" placeholder="Search difference" oninput="setFilter('timeDifference', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeDifference || ''}"></th>`;
                        }
                        if (col.id === 'created') {
                            return `<th><input type="text" placeholder="Search created" oninput="setFilter('created', this.value, event)" onclick="event.stopPropagation();" value="${filters.created || ''}"></th>`;
                        }
                        if (col.id === 'updated') {
                            return `<th><input type="text" placeholder="Search updated" oninput="setFilter('updated', this.value, event)" onclick="event.stopPropagation();" value="${filters.updated || ''}"></th>`;
                        }
                        if (col.id === 'qaFailedCount') {
                            return `<th class="qa-col"><input type="text" placeholder="Search QA loop" oninput="setFilter('qaFailedCount', this.value, event)" onclick="event.stopPropagation();" value="${filters.qaFailedCount || ''}"></th>`;
                        }
                        if (col.id === 'totalBugs') {
                            return `<th class="qa-col"><input type="text" placeholder="Search total bugs" oninput="setFilter('totalBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.totalBugs || ''}"></th>`;
                        }
                        if (col.id === 'openBugs') {
                            return `<th class="qa-col"><input type="text" placeholder="Search open bugs" oninput="setFilter('openBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.openBugs || ''}"></th>`;
                        }
                        return '<th></th>';
                    }).join('');
                    filterRow.innerHTML = filterCells;
                }
            }
            
            // Update body
            updateTableBody(tickets);
            
            // Update column chooser button label
            const dropdownBtn = document.getElementById('dropdown-btn-columns');
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${columnsDropdownLabel()} <span class="caret">▾</span>`;
            }
            
            // Restore dropdown state
            if (wasOpen && dropdown) {
                dropdown.classList.add('open');
                openDropdown = 'columns';
            }
        }

        function toggleColumnVisibility(colId, checked, evt) {
            if (evt) evt.stopPropagation();
            columnVisibility[colId] = checked;
            if (viewMode === 'table') {
                updateTableHeaderAndBody(lastTickets);
            } else {
                renderTickets(lastTickets);
            }
        }

        function resetColumns(evt) {
            if (evt) evt.stopPropagation();
            Object.keys(columnVisibility).forEach(k => columnVisibility[k] = true);
            if (viewMode === 'table') {
                updateTableHeaderAndBody(lastTickets);
            } else {
                renderTickets(lastTickets);
            }
        }

        function setSort(field) {
            if (sortField === field) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDir = 'asc';
            }
            updateTableBody(lastTickets);
        }

        function sortIndicator(field) {
            if (sortField !== field) return '⇅';
            return sortDir === 'asc' ? '▲' : '▼';
        }

        function toggleDashboard() {
            viewMode = viewMode === 'dashboard' ? 'table' : 'dashboard';
            updateDashboardButton();
            renderTickets(lastTickets);
        }

        function updateWorklogDate(date) {
            window.selectedWorklogDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            }
        }

        function updateWorklogDetailDate(date) {
            window.selectedWorklogDetailDate = date;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            }
        }

        function updateWorklogDetailAssignee(assignee) {
            window.selectedWorklogDetailAssignee = assignee;
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
            }
        }

        function selectAssigneeForWorklogDetails(assignee, date) {
            // Set both date and assignee
            window.selectedWorklogDetailDate = date;
            window.selectedWorklogDetailAssignee = assignee;
            
            // Re-render dashboard to update Worklog Details widget
            if (viewMode === 'dashboard') {
                renderDashboard(lastTickets);
                
                // Scroll to Worklog Details widget after a short delay to ensure it's rendered
                setTimeout(() => {
                    const worklogDetailWidget = document.querySelector('.worklog-detail-widget');
                    if (worklogDetailWidget) {
                        worklogDetailWidget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        function renderWorklogDetailWidget(tickets) {
            // Get today's date
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Get all unique assignees
            const allAssignees = new Set();
            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                if (assignee) allAssignees.add(assignee);
            });
            const assigneesList = Array.from(allAssignees).sort();
            
            // Get selected date and assignee (default to today and first assignee)
            // Explicitly check if property exists and is not undefined/null
            const selectedDate = (window.selectedWorklogDetailDate !== undefined && window.selectedWorklogDetailDate !== null) 
                ? window.selectedWorklogDetailDate 
                : todayStr;
            const selectedAssignee = (window.selectedWorklogDetailAssignee !== undefined && window.selectedWorklogDetailAssignee !== null)
                ? window.selectedWorklogDetailAssignee
                : (assigneesList.length > 0 ? assigneesList[0] : '');
            
            // Initialize if not set
            if (window.selectedWorklogDetailDate === undefined || window.selectedWorklogDetailDate === null) {
                window.selectedWorklogDetailDate = todayStr;
            }
            if ((window.selectedWorklogDetailAssignee === undefined || window.selectedWorklogDetailAssignee === null) && assigneesList.length > 0) {
                window.selectedWorklogDetailAssignee = assigneesList[0];
            }
            
            // Get worklog details
            const worklogDetails = getWorklogDetailsByDateAndAssignee(tickets, selectedDate, selectedAssignee);
            
            // Build assignee options
            const assigneeOptions = assigneesList.map(assignee => 
                `<option value="${assignee}" ${assignee === selectedAssignee ? 'selected' : ''}>${assignee}</option>`
            ).join('');
            
            // Build worklog detail list
            const worklogDetailList = worklogDetails.length > 0 
                ? worklogDetails.map(detail => {
                    const ticketKeyDisplay = detail.ticketKey || 'N/A';
                    const ticketKeyHtml = detail.ticketUrl 
                        ? `<a href="${detail.ticketUrl}" target="_blank" onclick="event.stopPropagation();">${ticketKeyDisplay}</a>`
                        : ticketKeyDisplay;
                    return `
                    <li class="worklog-detail-item">
                        <span class="worklog-detail-time">${formatTimeHoursMinutes(detail.timeSpent)}</span>
                        <span class="worklog-detail-key">${ticketKeyHtml}</span>
                        <span class="worklog-detail-description">${detail.description}</span>
                    </li>
                `;
                }).join('')
                : '<li class="worklog-detail-item"><span class="worklog-detail-description">No worklogs found for this date and assignee.</span></li>';
            
            const totalTime = worklogDetails.reduce((sum, detail) => sum + detail.timeSpent, 0);
            const totalFormatted = formatTimeHoursMinutes(totalTime);
            
            return `
                <div class="dash-card worklog-detail-widget">
                    <h3>Worklog Details</h3>
                    <div class="worklog-input-container">
                        <div class="worklog-input-group">
                            <label class="date-picker-label" for="worklogDetailDatePicker">Date:</label>
                            <input type="date" id="worklogDetailDatePicker" class="date-picker-input" value="${selectedDate}" onchange="updateWorklogDetailDate(this.value)">
                        </div>
                        <div class="worklog-input-group">
                            <label class="date-picker-label" for="worklogDetailAssigneePicker">Assignee:</label>
                            <select id="worklogDetailAssigneePicker" class="worklog-select" onchange="updateWorklogDetailAssignee(this.value)">
                                ${assigneeOptions}
                            </select>
                        </div>
                    </div>
                    <div class="dash-section">
                        <div class="dash-section-title">
                            <span>Total Time</span>
                            <span class="section-count">${totalFormatted}</span>
                        </div>
                    </div>
                    <ul class="worklog-detail-list">
                        ${worklogDetailList}
                    </ul>
                </div>
            `;
        }

        function updateDashboardButton() {
            const btn = document.getElementById('dashboardBtn');
            if (!btn) return;
            btn.textContent = viewMode === 'dashboard' ? 'AC View' : 'Dashboard';
        }

        async function copyFRStatusWidget(event) {
            const widget = document.getElementById('frStatusWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#frStatusWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        
                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'fr-status-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        async function copyACStatusWidget(event) {
            const widget = document.getElementById('acStatusWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#acStatusWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        
                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ac-status-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        async function copyAssigneeTimeTrackingWidget(event) {
            const widget = document.getElementById('assigneeTimeTrackingWidget');
            if (!widget) {
                alert('Widget not found');
                return;
            }

            const button = event ? (event.target.closest('.snapshot-icon') || event.target) : document.querySelector('#assigneeTimeTrackingWidget .snapshot-icon');
            const svg = button ? button.querySelector('svg') : null;
            const originalSvg = svg ? svg.outerHTML : null;

            try {
                // Capture the widget as canvas
                const canvas = await html2canvas(widget, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false
                });

                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert('Failed to create image');
                        return;
                    }

                    try {
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        
                        // Visual feedback - show checkmark
                        if (svg) {
                            svg.outerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: #2e7d32;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>';
                            setTimeout(() => {
                                if (originalSvg) {
                                    svg.outerHTML = originalSvg;
                                }
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        // Fallback: download the image
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'assignee-time-tracking-widget.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image copied! If clipboard didn\'t work, the image was downloaded instead.');
                    }
                }, 'image/png');
            } catch (err) {
                console.error('Failed to capture widget:', err);
                alert('Failed to capture widget as image');
            }
        }

        function toggleFRView() {
            viewMode = 'fr';
            renderTickets(lastTickets);
        }

        function toggleView(newMode) {
            viewMode = newMode;
            renderTickets(lastTickets);
        }

        // Helper function to escape CSV values
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            // If value contains comma, newline, or double quote, wrap in quotes and escape quotes
            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        }

        // Generic function to get cell value based on column and data item
        function getCellValue(col, item, idx, viewType) {
            let value = '';
            if (col.id === 'serial') {
                value = idx + 1;
            } else if (viewType === 'fr') {
                // FR view specific columns
                if (col.id === 'frId') {
                    value = item.frId || 'N/A';
                } else if (col.id === 'totalTickets') {
                    value = item.totalTickets || 0;
                } else if (col.id === 'doneTickets') {
                    value = item.doneTickets || 0;
                } else if (col.id === 'pendingTickets') {
                    value = item.pendingTickets || 0;
                } else if (col.id === 'frStatus') {
                    value = item.frStatus || 'N/A';
                }
            } else {
                // AC/Table view columns
                if (col.id === 'key') {
                    value = item.key || 'N/A';
                } else if (col.id === 'summary') {
                    value = item.summary || item.title || 'No title';
                } else if (col.id === 'status') {
                    value = item.status || 'Unknown';
                } else if (col.id === 'assignee') {
                    value = item.assignee || '';
                } else if (col.id === 'priority') {
                    value = item.priority || '';
                } else if (col.id === 'storyPoints') {
                    value = typeof item.storyPoints === 'number' ? item.storyPoints : '';
                } else if (col.id === 'timeOriginalEstimate') {
                    value = formatTimeFromSeconds(item.timeOriginalEstimate || 0);
                } else if (col.id === 'actualHours') {
                    value = formatTimeFromSeconds(item.actualHours || 0);
                } else if (col.id === 'timeDifference') {
                    const estimateSeconds = typeof item.timeOriginalEstimate === 'number' ? item.timeOriginalEstimate : 0;
                    const actualSeconds = typeof item.actualHours === 'number' ? item.actualHours : 0;
                    const diffSeconds = actualSeconds - estimateSeconds;
                    if (diffSeconds === 0) {
                        value = '';
                    } else {
                        const absDiff = Math.abs(diffSeconds);
                        const formatted = formatTimeFromSeconds(absDiff);
                        value = (diffSeconds > 0 ? '+' : '-') + formatted;
                    }
                } else if (col.id === 'created') {
                    value = item.created ? formatDate(item.created) : '';
                } else if (col.id === 'updated') {
                    value = item.updated ? formatDate(item.updated) : '';
                } else if (col.id === 'qaFailedCount') {
                    value = typeof item.qaFailedCount === 'number' ? item.qaFailedCount : '';
                } else if (col.id === 'totalBugs') {
                    value = typeof item.totalBugs === 'number' ? item.totalBugs : '';
                } else if (col.id === 'openBugs') {
                    value = typeof item.openBugs === 'number' ? item.openBugs : '';
                }
            }
            return value;
        }

        // Helper function to generate filter action buttons based on current view
        function getFilterActionsButtons(columnChooser = '') {
            let buttons = [];
            
            // Export button (available in table and FR views)
            if (viewMode === 'table' || viewMode === 'fr') {
                buttons.push(`<button class="clear-btn" type="button" onclick="exportToCSV()" title="Export to CSV">Export</button>`);
            }
            
            // Column chooser (available in table and FR views)
            if (columnChooser && (viewMode === 'table' || viewMode === 'fr')) {
                buttons.push(columnChooser);
            }
            
            // View toggle buttons based on current view
            if (viewMode === 'dashboard') {
                buttons.push(`<button class="clear-btn" type="button" onclick="toggleView('table')">AC View</button>`);
                buttons.push(`<button class="clear-btn" type="button" onclick="toggleView('fr')">FR View</button>`);
            } else if (viewMode === 'fr') {
                buttons.push(`<button class="clear-btn" type="button" onclick="toggleView('dashboard')">Dashboard</button>`);
                buttons.push(`<button class="clear-btn" type="button" onclick="toggleView('table')">AC View</button>`);
                buttons.push(`<button class="clear-btn" type="button" onclick="clearFRFilters()">Clear filters</button>`);
            } else if (viewMode === 'table') {
                buttons.push(`<button class="clear-btn" type="button" id="dashboardBtn" onclick="toggleDashboard()">Dashboard</button>`);
                buttons.push(`<button class="clear-btn" type="button" onclick="toggleView('fr')">FR View</button>`);
                buttons.push(`<button class="clear-btn" type="button" onclick="clearFilters()">Clear filters</button>`);
            }
            
            return buttons.join('\n                        ');
        }

        // Unified export function for all views
        function exportToCSV() {
            let data = [];
            let visibleColumns = [];
            let viewType = '';
            let filenamePrefix = '';

            // Determine view type and prepare data
            if (viewMode === 'fr') {
                const frData = aggregateFRData(lastTickets);
                data = applyFRFiltersAndSort(frData);
                visibleColumns = frColumns.filter(c => frColumnVisibility[c.id]);
                viewType = 'fr';
                filenamePrefix = 'fr-view';
            } else {
                // AC/Table view
                data = applyFiltersAndSort(lastTickets);
                visibleColumns = columns.filter(c => columnVisibility[c.id]);
                viewType = 'table';
                filenamePrefix = 'ac-view';
            }

            // Build CSV header
            const headers = visibleColumns.map(col => escapeCSV(col.label));
            const csvRows = [headers.join(',')];

            // Build CSV rows
            data.forEach((item, idx) => {
                const row = [];
                visibleColumns.forEach(col => {
                    const value = getCellValue(col, item, idx, viewType);
                    row.push(escapeCSV(value));
                });
                csvRows.push(row.join(','));
            });

            // Create and download CSV
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filenamePrefix}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // FR View columns
        const frColumns = [
            { id: 'serial', label: '#', sortable: null, className: 'serial-col' },
            { id: 'frId', label: 'FR ID', sortable: 'frId' },
            { id: 'totalTickets', label: 'Total Tickets', sortable: 'totalTickets' },
            { id: 'doneTickets', label: 'Done Tickets', sortable: 'doneTickets' },
            { id: 'pendingTickets', label: 'Pending Tickets', sortable: 'pendingTickets' },
            { id: 'frStatus', label: 'Status', sortable: 'frStatus' },
        ];

        const frColumnVisibility = {
            serial: true,
            frId: true,
            totalTickets: true,
            doneTickets: true,
            pendingTickets: true,
            frStatus: true
        };

        const frFilters = {
            frId: '',
            totalTickets: '',
            doneTickets: '',
            pendingTickets: '',
            frStatusValues: []
        };

        function getDefaultFRFilters() {
            return {
                frId: '',
                totalTickets: '',
                doneTickets: '',
                pendingTickets: '',
                frStatusValues: []
            };
        }

        // Aggregate FR data from tickets
        function aggregateFRData(tickets) {
            const frMap = {};
            
            tickets.forEach(ticket => {
                if (!ticket.frId) return;
                
                if (!frMap[ticket.frId]) {
                    frMap[ticket.frId] = {
                        frId: ticket.frId,
                        totalTickets: 0,
                        doneTickets: 0,
                        pendingTickets: 0,
                        frStatus: ''
                    };
                }
                
                frMap[ticket.frId].totalTickets++;
                
                if (ticket.statusCategory === 'Done') {
                    frMap[ticket.frId].doneTickets++;
                }
            });
            
            // Calculate pending and status for each FR
            Object.values(frMap).forEach(fr => {
                fr.pendingTickets = fr.totalTickets - fr.doneTickets;
                
                if (fr.doneTickets === 0) {
                    fr.frStatus = 'Pending';
                } else if (fr.doneTickets === fr.totalTickets) {
                    fr.frStatus = 'Done';
                } else {
                    fr.frStatus = 'Partially Done';
                }
            });
            
            return Object.values(frMap);
        }

        function applyFRFiltersAndSort(frData) {
            const filtered = frData.filter(fr => {
                const frId = (fr.frId || '').toLowerCase().includes(frFilters.frId.toLowerCase());
                const totalTickets = String(fr.totalTickets || 0).toLowerCase().includes(frFilters.totalTickets.toLowerCase());
                const doneTickets = String(fr.doneTickets || 0).toLowerCase().includes(frFilters.doneTickets.toLowerCase());
                const pendingTickets = String(fr.pendingTickets || 0).toLowerCase().includes(frFilters.pendingTickets.toLowerCase());
                
                const statusValue = (fr.frStatus || '').toLowerCase();
                const status = frFilters.frStatusValues.length === 0 || frFilters.frStatusValues.includes(statusValue);
                
                return frId && totalTickets && doneTickets && pendingTickets && status;
            });

            if (!sortField) return filtered;

            const dir = sortDir === 'asc' ? 1 : -1;
            return filtered.slice().sort((a, b) => {
                // Handle numeric fields
                if (sortField === 'totalTickets' || sortField === 'doneTickets' || sortField === 'pendingTickets') {
                    const va = typeof a[sortField] === 'number' ? a[sortField] : 0;
                    const vb = typeof b[sortField] === 'number' ? b[sortField] : 0;
                    return (va - vb) * dir;
                }
                // Handle string fields
                const va = (a[sortField] ?? '').toString().toLowerCase();
                const vb = (b[sortField] ?? '').toString().toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
        }

        function setFRFilter(field, value, evt) {
            if (evt) evt.stopPropagation();
            frFilters[field] = value.toLowerCase();
            if (viewMode === 'fr') {
                updateFRTableBody(lastTickets);
            }
        }

        function toggleFRMultiOption(field, value, checked, evt) {
            if (evt) evt.stopPropagation();
            const key = `${field}Values`;
            const arr = frFilters[key] || [];
            const norm = value.toLowerCase();
            const exists = arr.includes(norm);
            if (checked && !exists) {
                arr.push(norm);
                frFilters[key] = arr;
            } else if (!checked && exists) {
                frFilters[key] = arr.filter(v => v !== norm);
            }
            if (viewMode === 'fr') {
                updateFRTableBody(lastTickets);
            }
            
            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${frDropdownLabel(field)} <span class="caret">▾</span>`;
            }
        }

        function clearFRMultiFilter(field, evt) {
            if (evt) evt.stopPropagation();
            frFilters[`${field}Values`] = [];
            if (viewMode === 'fr') {
                updateFRTableBody(lastTickets);
            }
            
            // Update the dropdown button label
            const dropdownBtn = document.getElementById(`dropdown-btn-${field}`);
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${frDropdownLabel(field)} <span class="caret">▾</span>`;
            }
            
            // Uncheck all checkboxes in the dropdown
            const dropdown = document.getElementById(`dropdown-${field}`);
            if (dropdown) {
                const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        }

        function frDropdownLabel(field) {
            const arr = frFilters[`${field}Values`] || [];
            if (arr.length === 0) return 'All';
            if (arr.length === 1) return arr[0];
            return `${arr.length} selected`;
        }

        function frColumnsDropdownLabel() {
            const visibleCount = Object.values(frColumnVisibility).filter(Boolean).length;
            const total = frColumns.length;
            return visibleCount === total ? 'Columns (All)' : `Columns (${visibleCount}/${total})`;
        }

        function updateFRTableHeaderAndBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderFRView(tickets);
                return;
            }
            
            // Save dropdown state
            const wasOpen = openDropdown === 'frColumns';
            const dropdown = document.getElementById('dropdown-frColumns');
            
            const visibleColumns = frColumns.filter(c => frColumnVisibility[c.id]);
            
            // Update header row
            const thead = table.querySelector('thead');
            if (thead) {
                const headerRow = thead.querySelector('tr:first-child');
                if (headerRow) {
                    const headerCells = visibleColumns.map(col => {
                        const sortableAttrs = col.sortable
                            ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setFRSort('${col.id}')"`
                            : `${col.className ? `class="${col.className}"` : ''}`;
                        const indicator = col.sortable ? `<span class="sort-indicator">${frSortIndicator(col.id)}</span>` : '';
                        return `
                            <th ${sortableAttrs}>
                                ${col.label} ${indicator}
                            </th>
                        `;
                    }).join('');
                    headerRow.innerHTML = headerCells;
                }
                
                // Update filter row
                const filterRow = thead.querySelector('tr:last-child');
                if (filterRow) {
                    const statusOptions = ['Done', 'Pending', 'Partially Done'];
                    
                    const optionHtml = (opts, selected, field) => opts.map(opt => {
                        const isSel = selected.includes(opt.toLowerCase());
                        const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        return `
                            <label>
                                <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleFRMultiOption('${field}', '${safe}', this.checked, event)">
                                ${safe}
                            </label>
                        `;
                    }).join('');
                    
                    const filterCells = visibleColumns.map(col => {
                        if (col.id === 'serial') {
                            return `<th class="serial-col">#</th>`;
                        }
                        if (col.id === 'frId') {
                            return `<th><input type="text" placeholder="Search FR ID" oninput="setFRFilter('frId', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.frId || ''}"></th>`;
                        }
                        if (col.id === 'totalTickets') {
                            return `<th><input type="text" placeholder="Search total" oninput="setFRFilter('totalTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.totalTickets || ''}"></th>`;
                        }
                        if (col.id === 'doneTickets') {
                            return `<th><input type="text" placeholder="Search done" oninput="setFRFilter('doneTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.doneTickets || ''}"></th>`;
                        }
                        if (col.id === 'pendingTickets') {
                            return `<th><input type="text" placeholder="Search pending" oninput="setFRFilter('pendingTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.pendingTickets || ''}"></th>`;
                        }
                        if (col.id === 'frStatus') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-frStatus" type="button" onclick="toggleDropdown('frStatus', event)">
                                            ${frDropdownLabel('frStatus')} <span class="caret">▾</span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-frStatus">
                                            ${optionHtml(statusOptions, frFilters.frStatusValues, 'frStatus')}
                                            <button class="dd-clear" type="button" onclick="clearFRMultiFilter('frStatus', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        return '<th></th>';
                    }).join('');
                    filterRow.innerHTML = filterCells;
                }
            }
            
            // Update body
            updateFRTableBody(tickets);
            
            // Update column chooser button label
            const dropdownBtn = document.getElementById('dropdown-btn-frColumns');
            if (dropdownBtn) {
                dropdownBtn.innerHTML = `${frColumnsDropdownLabel()} <span class="caret">▾</span>`;
            }
            
            // Restore dropdown state
            if (wasOpen && dropdown) {
                dropdown.classList.add('open');
                openDropdown = 'frColumns';
            }
        }

        function toggleFRColumnVisibility(colId, checked, evt) {
            if (evt) evt.stopPropagation();
            frColumnVisibility[colId] = checked;
            if (viewMode === 'fr') {
                updateFRTableHeaderAndBody(lastTickets);
            }
        }

        function resetFRColumns(evt) {
            if (evt) evt.stopPropagation();
            Object.keys(frColumnVisibility).forEach(k => frColumnVisibility[k] = true);
            if (viewMode === 'fr') {
                updateFRTableHeaderAndBody(lastTickets);
            }
        }

        function setFRSort(field) {
            if (sortField === field) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDir = 'asc';
            }
            if (viewMode === 'fr') {
                renderFRView(lastTickets);
            }
        }

        function frSortIndicator(field) {
            if (sortField !== field) return '⇅';
            return sortDir === 'asc' ? '▲' : '▼';
        }

        function clearFRFilters() {
            Object.assign(frFilters, getDefaultFRFilters());
            if (viewMode === 'fr') {
                renderFRView(lastTickets);
            }
        }

        function clearFilters() {
            Object.assign(filters, getDefaultFilters());
            renderTickets(lastTickets);
        }

        function getUniqueValues(tickets, field) {
            const set = new Set();
            (tickets || []).forEach(t => {
                const val = (t[field] || '').trim();
                if (val) set.add(val);
            });
            return Array.from(set).sort((a, b) => a.localeCompare(b));
        }

        function applyFiltersAndSort(tickets) {
            const filtered = tickets.filter(t => {
                const key = (t.key || '').toLowerCase().includes(filters.key);
                const summary = (t.summary || t.title || '').toLowerCase().includes(filters.summary);

                const statusValue = (t.status || '').toLowerCase();
                const status = filters.statusValues.length === 0 || filters.statusValues.includes(statusValue);

                const assigneeValue = (t.assignee || '').toLowerCase();
                const assignee = filters.assigneeValues.length === 0 || filters.assigneeValues.includes(assigneeValue);

                const priorityValue = (t.priority || '').toLowerCase();
                const priority = filters.priorityValues.length === 0 || filters.priorityValues.includes(priorityValue);

                const storyPoints = String(typeof t.storyPoints === 'number' ? t.storyPoints : '').toLowerCase().includes(filters.storyPoints);
                const timeEstimate = formatTimeFromSeconds(t.timeOriginalEstimate || 0).toLowerCase().includes(filters.timeOriginalEstimate);
                const actualHrs = formatTimeFromSeconds(t.actualHours || 0).toLowerCase().includes(filters.actualHours);
                // For timeDifference, calculate the difference and format for filtering (without HTML)
                const estimateSeconds = typeof t.timeOriginalEstimate === 'number' ? t.timeOriginalEstimate : 0;
                const actualSeconds = typeof t.actualHours === 'number' ? t.actualHours : 0;
                const diffSeconds = actualSeconds - estimateSeconds;
                const timeDiffFormatted = diffSeconds !== 0 ? (diffSeconds > 0 ? '+' : '-') + formatTimeFromSeconds(Math.abs(diffSeconds)) : '';
                const timeDiff = timeDiffFormatted.toLowerCase().includes(filters.timeDifference);
                const created = (t.created || '').toLowerCase().includes(filters.created);
                const updated = (t.updated || '').toLowerCase().includes(filters.updated);
                const qaFailed = String(typeof t.qaFailedCount === 'number' ? t.qaFailedCount : '').toLowerCase().includes(filters.qaFailedCount);
                const totalBugs = String(typeof t.totalBugs === 'number' ? t.totalBugs : '').toLowerCase().includes(filters.totalBugs);
                const openBugs = String(typeof t.openBugs === 'number' ? t.openBugs : '').toLowerCase().includes(filters.openBugs);
                return key && summary && status && assignee && priority && storyPoints && timeEstimate && actualHrs && timeDiff && created && updated && qaFailed && totalBugs && openBugs;
            });

            if (!sortField) return filtered;

            const dir = sortDir === 'asc' ? 1 : -1;
            return filtered.slice().sort((a, b) => {
                // Handle numeric fields (storyPoints, qaFailedCount, timeOriginalEstimate, actualHours, timeDifference, totalBugs, openBugs)
                if (sortField === 'storyPoints' || sortField === 'qaFailedCount' || sortField === 'timeOriginalEstimate' || sortField === 'actualHours' || sortField === 'timeDifference' || sortField === 'totalBugs' || sortField === 'openBugs') {
                    let va, vb;
                    if (sortField === 'timeDifference') {
                        // Calculate difference for sorting
                        va = (typeof a.actualHours === 'number' ? a.actualHours : 0) - (typeof a.timeOriginalEstimate === 'number' ? a.timeOriginalEstimate : 0);
                        vb = (typeof b.actualHours === 'number' ? b.actualHours : 0) - (typeof b.timeOriginalEstimate === 'number' ? b.timeOriginalEstimate : 0);
                    } else {
                        va = typeof a[sortField] === 'number' ? a[sortField] : 0;
                        vb = typeof b[sortField] === 'number' ? b[sortField] : 0;
                    }
                    return (va - vb) * dir;
                }
                // Handle string fields
                const va = (a[sortField] ?? '').toString().toLowerCase();
                const vb = (b[sortField] ?? '').toString().toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
        }

        function updateTableBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderTickets(tickets);
                return;
            }
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const visible = applyFiltersAndSort(tickets || []);
            tbody.innerHTML = visible.map((ticket, idx) => {
                const cells = [];
                if (columnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                if (columnVisibility.key) cells.push(`<td>${ticket.key || 'N/A'}</td>`);
                if (columnVisibility.summary) cells.push(`<td>${ticket.summary || ticket.title || 'No title'}</td>`);
                if (columnVisibility.status) cells.push(`<td><span class="ticket-status">${ticket.status || 'Unknown'}</span></td>`);
                if (columnVisibility.assignee) cells.push(`<td>${ticket.assignee || ''}</td>`);
                if (columnVisibility.priority) cells.push(`<td>${ticket.priority || ''}</td>`);
                if (columnVisibility.storyPoints) cells.push(`<td>${typeof ticket.storyPoints === 'number' ? ticket.storyPoints : ''}</td>`);
                if (columnVisibility.timeOriginalEstimate) cells.push(`<td>${formatTimeFromSeconds(ticket.timeOriginalEstimate || 0)}</td>`);
                if (columnVisibility.actualHours) cells.push(`<td>${formatTimeFromSeconds(ticket.actualHours || 0)}</td>`);
                if (columnVisibility.timeDifference) cells.push(`<td>${formatTimeDifference(ticket.timeOriginalEstimate, ticket.actualHours)}</td>`);
                if (columnVisibility.created) cells.push(`<td>${ticket.created ? formatDate(ticket.created) : ''}</td>`);
                if (columnVisibility.updated) cells.push(`<td>${ticket.updated ? formatDate(ticket.updated) : ''}</td>`);
                if (columnVisibility.qaFailedCount) cells.push(`<td>${typeof ticket.qaFailedCount === 'number' ? ticket.qaFailedCount : ''}</td>`);
                if (columnVisibility.totalBugs) cells.push(`<td>${typeof ticket.totalBugs === 'number' ? ticket.totalBugs : ''}</td>`);
                if (columnVisibility.openBugs) cells.push(`<td>${typeof ticket.openBugs === 'number' ? ticket.openBugs : ''}</td>`);
                return `<tr onclick="window.open('${ticket.url || '#'}', '_blank')" style="cursor:pointer;">${cells.join('')}</tr>`;
            }).join('');
        }

        function updateFRTableBody(tickets) {
            const container = document.getElementById('ticketsContainer');
            const table = container.querySelector('.tickets-table');
            if (!table) {
                renderFRView(tickets);
                return;
            }
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const frData = aggregateFRData(tickets || []);
            const filteredAndSorted = applyFRFiltersAndSort(frData);
            
            tbody.innerHTML = filteredAndSorted.map((fr, idx) => {
                const cells = [];
                if (frColumnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                if (frColumnVisibility.frId) cells.push(`<td>${fr.frId || 'N/A'}</td>`);
                if (frColumnVisibility.totalTickets) cells.push(`<td>${fr.totalTickets || 0}</td>`);
                if (frColumnVisibility.doneTickets) cells.push(`<td>${fr.doneTickets || 0}</td>`);
                if (frColumnVisibility.pendingTickets) cells.push(`<td>${fr.pendingTickets || 0}</td>`);
                if (frColumnVisibility.frStatus) cells.push(`<td>${fr.frStatus || 'N/A'}</td>`);
                // Construct Jira URL with FR ID - only make clickable if FR ID exists
                const frId = fr.frId || '';
                let rowAttrs = '';
                if (frId && frId !== 'N/A') {
                    const jqlQuery = `cf[10049] = "${frId}"`;
                    const encodedJql = encodeURIComponent(jqlQuery);
                    const jiraUrl = `https://cardyai-hawaii.atlassian.net/issues/?jql=${encodedJql}`;
                    rowAttrs = `onclick="window.open('${jiraUrl}', '_blank')" style="cursor:pointer;"`;
                }
                return `<tr ${rowAttrs}>${cells.join('')}</tr>`;
            }).join('');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function hideError() {
            const errorDiv = document.getElementById('error');
            errorDiv.classList.remove('active');
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('done') || statusLower.includes('closed') || statusLower.includes('resolved')) {
                return 'status-done';
            } else if (statusLower.includes('progress')) {
                return 'status-in-progress';
            } else if (statusLower.includes('todo') || statusLower.includes('open') || statusLower.includes('backlog')) {
                return 'status-todo';
            }
            return 'status-default';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatTimeFromSeconds(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '';
            if (seconds === 0) return '0h';
            
            // Custom conversions: 60m = 1h, 8h = 1d, 5d = 1w
            const SECONDS_PER_MINUTE = 60;
            const SECONDS_PER_HOUR = 60 * SECONDS_PER_MINUTE; // 3600
            const SECONDS_PER_DAY = 8 * SECONDS_PER_HOUR; // 28800 (8 hours = 1 day)
            const SECONDS_PER_WEEK = 5 * SECONDS_PER_DAY; // 144000 (5 days = 1 week)
            
            const weeks = Math.floor(seconds / SECONDS_PER_WEEK);
            const days = Math.floor((seconds % SECONDS_PER_WEEK) / SECONDS_PER_DAY);
            const hours = Math.floor((seconds % SECONDS_PER_DAY) / SECONDS_PER_HOUR);
            const minutes = Math.floor((seconds % SECONDS_PER_HOUR) / SECONDS_PER_MINUTE);
            
            const parts = [];
            if (weeks > 0) parts.push(`${weeks}w`);
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.length > 0 ? parts.join(' ') : '0h';
        }

        function formatTimeHoursMinutes(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds)) return '';
            if (seconds === 0) return '0h';
            
            // Standard conversions: 60m = 1h (no days or weeks)
            const SECONDS_PER_MINUTE = 60;
            const SECONDS_PER_HOUR = 60 * SECONDS_PER_MINUTE; // 3600
            
            const hours = Math.floor(seconds / SECONDS_PER_HOUR);
            const minutes = Math.floor((seconds % SECONDS_PER_HOUR) / SECONDS_PER_MINUTE);
            
            const parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.length > 0 ? parts.join(' ') : '0h';
        }

        function formatTimeDifference(estimate, actual) {
            if (estimate === null || estimate === undefined || actual === null || actual === undefined) {
                return '';
            }
            
            const estimateSeconds = typeof estimate === 'number' ? estimate : 0;
            const actualSeconds = typeof actual === 'number' ? actual : 0;
            const difference = actualSeconds - estimateSeconds;
            
            if (difference === 0) {
                return '';
            }
            
            const absDifference = Math.abs(difference);
            const formatted = formatTimeFromSeconds(absDifference);
            
            if (difference > 0) {
                return `<span class="time-diff-positive">+${formatted}</span>`;
            } else {
                return `<span class="time-diff-negative">-${formatted}</span>`;
            }
        }

        function getStatusCategory(status) {
            const statusLower = status.toLowerCase().trim();
            const devStatuses = ['dev in progress', 'qa failed', 'ready for dev', 'dev complete', 'bug fixes - dev'];
            const qaStatuses = ['ready to review', 'qa in progress', 'review failed'];
            const baStatuses = ['review completed', 'qa complete', 'ba review'];
            const doneStatuses = ['done'];

            if (devStatuses.some(s => statusLower === s)) {
                return 'Dev';
            }
            if (qaStatuses.some(s => statusLower === s)) {
                return 'QA';
            }
            if (baStatuses.some(s => statusLower === s)) {
                return 'BA';
            }
            if (doneStatuses.some(s => statusLower === s)) {
                return 'Done';
            }
            return 'Other';
        }

        function getWorklogsByDate(tickets, selectedDate) {
            if (!selectedDate) return {};
            
            const assigneeTimeMap = {};
            // selectedDate is in YYYY-MM-DD format
            const selectedDateStr = selectedDate;
            
            tickets.forEach(ticket => {
                if (!ticket.worklog || !ticket.worklog.worklogs) return;
                
                ticket.worklog.worklogs.forEach(worklog => {
                    if (!worklog.started || !worklog.timeSpentSeconds || !worklog.author) return;
                    
                    // Parse the started date - format: "2025-12-11T14:00:00.000+0530"
                    // Extract just the date part (YYYY-MM-DD) from the ISO string
                    const worklogDateStr = worklog.started.split('T')[0];
                    
                    // Check if worklog is for the selected date
                    if (worklogDateStr === selectedDateStr) {
                        const assigneeName = worklog.author.displayName || 'Unknown';
                        const timeSpent = worklog.timeSpentSeconds || 0;
                        
                        if (!assigneeTimeMap[assigneeName]) {
                            assigneeTimeMap[assigneeName] = 0;
                        }
                        assigneeTimeMap[assigneeName] += timeSpent;
                    }
                });
            });
            
            return assigneeTimeMap;
        }

        function extractTextFromComment(comment) {
            if (!comment || !comment.content) return '';
            
            let text = '';
            
            function extractFromContent(content) {
                if (Array.isArray(content)) {
                    content.forEach(item => {
                        if (item.type === 'text' && item.text) {
                            text += item.text + ' ';
                        } else if (item.content) {
                            extractFromContent(item.content);
                        }
                    });
                }
            }
            
            extractFromContent(comment.content);
            return text.trim();
        }

        function getWorklogDetailsByDateAndAssignee(tickets, selectedDate, selectedAssignee) {
            if (!selectedDate || !selectedAssignee) return [];
            
            const worklogDetails = [];
            const selectedDateStr = selectedDate;
            
            tickets.forEach(ticket => {
                if (!ticket.worklog || !ticket.worklog.worklogs) return;
                
                ticket.worklog.worklogs.forEach(worklog => {
                    if (!worklog.started || !worklog.timeSpentSeconds || !worklog.author) return;
                    
                    const worklogDateStr = worklog.started.split('T')[0];
                    const assigneeName = worklog.author.displayName || 'Unknown';
                    
                    // Check if worklog matches selected date and assignee
                    if (worklogDateStr === selectedDateStr && assigneeName === selectedAssignee) {
                        const description = extractTextFromComment(worklog.comment) || 'No description';
                        worklogDetails.push({
                            timeSpent: worklog.timeSpentSeconds,
                            timeSpentFormatted: worklog.timeSpent || formatTimeHoursMinutes(worklog.timeSpentSeconds),
                            description: description,
                            ticketKey: ticket.key,
                            ticketUrl: ticket.url,
                            started: worklog.started
                        });
                    }
                });
            });
            
            // Sort by started time (most recent first)
            worklogDetails.sort((a, b) => new Date(b.started) - new Date(a.started));
            
            return worklogDetails;
        }

        function renderDashboard(tickets) {
            const container = document.getElementById('ticketsContainer');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            const statusCounts = {};
            const assigneeCounts = {};
            const totalTickets = tickets.length;
            tickets.forEach(t => {
                const status = (t.status || 'Unknown').trim();
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                const assignee = (t.assignee || 'Unassigned').trim();
                assigneeCounts[assignee] = (assigneeCounts[assignee] || 0) + 1;
            });

            // Group statuses by category
            const statusByCategory = {
                'Dev': [],
                'QA': [],
                'BA': [],
                'Done': [],
                'Other': []
            };

            Object.entries(statusCounts).forEach(([status, count]) => {
                const category = getStatusCategory(status);
                statusByCategory[category].push({ status, count });
            });

            // Sort statuses within each category by count (descending)
            Object.keys(statusByCategory).forEach(category => {
                statusByCategory[category].sort((a, b) => b.count - a.count);
            });

            // Calculate section totals
            const sectionTotals = {};
            Object.keys(statusByCategory).forEach(category => {
                sectionTotals[category] = statusByCategory[category].reduce((sum, { count }) => sum + count, 0);
            });

            // Render status sections
            const sectionOrder = ['Dev', 'QA', 'BA', 'Done', 'Other'];
            const statusSections = sectionOrder.map(category => {
                const statuses = statusByCategory[category];
                if (statuses.length === 0) return '';

                const sectionTotal = sectionTotals[category];
                const sectionPercentage = totalTickets > 0 ? ((sectionTotal / totalTickets) * 100).toFixed(1) : '0.0';

                const statusItems = statuses.map(({ status, count }) => {
                    const percentage = totalTickets > 0 ? ((count / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${status}</span><span>${count} (${percentage}%)</span></li>`;
                }).join('');

                return `
                    <div class="dash-section">
                        <div class="dash-section-title">
                            <span>${category}</span>
                            <span class="section-count">${sectionTotal} (${sectionPercentage}%)</span>
                        </div>
                        <ul class="dash-list">
                            ${statusItems}
                        </ul>
                    </div>
                `;
            }).filter(section => section !== '').join('');

            const assigneeList = Object.entries(assigneeCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([k, v]) => {
                    const percentage = totalTickets > 0 ? ((v / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${k}</span><span>${v} (${percentage}%)</span></li>`;
                })
                .join('');

            // Calculate QA Loop count breakdown
            const qaFailedCounts = {};
            tickets.forEach(t => {
                const count = typeof t.qaFailedCount === 'number' ? t.qaFailedCount : 0;
                qaFailedCounts[count] = (qaFailedCounts[count] || 0) + 1;
            });

            const qaFailedList = Object.entries(qaFailedCounts)
                .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                .map(([count, ticketCount]) => {
                    const percentage = totalTickets > 0 ? ((ticketCount / totalTickets) * 100).toFixed(1) : '0.0';
                    return `<li><span>${count}</span><span>${ticketCount} (${percentage}%)</span></li>`;
                })
                .join('');

            // Get today's date in YYYY-MM-DD format for default date picker (using local date)
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Get worklogs for selected date (default to today)
            // Explicitly check if property exists and is not undefined/null
            const selectedDate = (window.selectedWorklogDate !== undefined && window.selectedWorklogDate !== null)
                ? window.selectedWorklogDate
                : todayStr;
            
            // Initialize window.selectedWorklogDate if not set
            if (window.selectedWorklogDate === undefined || window.selectedWorklogDate === null) {
                window.selectedWorklogDate = todayStr;
            }
            const assigneeTimeMap = getWorklogsByDate(tickets, selectedDate);
            
            // Get all unique assignees from tickets and merge with worklog data
            // This ensures all assignees are shown, even if they have 0 logged hours
            const allAssigneesMap = {};
            tickets.forEach(t => {
                const assignee = (t.assignee || 'Unassigned').trim();
                if (assignee && !allAssigneesMap[assignee]) {
                    allAssigneesMap[assignee] = assigneeTimeMap[assignee] || 0;
                }
            });
            
            // Sort assignees by time spent (descending)
            // 8 hours = 8 * 3600 = 28800 seconds
            const EIGHT_HOURS_IN_SECONDS = 8 * 3600;
            const assigneeTimeList = Object.entries(allAssigneesMap)
                .sort((a, b) => b[1] - a[1])
                .map(([assignee, totalSeconds]) => {
                    const formatted = formatTimeHoursMinutes(totalSeconds);
                    // Apply red color if less than 8 hours
                    const timeClass = totalSeconds < EIGHT_HOURS_IN_SECONDS ? 'time-low-hours' : '';
                    // Escape assignee for use in onclick
                    const safeAssignee = assignee.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `<li class="clickable" onclick="selectAssigneeForWorklogDetails('${safeAssignee}', '${selectedDate}')"><span>${assignee}</span><span class="${timeClass}">${formatted}</span></li>`;
                })
                .join('');
            
            const totalTimeSpent = Object.values(allAssigneesMap).reduce((sum, seconds) => sum + seconds, 0);
            const totalFormatted = formatTimeHoursMinutes(totalTimeSpent);

            // Calculate FR Status counts - dynamically from available FR data
            const frData = aggregateFRData(tickets);
            const frStatusCounts = {};
            frData.forEach(fr => {
                const status = fr.frStatus || 'Pending';
                frStatusCounts[status] = (frStatusCounts[status] || 0) + 1;
            });
            const totalFRs = frData.length;
            // Sort statuses: Done first, then Partially Done, then Pending, then others alphabetically
            const statusOrder = ['Done', 'Partially Done', 'Pending'];
            const sortedStatuses = Object.entries(frStatusCounts).sort((a, b) => {
                const indexA = statusOrder.indexOf(a[0]);
                const indexB = statusOrder.indexOf(b[0]);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a[0].localeCompare(b[0]);
            });
            const frStatusList = sortedStatuses
                .map(([status, count]) => {
                    const percentage = totalFRs > 0 ? ((count / totalFRs) * 100).toFixed(1) : '0.0';
                    return `<li><span>${status}</span><span>${count} (${percentage}%)</span></li>`;
                })
                .join('');

            container.innerHTML = `
                <div class="filter-actions">
                    ${getFilterActionsButtons()}
                </div>
                <div class="dash-grid">
                    <div class="dash-card" id="acStatusWidget">
                        <div class="widget-header">
                            <h3>AC Status</h3>
                            <button class="snapshot-icon" onclick="copyACStatusWidget(event)" title="Copy widget as image">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                        ${statusSections || '<div class="dash-section"><div class="dash-section-title">Other</div><ul class="dash-list"><li><span>None</span><span>0 (0.0%)</span></li></ul></div>'}
                    </div>
                    <div class="dash-card">
                        <h3>Assignee</h3>
                        <ul class="dash-list">
                            ${assigneeList || '<li><span>None</span><span>0 (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card">
                        <h3>QA Loop</h3>
                        <ul class="dash-list">
                            ${qaFailedList || '<li><span>0</span><span>0 tickets (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card" id="frStatusWidget">
                        <div class="widget-header">
                            <h3>FR Status</h3>
                            <button class="snapshot-icon" onclick="copyFRStatusWidget(event)" title="Copy widget as image">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                        <ul class="dash-list">
                            ${frStatusList || '<li><span>No FRs</span><span>0 (0.0%)</span></li>'}
                        </ul>
                    </div>
                    <div class="dash-card time-tracking-widget" id="assigneeTimeTrackingWidget">
                        <div class="widget-header">
                            <h3>Assignee Time Tracking</h3>
                            <button class="snapshot-icon" onclick="copyAssigneeTimeTrackingWidget(event)" title="Copy widget as image">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.5-10.5h-1.5l-1-1h-4l-1 1H9.5l-1 1H5c-1.11 0-2 .89-2 2v10c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="date-picker-container">
                            <label class="date-picker-label" for="worklogDatePicker">Date:</label>
                            <input type="date" id="worklogDatePicker" class="date-picker-input" value="${selectedDate}" onchange="updateWorklogDate(this.value)">
                        </div>
                        <div class="dash-section">
                            <div class="dash-section-title">
                                <span>Total Time</span>
                                <span class="section-count">${totalFormatted}</span>
                            </div>
                        </div>
                        <ul class="dash-list">
                            ${assigneeTimeList || '<li><span>No time logged</span><span>0m</span></li>'}
                        </ul>
                    </div>
                    ${renderWorklogDetailWidget(tickets)}
                </div>
            `;
        }

        function renderFRView(tickets) {
            const container = document.getElementById('ticketsContainer');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            const frData = aggregateFRData(tickets);
            
            if (frData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No FR data found</h2>
                        <p>No tickets have FR IDs assigned</p>
                    </div>
                `;
                return;
            }

            // Get unique status values for filter
            const statusOptions = ['Done', 'Pending', 'Partially Done'];

            const optionHtml = (opts, selected, field) => opts.map(opt => {
                const isSel = selected.includes(opt.toLowerCase());
                const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return `
                    <label>
                        <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleFRMultiOption('${field}', '${safe}', this.checked, event)">
                        ${safe}
                    </label>
                `;
            }).join('');

            const visibleColumns = frColumns.filter(c => frColumnVisibility[c.id]);

            const headerCells = visibleColumns.map(col => {
                const sortableAttrs = col.sortable
                    ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setFRSort('${col.id}')"`
                    : `${col.className ? `class="${col.className}"` : ''}`;
                const indicator = col.sortable ? `<span class="sort-indicator">${frSortIndicator(col.id)}</span>` : '';
                return `
                    <th ${sortableAttrs}>
                        ${col.label} ${indicator}
                    </th>
                `;
            }).join('');

            const filterRow = `
                <tr>
                    ${visibleColumns.map(col => {
                        if (col.id === 'serial') {
                            return `<th class="serial-col">#</th>`;
                        }
                        if (col.id === 'frId') {
                            return `<th><input type="text" placeholder="Search FR ID" oninput="setFRFilter('frId', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.frId || ''}"></th>`;
                        }
                        if (col.id === 'totalTickets') {
                            return `<th><input type="text" placeholder="Search total" oninput="setFRFilter('totalTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.totalTickets || ''}"></th>`;
                        }
                        if (col.id === 'doneTickets') {
                            return `<th><input type="text" placeholder="Search done" oninput="setFRFilter('doneTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.doneTickets || ''}"></th>`;
                        }
                        if (col.id === 'pendingTickets') {
                            return `<th><input type="text" placeholder="Search pending" oninput="setFRFilter('pendingTickets', this.value, event)" onclick="event.stopPropagation();" value="${frFilters.pendingTickets || ''}"></th>`;
                        }
                        if (col.id === 'frStatus') {
                            return `
                                <th>
                                    <div class="multi-dd" onclick="event.stopPropagation();">
                                        <button class="multi-dd-btn" id="dropdown-btn-frStatus" type="button" onclick="toggleDropdown('frStatus', event)">
                                            ${frDropdownLabel('frStatus')} <span class="caret">▾</span>
                                        </button>
                                        <div class="multi-dd-options" id="dropdown-frStatus">
                                            ${optionHtml(statusOptions, frFilters.frStatusValues, 'frStatus')}
                                            <button class="dd-clear" type="button" onclick="clearFRMultiFilter('frStatus', event)">Clear</button>
                                        </div>
                                    </div>
                                </th>
                            `;
                        }
                        return '<th></th>';
                    }).join('')}
                </tr>
            `;

            const columnChooser = `
                <div class="multi-dd" onclick="event.stopPropagation();">
                    <button class="multi-dd-btn" id="dropdown-btn-frColumns" type="button" onclick="toggleDropdown('frColumns', event)">
                        ${frColumnsDropdownLabel()} <span class="caret">▾</span>
                    </button>
                    <div class="multi-dd-options" id="dropdown-frColumns">
                        ${frColumns.map(col => `
                            <label>
                                <input type="checkbox" ${frColumnVisibility[col.id] ? 'checked' : ''} onchange="toggleFRColumnVisibility('${col.id}', this.checked, event)">
                                ${col.label}
                            </label>
                        `).join('')}
                        <button class="dd-clear" type="button" onclick="resetFRColumns(event)">Show all</button>
                    </div>
                </div>
            `;

            const filteredAndSorted = applyFRFiltersAndSort(frData);
            
            container.innerHTML = `
                <div class="filter-actions">
                    ${getFilterActionsButtons(columnChooser)}
                </div>
                <table class="tickets-table">
                    <thead>
                        <tr>
                            ${headerCells}
                        </tr>
                        ${filterRow}
                    </thead>
                    <tbody>
                        ${filteredAndSorted.map((fr, idx) => {
                            const cells = [];
                            if (frColumnVisibility.serial) cells.push(`<td class="serial-col">${idx + 1}</td>`);
                            if (frColumnVisibility.frId) cells.push(`<td>${fr.frId || 'N/A'}</td>`);
                            if (frColumnVisibility.totalTickets) cells.push(`<td>${fr.totalTickets || 0}</td>`);
                            if (frColumnVisibility.doneTickets) cells.push(`<td>${fr.doneTickets || 0}</td>`);
                            if (frColumnVisibility.pendingTickets) cells.push(`<td>${fr.pendingTickets || 0}</td>`);
                            if (frColumnVisibility.frStatus) cells.push(`<td>${fr.frStatus || 'N/A'}</td>`);
                            // Construct Jira URL with FR ID - only make clickable if FR ID exists
                            const frId = fr.frId || '';
                            let rowAttrs = '';
                            if (frId && frId !== 'N/A') {
                                const jqlQuery = `cf[10049] = "${frId}"`;
                                const encodedJql = encodeURIComponent(jqlQuery);
                                const jiraUrl = `https://cardyai-hawaii.atlassian.net/issues/?jql=${encodedJql}`;
                                rowAttrs = `onclick="window.open('${jiraUrl}', '_blank')" style="cursor:pointer;"`;
                            }
                            return `<tr ${rowAttrs}>${cells.join('')}</tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderTickets(tickets) {
            lastTickets = tickets || [];
            const container = document.getElementById('ticketsContainer');
            container.classList.remove('grid-mode');
            
            // Mark that data has been loaded and remove login mode
            if (tickets && tickets.length > 0) {
                hasDataBeenLoaded = true;
                const mainContainer = document.querySelector('.container');
                if (mainContainer) {
                    mainContainer.classList.remove('login-mode');
                    // Hide email and password fields after data is loaded
                    const emailGroup = document.querySelector('.email-group');
                    const passwordGroup = document.querySelector('.password-group');
                    if (emailGroup) emailGroup.style.display = 'none';
                    if (passwordGroup) passwordGroup.style.display = 'none';
                }
            }
            
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets found</h2>
                        <p>No Jira tickets were returned from the API</p>
                    </div>
                `;
                return;
            }

            if (viewMode === 'dashboard') {
                renderDashboard(tickets);
                return;
            }

            if (viewMode === 'fr') {
                renderFRView(tickets);
                return;
            }

            const visibleTickets = applyFiltersAndSort(tickets);

            {
                const statusOptions = getUniqueValues(tickets, 'status');
                const assigneeOptions = getUniqueValues(tickets, 'assignee');
                const priorityOptions = getUniqueValues(tickets, 'priority');

                const optionHtml = (opts, selected, field) => opts.map(opt => {
                    const isSel = selected.includes(opt.toLowerCase());
                    const safe = opt.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    return `
                        <label>
                            <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleMultiOption('${field}', '${safe}', this.checked, event)">
                            ${safe}
                        </label>
                    `;
                }).join('');

                const visibleColumns = columns.filter(c => columnVisibility[c.id]);

                const headerCells = visibleColumns.map(col => {
                    const sortableAttrs = col.sortable
                        ? `class="sortable ${col.className || ''} ${sortField === col.id ? 'sorted' : ''}" onclick="setSort('${col.id}')"`
                        : `${col.className ? `class="${col.className}"` : ''}`;
                    const indicator = col.sortable ? `<span class="sort-indicator">${sortIndicator(col.id)}</span>` : '';
                    return `
                        <th ${sortableAttrs}>
                            ${col.label} ${indicator}
                        </th>
                    `;
                }).join('');

                const filterRow = `
                    <tr>
                        ${visibleColumns.map(col => {
                            if (col.id === 'serial') {
                                return `<th class="serial-col">#</th>`;
                            }
                            if (col.id === 'key') {
                                return `<th><input type="text" placeholder="Search key" oninput="setFilter('key', this.value, event)" onclick="event.stopPropagation();" value="${filters.key || ''}"></th>`;
                            }
                            if (col.id === 'summary') {
                                return `<th><input type="text" placeholder="Search summary" oninput="setFilter('summary', this.value, event)" onclick="event.stopPropagation();" value="${filters.summary || ''}"></th>`;
                            }
                            if (col.id === 'status') {
                                return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-status" type="button" onclick="toggleDropdown('status', event)">
                                                ${dropdownLabel('status')} <span class="caret">▾</span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-status">
                                                ${optionHtml(statusOptions, filters.statusValues, 'status')}
                                                <button class="dd-clear" type="button" onclick="clearMultiFilter('status', event)">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                            }
                            if (col.id === 'assignee') {
                                return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-assignee" type="button" onclick="toggleDropdown('assignee', event)">
                                                ${dropdownLabel('assignee')} <span class="caret">▾</span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-assignee">
                                                ${optionHtml(assigneeOptions, filters.assigneeValues, 'assignee')}
                                                <button class="dd-clear" type="button" onclick="clearMultiFilter('assignee', event)">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                            }
                            if (col.id === 'priority') {
                                return `
                                    <th>
                                        <div class="multi-dd" onclick="event.stopPropagation();">
                                            <button class="multi-dd-btn" id="dropdown-btn-priority" type="button" onclick="toggleDropdown('priority', event)">
                                                ${dropdownLabel('priority')} <span class="caret">▾</span>
                                            </button>
                                            <div class="multi-dd-options" id="dropdown-priority">
                                                ${optionHtml(priorityOptions, filters.priorityValues, 'priority')}
                                                <button class="dd-clear" type="button" onclick="clearMultiFilter('priority', event)">Clear</button>
                                            </div>
                                        </div>
                                    </th>
                                `;
                            }
                            if (col.id === 'storyPoints') {
                                return `<th><input type="text" placeholder="Search story points" oninput="setFilter('storyPoints', this.value, event)" onclick="event.stopPropagation();" value="${filters.storyPoints || ''}"></th>`;
                            }
                            if (col.id === 'timeOriginalEstimate') {
                                return `<th><input type="text" placeholder="Search estimate" oninput="setFilter('timeOriginalEstimate', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeOriginalEstimate || ''}"></th>`;
                            }
                            if (col.id === 'actualHours') {
                                return `<th><input type="text" placeholder="Search time spent" oninput="setFilter('actualHours', this.value, event)" onclick="event.stopPropagation();" value="${filters.actualHours || ''}"></th>`;
                            }
                            if (col.id === 'timeDifference') {
                                return `<th><input type="text" placeholder="Search difference" oninput="setFilter('timeDifference', this.value, event)" onclick="event.stopPropagation();" value="${filters.timeDifference || ''}"></th>`;
                            }
                            if (col.id === 'created') {
                                return `<th><input type="text" placeholder="Search created" oninput="setFilter('created', this.value, event)" onclick="event.stopPropagation();" value="${filters.created || ''}"></th>`;
                            }
                            if (col.id === 'updated') {
                                return `<th><input type="text" placeholder="Search updated" oninput="setFilter('updated', this.value, event)" onclick="event.stopPropagation();" value="${filters.updated || ''}"></th>`;
                            }
                            if (col.id === 'qaFailedCount') {
                                return `<th class="qa-col"><input type="text" placeholder="Search QA loop" oninput="setFilter('qaFailedCount', this.value, event)" onclick="event.stopPropagation();" value="${filters.qaFailedCount || ''}"></th>`;
                            }
                            if (col.id === 'totalBugs') {
                                return `<th class="qa-col"><input type="text" placeholder="Search total bugs" oninput="setFilter('totalBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.totalBugs || ''}"></th>`;
                            }
                            if (col.id === 'openBugs') {
                                return `<th class="qa-col"><input type="text" placeholder="Search open bugs" oninput="setFilter('openBugs', this.value, event)" onclick="event.stopPropagation();" value="${filters.openBugs || ''}"></th>`;
                            }
                            return '<th></th>';
                        }).join('')}
                    </tr>
                `;

                const columnChooser = `
                    <div class="multi-dd" onclick="event.stopPropagation();">
                        <button class="multi-dd-btn" id="dropdown-btn-columns" type="button" onclick="toggleDropdown('columns', event)">
                            ${columnsDropdownLabel()} <span class="caret">▾</span>
                        </button>
                        <div class="multi-dd-options" id="dropdown-columns">
                            ${columns.map(col => `
                                <label>
                                    <input type="checkbox" ${columnVisibility[col.id] ? 'checked' : ''} onchange="toggleColumnVisibility('${col.id}', this.checked, event)">
                                    ${col.label}
                                </label>
                            `).join('')}
                            <button class="dd-clear" type="button" onclick="resetColumns(event)">Show all</button>
                        </div>
                    </div>
                `;

                container.innerHTML = `
                    <div class="filter-actions">
                        ${getFilterActionsButtons(columnChooser)}
                    </div>
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                ${headerCells}
                            </tr>
                            ${filterRow}
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                updateTableBody(tickets);
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card" onclick="window.open('${ticket.url || '#'}', '_blank')">
                    <div class="ticket-header">
                        <span class="ticket-key">${ticket.key || 'N/A'}</span>
                        <span class="ticket-status ${getStatusClass(ticket.status || '')}">
                            ${ticket.status || 'Unknown'}
                        </span>
                    </div>
                    <div class="ticket-title">${ticket.summary || ticket.title || 'No title'}</div>
                    <div class="ticket-meta">
                        ${ticket.assignee ? `<div class="ticket-meta-item">👤 ${ticket.assignee}</div>` : ''}
                        ${ticket.priority ? `<div class="ticket-meta-item">⚡ ${ticket.priority}</div>` : ''}
                        ${ticket.created ? `<div class="ticket-meta-item">📅 Created: ${formatDate(ticket.created)}</div>` : ''}
                        ${ticket.updated ? `<div class="ticket-meta-item">🔄 Updated: ${formatDate(ticket.updated)}</div>` : ''}
                        ${typeof ticket.qaFailedCount === 'number' ? `<div class="ticket-meta-item">❗ QA Loop: ${ticket.qaFailedCount}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function handleSubmit(event) {
            event.preventDefault();
            loadTickets();
        }

        async function loadTickets() {
            const updateBtn = document.getElementById('updateBtn');
            let email = document.getElementById('emailInput').value.trim();
            const apiToken = document.getElementById('tokenInput').value.trim();
            const container = document.getElementById('ticketsContainer');

            if (!email || !apiToken) {
                showError('Please enter your username and password.');
                updateStatus('Missing credentials');
                return;
            }

            // If username doesn't contain "@", append "@cardyai.com"
            if (!email.includes('@')) {
                email = email + '@cardyai.com';
            }

            updateBtn.disabled = true;
            showLoading(true);
            hideError();
            updateStatus('Loading tickets...');

            try {
                // Get the EM ID for the currently selected module
                const currentModule = modules[activeModule];
                if (!currentModule) {
                    throw new Error(`Module "${activeModule}" not found in configuration`);
                }
                const parent = currentModule.emId;
                const formBody = new URLSearchParams({ email, apiToken, parent }).toString();
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formBody
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const tickets = data.tickets || data.issues || data;
                const normalized = Array.isArray(tickets) ? tickets : [tickets];
                
                // Ensure viewMode is set to dashboard after each fetch
                viewMode = 'dashboard';
                
                // Mark that data has been loaded
                if (normalized && normalized.length > 0) {
                    hasDataBeenLoaded = true;
                }
                
                // Remove login mode when data is successfully loaded
                const mainContainer = document.querySelector('.container');
                if (mainContainer && normalized && normalized.length > 0) {
                    mainContainer.classList.remove('login-mode');
                    // Hide email and password fields after data is loaded
                    const emailGroup = document.querySelector('.email-group');
                    const passwordGroup = document.querySelector('.password-group');
                    if (emailGroup) emailGroup.style.display = 'none';
                    if (passwordGroup) passwordGroup.style.display = 'none';
                }
                
                renderTickets(normalized);
                updateStatus(`Loaded ${normalized.length} ticket(s)`);
                
                // Update last fetch time
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
                const dateStr = now.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
                const fetchTimeEl = document.getElementById('lastFetchTime');
                if (fetchTimeEl) {
                    fetchTimeEl.textContent = `${dateStr} ${timeStr}`;
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                showError(`Error loading tickets: ${error.message}`);
                updateStatus('Error loading tickets');
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No tickets loaded</h2>
                        <p>Update failed. Please check your credentials and try again.</p>
                    </div>
                `;
            } finally {
                showLoading(false);
                updateBtn.disabled = false;
            }
        }

        // Do not auto-load; user triggers via Update button
    </script>
</body>
</html>

